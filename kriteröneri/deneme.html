<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEB Kriter AsistanÄ± (AI Destekli)</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --success: #10b981;
            --accent: #7c3aed;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        .brand h1 { margin: 0; font-size: 1.5rem; color: var(--text); }
        .brand p { margin: 0.5rem 0 0; color: var(--secondary); font-size: 0.9rem; }

        /* API Settings */
        .api-toggle-btn {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
            transition: all 0.2s;
        }
        .api-toggle-btn:hover { background: #f1f5f9; color: var(--text); }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
        }
        .status-dot.active { background: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }

        .api-panel {
            display: none;
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            animation: slideDown 0.3s ease;
        }
        .api-panel.show { display: block; }
        .api-input-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .api-input-group input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: monospace;
        }
        
        /* Search Area */
        .search-wrapper {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s;
        }
        .search-wrapper:focus-within { box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1); border-color: var(--primary); }

        textarea {
            width: 100%;
            border: none;
            resize: none;
            font-size: 1.1rem;
            font-family: inherit;
            outline: none;
            min-height: 80px;
            color: var(--text);
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .live-indicator {
            font-size: 0.85rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .live-indicator.visible { opacity: 1; }

        .btn-ai {
            background: linear-gradient(135deg, var(--accent), #6366f1);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-ai:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }
        .btn-ai:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }
        
        .btn-save { background: var(--primary); color: white; border: none; padding: 0 1.5rem; border-radius: 6px; cursor: pointer; }

        /* Results */
        .results-container { margin-top: 2rem; }
        
        .result-badge {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .badge-pill { background: #e0e7ff; color: var(--accent); padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; }
        .badge-pill.local { background: #f1f5f9; color: var(--secondary); }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: transform 0.2s;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .card:hover { border-color: var(--primary); }

        .card-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        
        .code-display {
            background: #eff6ff;
            color: var(--primary);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
            min-width: 80px;
            text-align: center;
            cursor: pointer;
        }
        .code-display:hover { background: #dbeafe; }

        .card-content h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; color: var(--text); }
        .section-tag { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--secondary); margin-bottom: 0.25rem; display: block; }

        .ai-reason {
            background: #fdf4ff;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.95rem;
            color: #581c87;
        }

        .details-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
        }
        .details-title { font-size: 0.8rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.5rem; }
        .details-list ul { margin: 0; padding-left: 1.2rem; color: #475569; font-size: 0.95rem; }
        .details-list li { margin-bottom: 0.5rem; }

        /* Utility */
        .spinner { width: 20px; height: 20px; border: 2px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        .empty-state { text-align: center; padding: 3rem; color: var(--secondary); }
        .empty-icon { font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.5; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .card-header { flex-direction: column; }
            .code-display { width: 100%; text-align: left; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <h1>Kriter AsistanÄ±</h1>
            <p>HÄ±zlÄ± Tespit & AkÄ±llÄ± Ã–neri Sistemi</p>
        </div>
        <button id="apiToggle" class="api-toggle-btn">
            <span id="apiStatusDot" class="status-dot"></span>
            <span id="apiStatusText">API AyarÄ±</span>
        </button>
    </header>

    <div id="apiPanel" class="api-panel">
        <h3>Google Gemini API AyarlarÄ±</h3>
        <p style="font-size: 0.9rem; color: var(--secondary);">AI Ã¶nerilerini kullanmak iÃ§in bir Gemini API anahtarÄ± giriniz. Anahtar sadece tarayÄ±cÄ±nÄ±zda saklanÄ±r.</p>
        <div class="api-input-group">
            <input type="password" id="apiKeyInput" placeholder="API AnahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n (AI Studio'dan alÄ±nmÄ±ÅŸ)">
            <button id="saveApiKey" class="btn-save">Kaydet</button>
        </div>
    </div>

    <main>
        <div class="search-wrapper">
            <textarea id="searchInput" placeholder="HatayÄ± buraya yazÄ±n... (Ã–rn: Cevap anahtarÄ± yanlÄ±ÅŸ, gÃ¶rsel alt yazÄ±sÄ± eksik, e-iÃ§erik aÃ§Ä±lmÄ±yor)"></textarea>
            <div class="action-bar">
                <div id="liveIndicator" class="live-indicator">
                    <span>ğŸ”</span> Kelime bazlÄ± aranÄ±yor...
                </div>
                <button id="aiSearchBtn" class="btn-ai" disabled>
                    <span>âœ¨ YZ ile Ã–neri Getir</span>
                </button>
            </div>
        </div>

        <div id="resultsArea" class="results-container">
            <div class="empty-state">
                <span class="empty-icon">ğŸ“</span>
                <p>Bir inceleme tespiti yazmaya baÅŸlayÄ±n.<br>HÄ±zlÄ± sonuÃ§lar anÄ±nda listelenir, detaylÄ± analiz iÃ§in YZ butonunu kullanÄ±n.</p>
            </div>
        </div>
    </main>
</div>

<script>
    /**
     * VERÄ° HAVUZU (criteria.json iÃ§eriÄŸi buraya gÃ¶mÃ¼ldÃ¼)
     * UygulamanÄ±n tek dosya olarak Ã§alÄ±ÅŸmasÄ± iÃ§in veriyi buraya ekliyoruz.
     */
    const CRITERIA_DATA = [
      {
        "main_code": "1",
        "main_title": "ANAYASA VE DÄ°ÄER MEVZUATA UYGUNLUÄU",
        "code": "1.1.1",
        "section": "1.1 Genel",
        "title": "Ä°Ã§erikte Anayasa, taraf olduÄŸumuz milletlerarasÄ± anlaÅŸmalar, kanunlar ve diÄŸer mevzuata aykÄ±rÄ± bir husus bulunmamalÄ±dÄ±r.",
        "details": [
          "Ä°Ã§erik, Anayasaâ€™da ve MillÃ® EÄŸitim Temel Kanunuâ€™nda aÃ§Ä±kÃ§a hÃ¼kme baÄŸlanmÄ±ÅŸ eÅŸitlik ilkesi gÃ¶zetilerek temel insan hak ve Ã¶zgÃ¼rlÃ¼k lerini destekleyen ve her tÃ¼rlÃ¼ ayrÄ±mcÄ±lÄ±ÄŸÄ± reddeden bir yaklaÅŸÄ±mla hazÄ±rlanmalÄ±dÄ±r.",
          "Ä°Ã§erik; demokratik, laik ve sosyal bir hukuk devleti olan TÃ¼rkiye Cumhuriyetiâ€™ne karÅŸÄ± gÃ¶rev ve sorumluluklarÄ±nÄ± bilen ve bunlarÄ± dav ranÄ±ÅŸ hÃ¢line getirmiÅŸ vatandaÅŸlar yetiÅŸtirme amacÄ±na uygun hazÄ±rlanmalÄ±dÄ±r.",
          "Ä°Ã§erik; 1739 sayÄ±lÄ± MillÃ® EÄŸitim Temel Kanunuâ€™nun 2â€™nci maddesinde ifade edilen TÃ¼rk Milletinin millÃ®, ahlaki, insani, manevi ve kÃ¼ltÃ¼rel deÄŸerlerini benimseyen, koruyan ve geliÅŸtiren bir vatandaÅŸ yetiÅŸtirme anlayÄ±ÅŸÄ±yla tasarlanmalÄ±dÄ±r.",
          "Ä°Ã§erikte yer alan TÃ¼rk bayraÄŸÄ± gÃ¶rseli; TÃ¼rk BayraÄŸÄ± Kanunuâ€™na uygun olarak herhangi bir tartÄ±ÅŸmaya, deÄŸersizleÅŸtirmeye neden ol mayacak ÅŸekilde, sayfa dÃ¼zenine ve gÃ¶rsel tasarÄ±ma uygun olarak Ã§izilmeli ve konumlandÄ±rÄ±lmalÄ±dÄ±r."
        ]
      },
      {
        "main_code": "1",
        "main_title": "ANAYASA VE DÄ°ÄER MEVZUATA UYGUNLUÄU",
        "code": "1.1.2",
        "section": "1.1 Genel",
        "title": "Ders kitabÄ± ve eÄŸitim aracÄ±nda AtatÃ¼rk Portresi, Ä°stiklÃ¢l MarÅŸÄ±, GenÃ§liÄŸe Hitabe, Ã–ÄŸrenci AndÄ±... YÃ¶netmelikâ€™te belirtilen ÅŸekilde kullanÄ±lmalÄ±dÄ±r.",
        "details": [
          "Ä°lkokul 1, 2 ve 3. sÄ±nÄ±flarÄ±na ait ders kitaplarÄ± ve eÄŸitim araÃ§larÄ±nda ikinci yaprak ve devamÄ±nda... Ä°stiklÃ¢l MarÅŸÄ±, Ã–ÄŸrenci AndÄ±, AtatÃ¼rk resmi...",
          "Ä°lkokul 4. sÄ±nÄ±f, ortaokul, ortaÃ¶ÄŸretim... TÃ¼rk bayraÄŸÄ± ile Ä°stiklÃ¢l MarÅŸÄ±; AtatÃ¼rkâ€™Ã¼n GenÃ§liÄŸe Hitabesi; AtatÃ¼rk resmi..."
        ]
      },
      {
        "main_code": "1",
        "main_title": "ANAYASA VE DÄ°ÄER MEVZUATA UYGUNLUÄU",
        "code": "1.2.1",
        "section": "1.2 MillÃ® GÃ¼venlik",
        "title": "Ä°Ã§erikte terÃ¶r Ã¶rgÃ¼tleri ile irtibatlÄ± veya iltisaklÄ± herhangi bir gÃ¶rsel veya yazÄ±lÄ± Ã¶ge, ifade yahut ima bulunmamalÄ±dÄ±r.",
        "details": []
      },
      {
        "main_code": "1",
        "main_title": "ANAYASA VE DÄ°ÄER MEVZUATA UYGUNLUÄU",
        "code": "1.3.1",
        "section": "1.3 EÅŸitlik ve KapsayÄ±cÄ±lÄ±k",
        "title": "Ders kitabÄ± ve eÄŸitim aracÄ± eÅŸitlikÃ§i ve kapsayÄ±cÄ± ÅŸekilde tasarlanmalÄ±, bireylerin hak ve Ã¶zgÃ¼rlÃ¼klerini ihlal edebilecek herhangi bir unsur bulundurmamalÄ±dÄ±r.",
        "details": [
          "Ä°Ã§erikte Ã§oÄŸulculuk ilkesi gÃ¶zetilmelidir.",
          "Ä°Ã§erikte Ä±rk, renk, dil, din, siyasi tercih, etnik kÃ¶ken ayrÄ±mÄ± gÃ¶zetilmeksizin evrensel insan haklarÄ± esas alÄ±nmalÄ±dÄ±r.",
          "Toplumsal eÅŸitlik ilkesi gÃ¶zetilmelidir."
        ]
      },
      {
        "main_code": "2",
        "main_title": "BÄ°LÄ°MSEL YETERLÄ°LÄ°ÄÄ°",
        "code": "2.1.2",
        "section": "2.1 Bilimsellik",
        "title": "Ä°Ã§erikte bilgi hatasÄ± bulunmamalÄ±dÄ±r.",
        "details": [
          "Konu anlatÄ±mÄ±, tanÄ±m, aÃ§Ä±klama, Ã¶rnek, gÃ¶sterim, etkinlik, deney, ÅŸema, grafik, tablo, terim, sembol, kÄ±saltma vb. iÃ§erikler hata iÃ§ermemelidir."
        ]
      },
      {
        "main_code": "2",
        "main_title": "BÄ°LÄ°MSEL YETERLÄ°LÄ°ÄÄ°",
        "code": "2.2.1",
        "section": "2.2 Metin ve GÃ¶rsel Uyumu",
        "title": "Metin ile gÃ¶rsel uyumlu olmalÄ±dÄ±r.",
        "details": [
          "Metin iÃ§eren gÃ¶rsellerdeki bilgiler metin ile Ã§eliÅŸmemelidir.",
          "Metinde atÄ±f yapÄ±lan gÃ¶rsellere eksiksiz bir biÃ§imde yer verilmelidir."
        ]
      },
      {
        "main_code": "2",
        "main_title": "BÄ°LÄ°MSEL YETERLÄ°LÄ°ÄÄ°",
        "code": "2.2.2",
        "section": "2.2 Metin ve GÃ¶rsel Uyumu",
        "title": "AÃ§Ä±klama gerektiren gÃ¶rsele ait alt yazÄ±da hata ve eksiklik bulunmamalÄ±dÄ±r.",
        "details": [
          "GÃ¶rselin aÃ§Ä±klama gerektirip gerektirmediÄŸi gÃ¶z Ã¶nÃ¼nde bulundurulmalÄ±dÄ±r.",
          "AÃ§Ä±klama gerektiren gÃ¶rsele ait alt yazÄ±; gÃ¶rselde anlatÄ±lmak istenen olay, duygu, durum vb. hususlarÄ± yansÄ±tÄ±cÄ± nitelikte olmalÄ±dÄ±r.",
          "GÃ¶rsele eklenen alt yazÄ± ile gÃ¶rsel uyumlu olmalÄ±dÄ±r."
        ]
      },
      {
        "main_code": "2",
        "main_title": "BÄ°LÄ°MSEL YETERLÄ°LÄ°ÄÄ°",
        "code": "2.6.1",
        "section": "2.6 Standart BÃ¶lÃ¼mler",
        "title": "Ders kitabÄ± ve eÄŸitim aracÄ±nda tÃ¼m sayfalar... standart bÃ¶lÃ¼mler (cevap anahtarÄ±, gÃ¶rsel ve genel aÄŸ kaynakÃ§asÄ± vb.) eksiksiz ve sÄ±ralÄ± bir biÃ§imde yer almalÄ±dÄ±r.",
        "details": [
            "Cevap AnahtarÄ±, GÃ¶rsel KaynakÃ§a ve Genel AÄŸ KaynakÃ§asÄ± bÃ¶lÃ¼mleri elektronik ortamda verilmelidir.",
            "Ä°lkokul birinci sÄ±nÄ±fta cevap anahtarÄ± olmayabilir."
        ]
      },
      {
        "main_code": "5",
        "main_title": "Ã–LÃ‡ME VE DEÄERLENDÄ°RME SÃœRECÄ°NÄ°N UYGUNLUÄU",
        "code": "5.1.3",
        "section": "5.1 Temel Ä°lkeler",
        "title": "Cevap anahtarÄ± eksik veya hatalÄ± olmamalÄ±dÄ±r.",
        "details": [
          "Ãœnite/tema/Ã¶ÄŸrenme alanÄ± ve konu sonlarÄ±nda kullanÄ±lan Ã¶lÃ§me ve deÄŸerlendirme etkinliklerindeki aÃ§Ä±k uÃ§lu sorular hariÃ§ tÃ¼m sorularÄ±n cevaplarÄ± hatasÄ±z olarak cevap anahtarÄ±nda yer almalÄ±dÄ±r."
        ]
      },
      {
        "main_code": "6",
        "main_title": "DÄ°L VE ANLATIM YÃ–NÃœNDEN YETERLÄ°LÄ°ÄÄ°",
        "code": "6.2.1",
        "section": "6.2 YazÄ± Dili StandartlarÄ±",
        "title": "Ä°Ã§erikte yazÄ±m yanlÄ±ÅŸÄ± bulunmamalÄ±dÄ±r.",
        "details": [
          "Alana Ã¶zgÃ¼ olmayan ifadelerin yazÄ±mÄ±nda TÃ¼rk Dil Kurumu YazÄ±m KÄ±lavuzu esas alÄ±nmalÄ±dÄ±r."
        ]
      },
      {
        "main_code": "6",
        "main_title": "DÄ°L VE ANLATIM YÃ–NÃœNDEN YETERLÄ°LÄ°ÄÄ°",
        "code": "6.2.2",
        "section": "6.2 YazÄ± Dili StandartlarÄ±",
        "title": "Ä°Ã§erikte noktalama eksikliÄŸi, yanlÄ±ÅŸlÄ±ÄŸÄ± olmamalÄ±; gereksiz noktalama iÅŸareti kullanÄ±lmamalÄ±dÄ±r.",
        "details": []
      },
      {
        "main_code": "8",
        "main_title": "ELEKTRONÄ°K Ä°Ã‡ERÄ°KLERÄ°N KAPSAM VE TASARIMININ UYGUNLUÄU",
        "code": "8.5.1",
        "section": "8.5 Ses ve GÃ¶rÃ¼ntÃ¼ Kalitesi",
        "title": "Ses ile iÃ§erik uyumlu olmalÄ±dÄ±r.",
        "details": [
          "Ses ve gÃ¶rÃ¼ntÃ¼ birbirine eÅŸ zamanlÄ± (senkronize) olmalÄ±dÄ±r.",
          "Ses rengi ve sesler, iÃ§eriÄŸin yazÄ±lÄ± ve gÃ¶rsel Ã¶geleriyle uyumlu olmalÄ±dÄ±r."
        ]
      },
      {
        "main_code": "8",
        "main_title": "ELEKTRONÄ°K Ä°Ã‡ERÄ°KLERÄ°N KAPSAM VE TASARIMININ UYGUNLUÄU",
        "code": "8.5.2",
        "section": "8.5 Ses ve GÃ¶rÃ¼ntÃ¼ Kalitesi",
        "title": "Sesler net ve anlaÅŸÄ±lÄ±r olmalÄ±dÄ±r.",
        "details": [
          "Sesler profesyonel kalitede olmalÄ±dÄ±r.",
          "Dikkat daÄŸÄ±tÄ±cÄ± arka plan sesleri olmamalÄ±dÄ±r."
        ]
      }
      // Not: Dosya boyutu ÅŸiÅŸmemesi iÃ§in Ã¶rnek kriterlerin bir kÄ±smÄ±nÄ± ekledim.
      // GerÃ§ek kullanÄ±mda tÃ¼m kriter listesi burada olmalÄ±dÄ±r.
      // Ãœstteki JSON bloÄŸunu tÃ¼m verilerinizle deÄŸiÅŸtirebilirsiniz.
    ];

    // --- YAPILANDIRMA VE SABÄ°TLER ---
    const STOP_WORDS = new Set(['ve', 'veya', 'ile', 'bir', 'bu', 'ÅŸu', 'o', 'iÃ§in', 'de', 'da', 'den', 'dan', 'ya', 'ki', 'ne', 'mi', 'mu', 'mÃ¼', 'mÄ±', 'gibi', 'kadar', 'Ã¶nce', 'sonra', 'daha', 'en', 'Ã§ok', 'az', 'her', 'tÃ¼m', 'bÃ¼tÃ¼n', 'bazÄ±', 'hiÃ§', 'yok', 'var']);
    
    const SYNONYMS = {
        'hata': ['yanlÄ±ÅŸ', 'yanlÄ±ÅŸlÄ±k', 'eksik', 'kusur', 'problem'],
        'yanlÄ±ÅŸ': ['hata', 'hatalÄ±', 'eksik', 'doÄŸru deÄŸil'],
        'gÃ¶rsel': ['resim', 'fotoÄŸraf', 'ÅŸekil', 'figÃ¼r', 'Ã§izim', 'grafik', 'tablo'],
        'alt yazÄ±': ['altyazÄ±', 'aÃ§Ä±klama', 'resim altÄ±', 'karekod'],
        'metin': ['yazÄ±', 'iÃ§erik', 'paragraf', 'text', 'cÃ¼mle'],
        'cevap': ['yanÄ±t', 'Ã§Ã¶zÃ¼m', 'anahtar', 'sonuÃ§'],
        'ses': ['seslendirme', 'audio', 'iÅŸitsel', 'kayÄ±t', 'konuÅŸma'],
        'video': ['film', 'animasyon', 'gÃ¶rÃ¼ntÃ¼', 'izleti'],
        'e-iÃ§erik': ['dijital', 'elektronik', 'etkileÅŸimli', 'karekod', 'uygulama']
    };

    // --- DOM ELEMENTLERÄ° ---
    const els = {
        apiToggle: document.getElementById('apiToggle'),
        apiPanel: document.getElementById('apiPanel'),
        apiStatusDot: document.getElementById('apiStatusDot'),
        apiStatusText: document.getElementById('apiStatusText'),
        apiKeyInput: document.getElementById('apiKeyInput'),
        saveApiKeyBtn: document.getElementById('saveApiKey'),
        searchInput: document.getElementById('searchInput'),
        aiSearchBtn: document.getElementById('aiSearchBtn'),
        resultsArea: document.getElementById('resultsArea'),
        liveIndicator: document.getElementById('liveIndicator')
    };

    let debounceTimer;

    // --- YARDIMCI FONKSÄ°YONLAR ---

    // TÃ¼rkÃ§e karakter normalizasyonu ve temizlik
    function normalizeText(text) {
        if (!text) return "";
        return text.toLocaleLowerCase('tr-TR')
                   .replace(/[\.,;:!?'"()\[\]{}<>\/\\@#$%^&*+=~`|_-]/g, ' ')
                   .replace(/\s+/g, ' ')
                   .trim();
    }

    // Kelime kÃ¶klerini ve stop wordleri iÅŸleme
    function tokenize(text) {
        const rawWords = normalizeText(text).split(' ');
        return rawWords.filter(w => w.length > 2 && !STOP_WORDS.has(w));
    }

    // Kelime eÅŸleÅŸme kontrolÃ¼ (EÅŸ anlamlÄ±lar dahil)
    function isWordMatch(word1, word2) {
        if (word1.includes(word2) || word2.includes(word1)) return true;
        
        // EÅŸ anlamlÄ± kontrolÃ¼
        for (const [key, values] of Object.entries(SYNONYMS)) {
            // EÄŸer word1 anahtarsa ve word2 deÄŸerlerindeyse
            if (key === word1 && values.some(v => v.includes(word2))) return true;
            if (key === word2 && values.some(v => v.includes(word1))) return true;
            // EÄŸer ikisi de deÄŸerler listesindeyse
            if (values.includes(word1) && values.includes(word2)) return true;
        }
        return false;
    }

    // API Key YÃ¶netimi
    function getApiKey() { return localStorage.getItem('gemini_api_key'); }
    
    function updateApiUI() {
        const hasKey = !!getApiKey();
        els.apiStatusDot.classList.toggle('active', hasKey);
        els.apiStatusText.textContent = hasKey ? "API Aktif" : "API Ayarla";
        if (hasKey) els.apiKeyInput.value = getApiKey();
        els.aiSearchBtn.disabled = !hasKey || els.searchInput.value.length < 5;
        
        // Buton metnini gÃ¼ncelle
        const btnContent = els.aiSearchBtn.querySelector('span');
        if (!hasKey) {
            btnContent.textContent = "YZ iÃ§in Anahtar Girin";
            els.aiSearchBtn.title = "Ayarlardan API anahtarÄ±nÄ± giriniz";
        } else {
            btnContent.textContent = "âœ¨ YZ ile Ã–neri Getir";
            els.aiSearchBtn.title = "Gemini AI ile analiz et";
        }
    }

    // --- LOKAL ARAMA MOTORU ---
    function performLocalSearch(query) {
        const userTokens = tokenize(query);
        if (userTokens.length === 0) return [];

        const results = CRITERIA_DATA.map(item => {
            const titleTokens = tokenize(item.title);
            const detailsText = item.details ? item.details.join(' ') : '';
            const detailsTokens = tokenize(detailsText);
            
            let score = 0;
            let matches = 0;

            // BaÅŸlÄ±kta ara (AÄŸÄ±rlÄ±ÄŸÄ± yÃ¼ksek)
            userTokens.forEach(uToken => {
                if (titleTokens.some(tToken => isWordMatch(uToken, tToken))) {
                    score += 10;
                    matches++;
                }
            });

            // Detaylarda ara
            userTokens.forEach(uToken => {
                if (detailsTokens.some(dToken => isWordMatch(uToken, dToken))) {
                    score += 5;
                    matches++;
                }
            });

            return { item, score, matches };
        });

        // Skor 0'dan bÃ¼yÃ¼k olanlarÄ± al, sÄ±rala
        return results
            .filter(r => r.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, 5) // En iyi 5 sonuÃ§
            .map(r => r.item);
    }

    // --- AI ARAMA MOTORU (GEMINI) ---
    async function performAiSearch(query) {
        const apiKey = getApiKey();
        if (!apiKey) return;

        // Context HazÄ±rlÄ±ÄŸÄ± (JSON boyutunu kÃ¼Ã§Ã¼ltÃ¼yoruz)
        const contextData = CRITERIA_DATA.map(c => 
            `ID:${c.code} | T:${c.title} | D:${(c.details||[]).join(' ')}`
        ).join('\n');

        const prompt = `
        Sen bir MEB ders kitabÄ± inceleme asistanÄ±sÄ±n. AÅŸaÄŸÄ±daki HATA TANIMINA en uygun kriter kodlarÄ±nÄ± bulman gerekiyor.
        
        HATA TANIMI: "${query}"
        
        GÃ–REV:
        1. Listeyi analiz et. Hem baÅŸlÄ±klara (T) hem detaylara (D) bak.
        2. Hata ile en alakalÄ± 2 veya 3 kriteri seÃ§.
        3. Neden seÃ§tiÄŸini kÄ±saca aÃ§Ä±kla.
        
        KRÄ°TER LÄ°STESÄ°:
        ${contextData}
        
        Ã‡IKTI FORMATI (Sadece geÃ§erli JSON):
        { "recommendations": [ { "code": "1.1.1", "reason": "Buraya neden yazdÄ±n" } ] }
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            if (!response.ok) throw new Error("API HatasÄ±");

            const data = await response.json();
            const textResponse = data.candidates[0].content.parts[0].text;
            const parsed = JSON.parse(textResponse);
            
            return parsed.recommendations;

        } catch (error) {
            console.error("AI HatasÄ±:", error);
            throw error;
        }
    }

    // --- ARAYÃœZ OLUÅTURMA ---
    function renderResults(results, type = 'local', aiReasons = []) {
        els.resultsArea.innerHTML = '';

        if (results.length === 0) {
            els.resultsArea.innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">ğŸ˜•</span>
                    <p>EÅŸleÅŸen kriter bulunamadÄ±. LÃ¼tfen aÃ§Ä±klamayÄ± zenginleÅŸtirin veya farklÄ± kelimeler deneyin.</p>
                </div>`;
            return;
        }

        // Badge
        const badgeDiv = document.createElement('div');
        badgeDiv.className = 'result-badge';
        badgeDiv.innerHTML = type === 'ai' 
            ? `<span class="badge-pill">âœ¨ Yapay Zeka Ã–nerileri</span>` 
            : `<span class="badge-pill local">âš¡ HÄ±zlÄ± Kelime EÅŸleÅŸmeleri</span>`;
        els.resultsArea.appendChild(badgeDiv);

        results.forEach(item => {
            const aiInfo = aiReasons.find(r => r.code === item.code);
            
            const card = document.createElement('div');
            card.className = 'card';
            
            let detailsHtml = '';
            if (item.details && item.details.length > 0) {
                detailsHtml = `
                    <div class="details-list">
                        <div class="details-title">DETAYLAR</div>
                        <ul>${item.details.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>`;
            }

            let aiReasonHtml = '';
            if (aiInfo) {
                aiReasonHtml = `<div class="ai-reason">ğŸ’¡ <strong>AI Analizi:</strong> ${aiInfo.reason}</div>`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <div class="code-display" title="Kodu Kopyala" onclick="copyCode('${item.code}')">${item.code}</div>
                    <div class="card-content">
                        <span class="section-tag">${item.main_title} > ${item.section}</span>
                        <h3>${item.title}</h3>
                    </div>
                </div>
                ${aiReasonHtml}
                ${detailsHtml}
            `;
            els.resultsArea.appendChild(card);
        });
    }

    // --- EVENT LISTENERS ---

    // 1. API AyarlarÄ± AÃ§/Kapa
    els.apiToggle.addEventListener('click', () => {
        els.apiPanel.classList.toggle('show');
    });

    // 2. API Key Kaydet
    els.saveApiKeyBtn.addEventListener('click', () => {
        const key = els.apiKeyInput.value.trim();
        if (key) {
            localStorage.setItem('gemini_api_key', key);
            updateApiUI();
            els.apiPanel.classList.remove('show');
        }
    });

    // 3. Input DeÄŸiÅŸikliÄŸi (Lokal Arama)
    els.searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        // AI butonu durumu
        els.aiSearchBtn.disabled = !getApiKey() || query.length < 5;

        // YazÄ±yor indikatÃ¶rÃ¼
        if (query.length > 2) els.liveIndicator.classList.add('visible');
        else els.liveIndicator.classList.remove('visible');

        // Debounce ile lokal arama
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (query.length >= 3) {
                const results = performLocalSearch(query);
                renderResults(results, 'local');
            } else if (query.length === 0) {
                 els.resultsArea.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ“</span>
                        <p>Bir inceleme tespiti yazmaya baÅŸlayÄ±n.</p>
                    </div>`;
            }
            els.liveIndicator.classList.remove('visible');
        }, 300);
    });

    // 4. AI Butonu TÄ±klama
    els.aiSearchBtn.addEventListener('click', async () => {
        const query = els.searchInput.value.trim();
        if (!query) return;

        // Loading state
        const btnContent = els.aiSearchBtn.querySelector('span');
        const originalText = btnContent.textContent;
        els.aiSearchBtn.disabled = true;
        btnContent.innerHTML = `<div class="spinner"></div> Analiz Ediliyor...`;

        try {
            const recommendations = await performAiSearch(query);
            
            // KodlarÄ± bul ve eÅŸleÅŸen full kriter objelerini al
            const matchedCriteria = recommendations.map(rec => {
                return CRITERIA_DATA.find(c => c.code === rec.code);
            }).filter(Boolean);

            renderResults(matchedCriteria, 'ai', recommendations);
            
        } catch (error) {
            alert("AI servisine ulaÅŸÄ±lamadÄ±. LÃ¼tfen API anahtarÄ±nÄ±zÄ± kontrol edin veya baÄŸlantÄ±nÄ±zÄ± deneyin.");
        } finally {
            els.aiSearchBtn.disabled = false;
            btnContent.textContent = originalText;
        }
    });

    // Kopyalama Fonksiyonu
    window.copyCode = function(code) {
        navigator.clipboard.writeText(code);
        // Basit bir gÃ¶rsel geri bildirim eklenebilir
    };

    // BaÅŸlangÄ±Ã§
    document.addEventListener('DOMContentLoaded', updateApiUI);

</script>
</body>
</html>