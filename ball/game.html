<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoFootball - 90'lar Casio Mod</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Rubik+Mono+One&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0d3b66;
            --yellow: #f4d35e;
            --orange: #ee964b;
            --red: #f95738; /* Ana kronometre rengi için kullanılabilir */
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #222; /* Casio ekranı için daha koyu bir gri */
            --casio-bg: #c0c0c0; /* Casio saat kasası rengi */
            --casio-screen-bg: #90a090; /* Casio ekran arka planı (genelde yeşilimsi) */
            --casio-text: #333333; /* Casio ekran yazısı */
            --football-green: #2A8C2A; /* Yeşil saha rengi */
            --goal-line-white: #FFFFFF;

            --transparent-black: rgba(0, 0, 0, 0.7);
            --transparent-green: rgba(0, 255, 0, 0.3);
            --transparent-red: rgba(255, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: var(--football-green); /* Yeşil saha arka planı */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Animasyonlarda taşmayı engelle */
            position: relative; /* İçerideki absolute pozisyonlamalar için */
        }

        /* Saha Çizgileri (Basit) */
        body::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            width: 2px;
            height: 80%;
            background-color: rgba(255, 255, 255, 0.3); /* Orta saha çizgisi */
            transform: translateX(-50%);
            z-index: 0;
        }
        body::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px; /* Orta yuvarlak çapı */
            height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .game-area {
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Diğer elemanların üstünde olması için */
        }

        /* Kale Alanı (Basit CSS ile) */
        .goal-area {
            position: absolute;
            top: 10px; /* Sahanın üst kısmında */
            left: 50%;
            transform: translateX(-50%);
            width: 120px; /* Kale genişliği */
            height: 60px; /* Kale yüksekliği */
            border: 3px solid var(--goal-line-white);
            border-top: none; /* Üst direk yok, sadece yan ve alt */
            z-index: 1;
        }
        .goal-area::before, .goal-area::after { /* Kale direkleri */
            content: '';
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 100%;
            background-color: var(--goal-line-white);
        }
        .goal-area::before { left: -3px; }
        .goal-area::after { right: -3px; }


        /* Futbol Topu */
        #football-ball {
            position: absolute;
            bottom: 20%; /* Başlangıç pozisyonu, kronometrenin biraz üstü */
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem; /* Top boyutu */
            z-index: 2;
            transition: transform 0.5s ease-in-out, bottom 0.5s ease-in-out;
        }

        #football-ball.shooting {
            /* Moves the ball towards the goal area */
            transform: translateX(-50%); /* Maintain horizontal centering */
            bottom: 85%; /* Target Y position (closer to the top). Adjust this percentage for best visual effect. */
        }


        /* Gol Sevinci Metni */
        #goal-celebration-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            font-family: 'Press Start 2P', cursive; /* Pixelated font */
            font-size: 3rem; /* Büyük ve etkili */
            color: var(--yellow);
            text-shadow: 3px 3px 0 var(--navy), -1px -1px 0 var(--navy), 1px -1px 0 var(--navy), -1px 1px 0 var(--navy), 1px 1px 0 var(--navy);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease-out;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
        }

        #goal-celebration-text.animate {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        .header {
            background-color: var(--navy);
            color: var(--white);
            padding: 0.5rem 1rem; /* Biraz daha kompakt */
            text-align: center;
            position: relative;
            z-index: 2; /* Oyun alanının üstünde */
        }
        
        .logo {
            font-size: 1.5rem; /* Biraz küçültüldü */
            font-weight: bold;
            margin-bottom: 0.25rem;
             font-family: 'Press Start 2P', cursive;
        }

        .turn-indicator {
            font-size: 0.9rem; /* Biraz küçültüldü */
            padding: 0.3rem 0.8rem;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .player1-turn {
            background-color: var(--yellow);
            color: var(--navy);
        }

        .player2-turn {
            background-color: var(--orange);
            color: var(--navy);
        }

        .blinking {
            animation: blink-animation 1s infinite;
        }

        @keyframes blink-animation {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; 
            font-weight: bold;
        }
        
        .team {
            padding: 0 0.5rem; 
            flex: 1;
            text-align: center;
        }
        
        .score {
            padding: 0 0.5rem;
            min-width: 1.5rem; 
            text-align: center;
            font-size: 1.3rem; /* Skor biraz daha belirgin */
        }
        
        .main { /* Bu artık game-area içinde kronometre ve kontrolleri tutacak */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Kontrolleri aşağıya ve kronometreyi üste yakın tutar */
            flex-grow: 1;
            padding: 1rem;
            width: 100%;
            z-index: 2; /* Header ile aynı seviyede */
            margin-bottom: 50px; /* Footer için yer bırak */
        }
        
        .stopwatch-container {
            background-color: var(--casio-bg); /* Casio saat kasası */
            padding: 10px;
            border-radius: 8px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3), inset 1px 1px 0px rgba(255,255,255,0.5);
            margin-bottom: 1.5rem; /* Top ile arasında boşluk */
        }

        .stopwatch {
            font-family: 'Rubik Mono One', 'Press Start 2P', monospace; /* Dijital görünümlü font */
            font-size: 3.5rem; /* Boyut ayarlanabilir */
            background-color: var(--casio-screen-bg); /* Casio ekran arka planı */
            color: var(--casio-text); /* Casio ekran yazısı */
            padding: 0.8rem 1.2rem;
            border-radius: 0.3rem;
            border: 2px solid var(--dark-gray);
            min-width: 15rem; /* Min genişlik */
            text-align: center;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.2); /* Hafif ekran parlama efekti */
            box-shadow: inset 2px 2px 3px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        
        .message {
            font-size: 1.3rem; /* Biraz büyütüldü */
            height: 1.8rem; /* Yüksekliği ayarlandı */
            margin: 0.5rem 0; /* Boşluk azaltıldı */
            color: var(--white); /* Beyaz, saha üzerinde daha iyi okunur */
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px var(--navy); /* Okunurluk için gölge */
            min-height: 1.8rem; /* İçerik olmadığında bile yer kaplasın */
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem; /* Mesaj ile arasında boşluk */
        }
        
        .btn {
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 2rem;
            background-color: var(--navy);
            color: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Press Start 2P', cursive; /* Pixelated font for buttons */
            box-shadow: 2px 2px 0px var(--dark-gray);
        }

        .btn:hover {
            transform: translateY(-2px) translateX(-1px);
            box-shadow: 3px 3px 0px var(--dark-gray);
        }

        .btn:disabled {
            background-color: #999;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: 1px 1px 0px #777;
        }
        
        .btn:active {
            transform: translateY(1px) translateX(0.5px);
            box-shadow: 1px 1px 0px var(--dark-gray);
        }
        
        .btn-primary {
            background-color: var(--orange);
        }
        
        .btn-secondary {
            background-color: var(--navy);
        }

        .keyboard-hint {
            font-size: 0.8rem; /* Biraz küçültüldü */
            color: var(--light-gray);
            margin-top: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 1px 1px 1px var(--dark-gray);
        }
        
        .modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En üstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content { 
            background-color: var(--casio-bg); /* Modal da Casio temasına uygun */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }

        .player-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .player-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: var(--casio-text);
            font-family: 'Roboto', sans-serif; /* Radio buton yazıları normal olabilir */
        }
        
        .penalty-modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En üstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .penalty-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .penalty-card { 
            background-color: var(--casio-bg); /* Penaltı kartı da Casio temalı */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        
        .penalty-title {
            font-size: 1.3rem; /* Biraz küçültüldü */
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }
        
        .penalty-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .game-flash { /* Bu genel ekran flashı olarak kalabilir veya kaldırılabilir */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5; /* Top ve GOOOL yazısının altında */
        }
        
        .flash-goal {
            background-color: var(--transparent-green);
        }
        
        .flash-miss { /* Aut durumu için kullanılabilir */
            background-color: var(--transparent-red);
        }
        
        .stats { /* İstatistikler görünür olmayabilir, isteğe bağlı */
            display: none; /* Şimdilik gizlendi, tasarımda yer kaplamasın */
            justify-content: space-around;
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--light-gray);
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        
        @media (max-width: 600px) {
            .stopwatch {
                font-size: 2.5rem; /* Mobil için daha küçük */
                min-width: 12rem;
                padding: 0.6rem 1rem;
            }
            .stopwatch-container {
                padding: 8px;
            }
            #goal-celebration-text {
                font-size: 2rem;
            }
            .controls {
                flex-direction: column;
            }
            .scoreboard {
                font-size: 0.9rem;
            }
            .team {
                padding: 0 0.2rem;
            }
            .logo {
                font-size: 1.2rem;
            }
            #football-ball {
                font-size: 2rem;
            }
            .goal-area {
                width: 100px;
                height: 50px;
            }
             .message {
                font-size: 1.1rem;
            }
        }

        /* Eklenen Stiller */
        #lobby-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.5rem;
        }

        #lobby-controls input[type="text"] {
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 0.3rem;
            border: 1px solid var(--dark-gray);
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            background-color: var(--light-gray);
            color: var(--casio-text);
        }

        .game-board.hidden, #lobby-controls.hidden {
            display: none !important;
        }
        /* Tribün Stili */
        .spectators {
            position: absolute;
            top: -20px; /* Header'ın biraz üstüne taşabilir veya header'ın hemen altına */
            left: 0;
            width: 100%;
            height: 50px; /* Tribün yüksekliği */
            /* background-color: #555; */ /* Basit bir tribün rengi */
            overflow: hidden;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 0; /* Saha çizgilerinin arkasında, header'ın önünde olabilir */
        }

        .spectator-icon {
            font-size: 1.5rem; /* Taraftar boyutu */
            color: rgba(255, 255, 255, 0.7);
            animation: cheer 1s infinite alternate ease-in-out;
            animation-play-state: paused; /* Başlangıçta duruk */
        }
         .spectator-icon:nth-child(odd) {
            animation-delay: 0.2s;
        }
         .spectator-icon:nth-child(even) {
            animation-delay: 0.5s;
        }

        @keyframes cheer {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        .cheering .spectator-icon {
            animation-play-state: running;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ChronoGoal!</div>
        <div class="spectators" id="spectators-area">
            <span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span>
        </div>
        <div class="scoreboard">
            <div class="team" id="player1-name">OYUNCU 1</div>
            <div class="score" id="score-p1">0</div>
            <div>-</div>
            <div class="score" id="score-p2">0</div>
            <div class="team" id="player2-name">OYUNCU 2</div>
        </div>
        <div id="turn-indicator" class="turn-indicator">Sıra Oyuncuda</div>
    </div>

    <div class="game-area">
        <div id="lobby-controls">
            <input type="text" id="room-code-input" placeholder="Oda Kodu Girin">
            <button id="join-room-btn" class="btn btn-primary">Odaya Katıl</button>
            <p style="color: var(--white); font-family: 'Press Start 2P', cursive; margin: 0.5rem 0;">veya</p>
            <button id="create-room-btn" class="btn btn-secondary">Yeni Oda Oluştur</button>
        </div>

        <div class="game-board hidden"> <!-- Oyun alanı başlangıçta gizli -->
            <div class="goal-area"></div>
            <div id="football-ball">⚽</div>
            <div id="goal-celebration-text">GOOOOL!</div>
            <div class="message" id="message">Kim Başlasın?</div>

            <div class="main"> <!-- Kronometre ve kontroller bu alanda -->
                <div class="stopwatch-container">
                    <div class="stopwatch" id="stopwatch">00.00</div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="toggle-btn" aria-label="Başlat veya Durdur" disabled>Başlat</button>
                    <button class="btn btn-secondary" id="reset-btn" aria-label="Yeniden Başlat" disabled>Sıfırla</button>
                </div>
                <div class="keyboard-hint">P1: Boşluk, P2: Enter (Online modda sadece aktif oyuncu)</div>
            </div>
        </div>
    </div>
    
    <div class="stats"> <!-- İstatistikler (isteğe bağlı, şu an display: none) -->
        <div>Goller: <span id="goals">0</span></div>
        <div>Penaltılar: <span id="penalties">0</span></div>
        <div>Kaçan Penaltılar: <span id="misses">0</span></div>
    </div>

    <div id="start-player-modal" class="modal">
        <div class="modal-content">
            <h2>KİM BAŞLASIN?</h2>
            <div class="player-options">
                <label><input type="radio" name="startPlayer" value="1" checked> Oyuncu 1</label>
                <label><input type="radio" name="startPlayer" value="2"> Oyuncu 2</label>
            </div>
            <button id="confirm-start-player-btn" class="btn btn-primary">ONAYLA</button>
        </div>
    </div>
    
    <div class="penalty-modal" id="penalty-modal">
        <div class="penalty-card">
            <div class="penalty-title" id="penalty-title-text">PENALTI!</div>
            <div>Sayı TEK mi, ÇİFT mi?</div>
            <div class="penalty-options">
                <button class="btn btn-primary" id="odd-btn" aria-label="Tek">TEK</button>
                <button class="btn btn-primary" id="even-btn" aria-label="Çift">ÇİFT</button>
            </div>
        </div>
    </div>
    
    <div class="game-flash" id="game-flash"></div>
    
    <audio id="goal-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="whistle-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2032/2032-preview.mp3" type="audio/mpeg">
    </audio>
     <audio id="aut-sound" preload="auto"> <!-- Aut sesi için eklendi -->
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-jumping-in-a-video-game-2043.mp3" type="audio/mpeg">
    </audio>
    
    <script type="module">
        // Firebase SDK'larını import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        // ÖNEMLİ: Firebase projenizin yapılandırma bilgilerini buraya girin!
        const firebaseConfig = {
            apiKey: "AIzaSyAad-afEL6c7S3Y4RJuGwoFxgPsx81k_D0",
            authDomain: "chronogoalonline.firebaseapp.com",
            databaseURL: "https://chronogoalonline-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chronogoalonline",
            storageBucket: "chronogoalonline.firebasestorage.app",
            messagingSenderId: "688627066429",
            appId: "1:688627066429:web:0c38b3e132c579668a2c54",
            measurementId: "G-S0K2X6DB15"
        };

        // Firebase'i başlat
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global Değişkenler (Firebase entegrasyonu için)
        let currentGameId = null;
        let localPlayerNumber = null; // Bu istemcinin oyuncu numarası (1 veya 2)
        let gameRoomCode = null; // Kullanıcıya gösterilen oda kodu

        // Oyun değişkenleri (Mevcutlar korunuyor, bazıları Firebase'den yönetilecek)
        let interval;
        let running = false;
        let milliseconds = 0; // Bu yerel kronometre için hala kullanılacak
        let currentPlayer = 1; // Firebase'den gameData.currentPlayer ile yönetilecek
        
        // DOM elementleri
        const stopwatchElem = document.getElementById('stopwatch');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageElem = document.getElementById('message');
        
        const penaltyModal = document.getElementById('penalty-modal');
        const penaltyTitleTextElem = document.getElementById('penalty-title-text');
        const oddBtn = document.getElementById('odd-btn');
        const evenBtn = document.getElementById('even-btn');
        
        const scoreP1Elem = document.getElementById('score-p1');
        const scoreP2Elem = document.getElementById('score-p2');
        
        const gameFlash = document.getElementById('game-flash');
        
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');
        const autSound = document.getElementById('aut-sound');

        const turnIndicatorElem = document.getElementById('turn-indicator');
        const footballBallElem = document.getElementById('football-ball');
        const goalCelebrationTextElem = document.getElementById('goal-celebration-text');
        const spectatorsArea = document.getElementById('spectators-area');

        const lobbyControls = document.getElementById('lobby-controls');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const gameBoard = document.querySelector('.game-board');

        function initializeAppUI() {
            lobbyControls.classList.remove('hidden');
            gameBoard.classList.add('hidden');
            messageElem.classList.add('hidden');
            toggleBtn.disabled = true;
            resetBtn.disabled = true;
        }
        
        async function createGameRoom() {
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;
            try {
                gameRoomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                localPlayerNumber = 1;
                currentGameId = gameRoomCode;

                const initialGameData = {
                    player1: { id: "player1_host", name: "Oyuncu 1", score: 0, lastStopTimeMs: null, penaltyChoice: null },
                    currentPlayer: 1,
                    gameState: 'waiting_for_player2',
                    gameSettings: {
                        maxTurns: 10,
                        turnTimeoutSeconds: 5 
                    },
                    currentTurn: 0,
                    lastActionTimestamp: serverTimestamp(),
                    messageToPlayers: `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`,
                    isBotGame: false,
                };

                await set(ref(database, 'games/' + currentGameId), initialGameData);
                
                lobbyControls.classList.add('hidden');
                gameBoard.classList.remove('hidden');
                messageElem.classList.remove('hidden');
                messageElem.textContent = `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`;
                console.log(`Oda oluşturuldu: ${currentGameId}`);
                listenToGameUpdates(currentGameId);

            } catch (error) {
                console.error("Oda oluşturulamadı:", error);
                messageElem.classList.remove('hidden');
                messageElem.textContent = "Hata: Oda oluşturulamadı. Konsolu kontrol edin.";
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        async function joinGameRoom() {
            const inputRoomCode = roomCodeInput.value.toUpperCase().trim();
            if (!inputRoomCode) {
                alert("Lütfen bir oda kodu girin."); 
                return;
            }

            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;

            try {
                const gameRefPath = 'games/' + inputRoomCode;
                const gameRefInstance = ref(database, gameRefPath);
                const snapshot = await get(gameRefInstance);

                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    if (gameData.player2) {
                        alert("Bu oda dolu veya zaten bir oyun devam ediyor.");
                        console.log("Oda dolu:", inputRoomCode);
                        createRoomBtn.disabled = false;
                        joinRoomBtn.disabled = false;
                        roomCodeInput.disabled = false;
                        return;
                    }
                    if (gameData.gameState !== 'waiting_for_player2') {
                         alert("Bu odaya şu an katılamazsınız (oyun başlamış olabilir).");
                         createRoomBtn.disabled = false;
                         joinRoomBtn.disabled = false;
                         roomCodeInput.disabled = false;
                         return;
                    }

                    localPlayerNumber = 2;
                    currentGameId = inputRoomCode;
                    gameRoomCode = inputRoomCode;

                    const updates = {};
                    updates[`player2`] = { id: "player2_guest", name: "Oyuncu 2", score: 0, lastStopTimeMs: null, penaltyChoice: null };
                    updates[`gameState`] = 'player1_turn'; 
                    updates[`currentPlayer`] = 1; 
                    updates[`messageToPlayers`] = 'Oyuncular hazır! Sıra Oyuncu 1\'de.';
                    updates[`lastActionTimestamp`] = serverTimestamp();
                    
                    await update(gameRefInstance, updates);

                    console.log(`Odaya katınıldı: ${currentGameId}`);
                    lobbyControls.classList.add('hidden');
                    gameBoard.classList.remove('hidden');
                    messageElem.classList.remove('hidden');
                    listenToGameUpdates(currentGameId);

                } else {
                    alert("Oda bulunamadı. Kodu kontrol edin.");
                    console.log("Oda bulunamadı:", inputRoomCode);
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                }
            } catch (error) {
                console.error("Odaya katılırken hata:", error);
                alert("Hata: Odaya katılamadı. Konsolu kontrol edin.");
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        function listenToGameUpdates(gameId) {
            const gameRefPath = 'games/' + gameId;
            const gameRefInstance = ref(database, gameRefPath);

            onValue(gameRefInstance, (snapshot) => {
                if (!snapshot.exists()) {
                    console.warn(`Dinlenen oda (${gameId}) artık mevcut değil.`);
                    alert("Oda bağlantısı kesildi veya oda kapandı.");
                    lobbyControls.classList.remove('hidden');
                    gameBoard.classList.add('hidden');
                    messageElem.classList.add('hidden');
                    currentGameId = null;
                    localPlayerNumber = null;
                    gameRoomCode = null;
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                    roomCodeInput.value = '';
                    return;
                }

                const gameData = snapshot.val();
                console.log("Oyun verisi güncellendi:", gameData);
                if (!gameData) return;

                scoreP1Elem.textContent = gameData.player1?.score !== undefined ? gameData.player1.score : 0;
                scoreP2Elem.textContent = gameData.player2?.score !== undefined ? gameData.player2.score : 0;
                
                document.getElementById('player1-name').textContent = gameData.player1?.name || 'OYUNCU 1';
                document.getElementById('player2-name').textContent = gameData.player2?.name || (gameData.isBotGame ? 'BOT' : (gameData.gameState === 'waiting_for_player2' ? 'BEKLENİYOR' : 'OYUNCU 2'));

                if(messageElem.classList.contains('hidden')) messageElem.classList.remove('hidden');
                messageElem.textContent = gameData.messageToPlayers || '';

                const turnIndicatorClasses = ['player1-turn', 'player2-turn', 'blinking'];
                turnIndicatorElem.classList.remove(...turnIndicatorClasses);

                if (gameData.gameState === 'waiting_for_player2' && localPlayerNumber === 1) {
                    turnIndicatorElem.textContent = `Oda: ${gameRoomCode} - Rakip bekleniyor...`;
                } else if (gameData.gameState === 'game_over') {
                     turnIndicatorElem.textContent = "MAÇ BİTTİ!";
                } else if (gameData.player1 && gameData.player2) { 
                     turnIndicatorElem.textContent = `Sıra: Oyuncu ${gameData.currentPlayer}`;
                     const currentTurnPlayerClass = gameData.currentPlayer === 1 ? 'player1-turn' : 'player2-turn';
                     const otherPlayerClass = gameData.currentPlayer === 1 ? 'player2-turn' : 'player1-turn';
                     turnIndicatorElem.classList.add(currentTurnPlayerClass);
                     turnIndicatorElem.classList.remove(otherPlayerClass);
                     if (localPlayerNumber === gameData.currentPlayer) {
                        turnIndicatorElem.textContent += " (SEN)";
                     }
                } else {
                     turnIndicatorElem.textContent = "Oyuncular bekleniyor...";
                }

                if (gameData.gameState === 'waiting_for_player2' || !gameData.player2) {
                    toggleBtn.disabled = true;
                } else if (gameData.gameState === 'game_over') {
                    toggleBtn.disabled = true;
                } else {
                    toggleBtn.disabled = !(localPlayerNumber === gameData.currentPlayer && 
                                           (gameData.gameState === `player${localPlayerNumber}_turn` || 
                                            gameData.gameState === `player${localPlayerNumber}_timing`));
                }
                resetBtn.disabled = true;
                
                if (gameData.gameState && gameData.gameState.endsWith('_stopped')) {
                    if (localPlayerNumber === 1 && gameData.lastActionDetail) {
                        const lastPlayer = gameData.lastActionDetail.player;
                        const centiseconds = gameData.lastActionDetail.centiseconds;
                        const timeMs = gameData.lastActionDetail.timeMs;

                        const expectedNextPlayer = lastPlayer === 1 ? 2 : 1;
                        if (gameData.currentPlayer === expectedNextPlayer && gameData.gameState === `player${expectedNextPlayer}_turn`) {
                            // Already processed and turned over, do nothing here for this client.
                            // console.log("Host: Action already processed, state advanced.");
                        } else {
                            let outcomeMessage = "";
                            let newGameState = "";
                            const nextPlayer = lastPlayer === 1 ? 2 : 1;
                            // let scoreUpdates = {}; // For GOL etc. in future features

                            // For F2, implement AUT and turn change.
                            // Detailed GOL, PENALTI, FRIKIK logic will be in F3, F4, F5.
                            
                            // PRD F6: AUT/KAÇIRILAN Sonucu (Default for F2)
                            outcomeMessage = `AUT! Sıra Oyuncu ${nextPlayer}\'de. (Durdurulan: ${formatTime(timeMs)})`;
                            newGameState = `player${nextPlayer}_turn`;
                            
                            const updates = {
                                currentPlayer: nextPlayer,
                                gameState: newGameState,
                                messageToPlayers: outcomeMessage,
                                lastActionTimestamp: serverTimestamp(),
                                currentTurn: (gameData.currentTurn || 0) + 1,
                                // lastActionDetail: null, // Clear after processing if needed, or keep for history
                            };

                            const gameRefPath = 'games/' + currentGameId;
                            update(ref(database, gameRefPath), updates)
                                .then(() => {
                                    console.log(`Host: Oyuncu ${lastPlayer} aksiyonu değerlendirildi. Yeni tur: Oyuncu ${nextPlayer}. Sonuç: AUT`);
                                })
                                .catch(error => {
                                    console.error("Host: Oyun durumu güncellenirken hata:", error);
                                });
                        }
                    }
                }

                if (gameData.messageToPlayers && 
                    gameData.messageToPlayers.toLowerCase().includes('aut!') && 
                    gameData.gameState !== gameData.previousGameStateForAutSound) {
                    if (autSound) autSound.play().catch(e => console.log("Aut sesi oynatılamadı:", e));
                    flashScreen('miss');
                    // Firebase'e bir sonraki sesin çalınabilmesi için dummy bir state yazılabilir veya bu kontrol iyileştirilebilir.
                    // Şimdilik bu basit kontrol yeterli olabilir.
                }

                if (gameData.messageToPlayers && gameData.messageToPlayers.toLowerCase().includes('gooool')) {
                    spectatorsArea.classList.add('cheering');
                    animateBallToGoal();
                    animateGoalText();  
                    setTimeout(() => spectatorsArea.classList.remove('cheering'), 2500);
                }
            });
        }
        
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const centiseconds = Math.floor((ms % 1000) / 10);
            return `${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
        }
        
        function startStopwatch() {
            if (running || !localPlayerNumber || !currentGameId) return;
            
            const gameRefPath = 'games/' + currentGameId;
            const gameRefInstance = ref(database, gameRefPath);

            get(gameRefInstance).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer !== localPlayerNumber || gameData.gameState !== `player${localPlayerNumber}_turn`){
                        console.warn("Sıra sizde değil veya oyun durumu (start) uygun değil:", gameData.gameState);
                        return;
                    }

                    running = true;
                    toggleBtn.textContent = 'Durdur';
                    milliseconds = 0; 
                    stopwatchElem.textContent = formatTime(milliseconds);

                    update(gameRefInstance, { 
                        gameState: `player${localPlayerNumber}_timing`,
                        messageToPlayers: `Oyuncu ${localPlayerNumber} oynuyor...`,
                        lastActionTimestamp: serverTimestamp()
                    });

                    interval = setInterval(() => {
                        milliseconds += 10;
                        stopwatchElem.textContent = formatTime(milliseconds);
                    }, 10);
                }
            });
        }
        
        function stopStopwatch() {
            if (!running || !localPlayerNumber || !currentGameId) return;

            running = false;
            clearInterval(interval);
            toggleBtn.textContent = 'Başlat';
            toggleBtn.disabled = true; 

            const stoppedMilliseconds = milliseconds;
            const centisecondsValue = Math.floor((stoppedMilliseconds % 1000) / 10);

            const gameRefPath = 'games/' + currentGameId;
            update(ref(database, gameRefPath), {
                 lastActionDetail: {
                    player: localPlayerNumber,
                    timeMs: stoppedMilliseconds,
                    centiseconds: centisecondsValue
                },
                gameState: `player${localPlayerNumber}_stopped`,
                messageToPlayers: `Oyuncu ${localPlayerNumber} durdurdu: ${formatTime(stoppedMilliseconds)}. Sonuç bekleniyor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                console.log("Durdurma bilgisi Firebase'e gönderildi: " + formatTime(stoppedMilliseconds));
            }).catch(error => {
                console.error("Durdurma bilgisi gönderilemedi:", error);
                toggleBtn.disabled = false; 
            });
        }
        
        function animateBallToGoal() {
            footballBallElem.classList.add('shooting');
            setTimeout(() => {
                footballBallElem.classList.remove('shooting');
                footballBallElem.style.transform = 'translateX(-50%)'; 
                footballBallElem.style.bottom = '20%'; 
            }, 1000); 
        }

        function animateGoalText() {
            goalCelebrationTextElem.classList.add('animate');
            setTimeout(() => {
                goalCelebrationTextElem.classList.remove('animate');
            }, 2000); 
        }
        
        function togglePenaltyModal(show) { 
            if (show) {
                penaltyModal.classList.add('active');
            } else {
                penaltyModal.classList.remove('active');
            }
        }
        
        function flashScreen(type) { 
            gameFlash.className = 'game-flash'; 
            void gameFlash.offsetWidth; 
            
            if (type === 'miss') { 
                gameFlash.classList.add('flash-miss');
            }
            
            setTimeout(() => {
                gameFlash.className = 'game-flash'; 
            }, 500);
        }
        
        createRoomBtn.addEventListener('click', createGameRoom);
        joinRoomBtn.addEventListener('click', joinGameRoom);

        toggleBtn.addEventListener('click', () => {
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer === localPlayerNumber){
                        if(gameData.gameState === `player${localPlayerNumber}_turn`){
                            startStopwatch();
                        } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                            stopStopwatch();
                        } else {
                            console.log("Oyun durumu (toggleBtn) kronometre başlatmaya/durdurmaya uygun değil:", gameData.gameState);
                        }
                    } else {
                        console.log("Sıra sizde değil (toggleBtn).");
                    }
                }
            });
        });

        oddBtn.addEventListener('click', () => {
            console.log("Penaltı TEK seçildi - Firebase entegrasyonu F4'te yapılacak.");
        });
        
        evenBtn.addEventListener('click', () => {
            console.log("Penaltı ÇİFT seçildi - Firebase entegrasyonu F4'te yapılacak.");
        });
        
        document.addEventListener('keydown', (e) => {
            if (!currentGameId || !localPlayerNumber || lobbyControls.classList.contains('hidden') === false) return; 
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if (gameData.currentPlayer === localPlayerNumber) {
                        if (e.code === 'Space' || e.code === 'Enter') { 
                            e.preventDefault();
                             if(gameData.gameState === `player${localPlayerNumber}_turn`){
                                startStopwatch();
                            } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                                stopStopwatch();
                            }
                        }
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', initializeAppUI);
    </script>
</body>
</html>