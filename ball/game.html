<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoFootball - 90'lar Casio Mod</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Rubik+Mono+One&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0d3b66;
            --yellow: #f4d35e;
            --orange: #ee964b;
            --red: #f95738; /* Ana kronometre rengi için kullanılabilir */
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #222; /* Casio ekranı için daha koyu bir gri */
            --casio-bg: #c0c0c0; /* Casio saat kasası rengi */
            --casio-screen-bg: #90a090; /* Casio ekran arka planı (genelde yeşilimsi) */
            --casio-text: #333333; /* Casio ekran yazısı */
            --football-green: #2A8C2A; /* Yeşil saha rengi */
            --goal-line-white: #FFFFFF;

            --transparent-black: rgba(0, 0, 0, 0.7);
            --transparent-green: rgba(0, 255, 0, 0.3);
            --transparent-red: rgba(255, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: var(--football-green); /* Yeşil saha arka planı */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Animasyonlarda taşmayı engelle */
            position: relative; /* İçerideki absolute pozisyonlamalar için */
        }

        /* Saha Çizgileri (Basit) */
        body::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            width: 2px;
            height: 80%;
            background-color: rgba(255, 255, 255, 0.3); /* Orta saha çizgisi */
            transform: translateX(-50%);
            z-index: 0;
        }
        body::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px; /* Orta yuvarlak çapı */
            height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .game-area {
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Diğer elemanların üstünde olması için */
        }

        /* Kale Alanı (Basit CSS ile) */
        .goal-area {
            position: absolute;
            top: 10px; /* Sahanın üst kısmında */
            left: 50%;
            transform: translateX(-50%);
            width: 120px; /* Kale genişliği */
            height: 60px; /* Kale yüksekliği */
            border: 3px solid var(--goal-line-white);
            border-top: none; /* Üst direk yok, sadece yan ve alt */
            z-index: 1;
        }
        .goal-area::before, .goal-area::after { /* Kale direkleri */
            content: '';
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 100%;
            background-color: var(--goal-line-white);
        }
        .goal-area::before { left: -3px; }
        .goal-area::after { right: -3px; }


        /* Futbol Topu */
        #football-ball {
            position: absolute;
            bottom: 20%; /* Başlangıç pozisyonu, kronometrenin biraz üstü */
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem; /* Top boyutu */
            z-index: 2;
            transition: transform 0.5s ease-in-out, bottom 0.5s ease-in-out;
        }

        #football-ball.shooting {
            /* Moves the ball towards the goal area */
            transform: translateX(-50%); /* Maintain horizontal centering */
            bottom: 85%; /* Target Y position (closer to the top). Adjust this percentage for best visual effect. */
        }


        /* Gol Sevinci Metni */
        #goal-celebration-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            font-family: 'Press Start 2P', cursive; /* Pixelated font */
            font-size: 3rem; /* Büyük ve etkili */
            color: var(--yellow);
            text-shadow: 3px 3px 0 var(--navy), -1px -1px 0 var(--navy), 1px -1px 0 var(--navy), -1px 1px 0 var(--navy), 1px 1px 0 var(--navy);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease-out;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
        }

        #goal-celebration-text.animate {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        .header {
            background-color: var(--navy);
            color: var(--white);
            padding: 0.5rem 1rem; /* Biraz daha kompakt */
            text-align: center;
            position: relative;
            z-index: 2; /* Oyun alanının üstünde */
        }
        
        .logo {
            font-size: 1.5rem; /* Biraz küçültüldü */
            font-weight: bold;
            margin-bottom: 0.25rem;
             font-family: 'Press Start 2P', cursive;
        }

        .turn-indicator {
            font-size: 0.9rem; /* Biraz küçültüldü */
            padding: 0.3rem 0.8rem;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .player1-turn {
            background-color: var(--yellow);
            color: var(--navy);
        }

        .player2-turn {
            background-color: var(--orange);
            color: var(--navy);
        }

        .blinking {
            animation: blink-animation 1s infinite;
        }

        @keyframes blink-animation {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; 
            font-weight: bold;
        }
        
        .team {
            padding: 0 0.5rem; 
            flex: 1;
            text-align: center;
        }
        
        .score {
            padding: 0 0.5rem;
            min-width: 1.5rem; 
            text-align: center;
            font-size: 1.3rem; /* Skor biraz daha belirgin */
        }
        
        .main { /* Bu artık game-area içinde kronometre ve kontrolleri tutacak */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Kontrolleri aşağıya ve kronometreyi üste yakın tutar */
            flex-grow: 1;
            padding: 1rem;
            width: 100%;
            z-index: 2; /* Header ile aynı seviyede */
            margin-bottom: 50px; /* Footer için yer bırak */
        }
        
        .stopwatch-container {
            background-color: var(--casio-bg); /* Casio saat kasası */
            padding: 10px;
            border-radius: 8px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3), inset 1px 1px 0px rgba(255,255,255,0.5);
            margin-bottom: 1.5rem; /* Top ile arasında boşluk */
        }

        .stopwatch {
            font-family: 'Rubik Mono One', 'Press Start 2P', monospace; /* Dijital görünümlü font */
            font-size: 3.5rem; /* Boyut ayarlanabilir */
            background-color: var(--casio-screen-bg); /* Casio ekran arka planı */
            color: var(--casio-text); /* Casio ekran yazısı */
            padding: 0.8rem 1.2rem;
            border-radius: 0.3rem;
            border: 2px solid var(--dark-gray);
            min-width: 15rem; /* Min genişlik */
            text-align: center;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.2); /* Hafif ekran parlama efekti */
            box-shadow: inset 2px 2px 3px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        
        .message {
            font-size: 1.3rem; /* Biraz büyütüldü */
            height: 1.8rem; /* Yüksekliği ayarlandı */
            margin: 0.5rem 0; /* Boşluk azaltıldı */
            color: var(--white); /* Beyaz, saha üzerinde daha iyi okunur */
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px var(--navy); /* Okunurluk için gölge */
            min-height: 1.8rem; /* İçerik olmadığında bile yer kaplasın */
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem; /* Mesaj ile arasında boşluk */
        }
        
        .btn {
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 2rem;
            background-color: var(--navy);
            color: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Press Start 2P', cursive; /* Pixelated font for buttons */
            box-shadow: 2px 2px 0px var(--dark-gray);
        }

        .btn:hover {
            transform: translateY(-2px) translateX(-1px);
            box-shadow: 3px 3px 0px var(--dark-gray);
        }

        .btn:disabled {
            background-color: #999;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: 1px 1px 0px #777;
        }
        
        .btn:active {
            transform: translateY(1px) translateX(0.5px);
            box-shadow: 1px 1px 0px var(--dark-gray);
        }
        
        .btn-primary {
            background-color: var(--orange);
        }
        
        .btn-secondary {
            background-color: var(--navy);
        }

        .keyboard-hint {
            font-size: 0.8rem; /* Biraz küçültüldü */
            color: var(--light-gray);
            margin-top: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 1px 1px 1px var(--dark-gray);
        }
        
        .modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En üstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content { 
            background-color: var(--casio-bg); /* Modal da Casio temasına uygun */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }

        .player-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .player-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: var(--casio-text);
            font-family: 'Roboto', sans-serif; /* Radio buton yazıları normal olabilir */
        }
        
        .penalty-modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En üstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .penalty-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .penalty-card { 
            background-color: var(--casio-bg); /* Penaltı kartı da Casio temalı */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        
        .penalty-title {
            font-size: 1.3rem; /* Biraz küçültüldü */
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }
        
        .penalty-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .penalty-status {
            margin-top: 10px;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
        }

        .penalty-directions {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .penalty-direction-btn {
            flex: 1;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            padding: 10px 5px;
            background-color: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .penalty-direction-btn:hover {
            transform: scale(1.05);
        }

        /* Kale Gösterimi (Resim Tabanlı) */
        .goal-representation {
            margin: 15px auto;
            width: 240px; /* Resmin genişliğine göre ayarlanabilir */
            height: 120px; /* Resmin yüksekliğine göre ayarlanabilir */
            position: relative;
            border: 2px solid var(--dark-gray); /* İsteğe bağlı çerçeve */
            background-size: cover; /* Resmi kaplayacak şekilde ayarla */
            background-position: center;
            overflow: hidden; /* Taşan kısımları gizle */
        }

        .goal-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Resmin oranını koruyarak alanı doldurur */
        }

        .clickable-goal-area {
            position: absolute;
            top: 0;
            height: 100%;
            cursor: pointer;
            /* background-color: rgba(255, 0, 0, 0.1); /* Test için görünür yap */
        }

        .clickable-goal-area.left {
            left: 0;
            width: 33%; /* Genişlikler resme göre ayarlanmalı */
        }
        .clickable-goal-area.center {
            left: 33%;
            width: 34%;
        }
        .clickable-goal-area.right {
            left: 67%;
            width: 33%;
        }

        .clickable-goal-area:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .clickable-goal-area.selected {
            background-color: rgba(255, 255, 0, 0.4); /* Daha belirgin sarı */
            border: 2px solid var(--yellow);
        }

        .clickable-goal-area.save-result { /* Gol olduğunda şutun gittiği yer */
            background-color: var(--transparent-green); 
            border: 2px solid var(--football-green);
        }

        .clickable-goal-area.missed-result { /* Kaçtığında şutun gittiği yer */
            background-color: var(--transparent-red);
            border: 2px solid var(--red);
        }

        /* Eski .goal-section stilleri artık gereksiz olabilir veya uyarlanabilir */
        .goal-section {
            /* Bu sınıf artık doğrudan kullanılmıyorsa kaldırılabilir veya yorumlanabilir */
            /* display: flex; ... vb. */
        }

        .goal-section:hover {
            /* background-color: rgba(255,255,255,0.2); */
        }

        .goal-section.selected {
            background-color: rgba(255,255,0,0.3);
        }

        .goal-section.save-result {
            background-color: rgba(0,255,0,0.3);
        }

        .goal-section.missed-result {
            background-color: rgba(255,0,0,0.3);
        }
        
        .game-flash { /* Bu genel ekran flashı olarak kalabilir veya kaldırılabilir */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5; /* Top ve GOOOL yazısının altında */
        }
        
        .flash-goal {
            background-color: var(--transparent-green);
        }
        
        .flash-miss { /* Aut durumu için kullanılabilir */
            background-color: var(--transparent-red);
        }
        
        .stats { /* İstatistikler görünür olmayabilir, isteğe bağlı */
            display: none; /* Şimdilik gizlendi, tasarımda yer kaplamasın */
            justify-content: space-around;
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--light-gray);
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        
        @media (max-width: 600px) {
            .stopwatch {
                font-size: 2.5rem; /* Mobil için daha küçük */
                min-width: 12rem;
                padding: 0.6rem 1rem;
            }
            .stopwatch-container {
                padding: 8px;
            }
            #goal-celebration-text {
                font-size: 2rem;
            }
            .controls {
                flex-direction: column;
            }
            .scoreboard {
                font-size: 0.9rem;
            }
            .team {
                padding: 0 0.2rem;
            }
            .logo {
                font-size: 1.2rem;
            }
            #football-ball {
                font-size: 2rem;
            }
            .goal-area {
                width: 100px;
                height: 50px;
            }
             .message {
                font-size: 1.1rem;
            }
        }

        /* Eklenen Stiller */
        #lobby-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.5rem;
        }

        #lobby-controls input[type="text"] {
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 0.3rem;
            border: 1px solid var(--dark-gray);
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            background-color: var(--light-gray);
            color: var(--casio-text);
        }

        .game-board.hidden, #lobby-controls.hidden {
            display: none !important;
        }
        /* Tribün Stili */
        .spectators {
            position: absolute;
            top: -20px; /* Header'ın biraz üstüne taşabilir veya header'ın hemen altına */
            left: 0;
            width: 100%;
            height: 50px; /* Tribün yüksekliği */
            /* background-color: #555; */ /* Basit bir tribün rengi */
            overflow: hidden;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 0; /* Saha çizgilerinin arkasında, header'ın önünde olabilir */
        }

        .spectator-icon {
            font-size: 1.5rem; /* Taraftar boyutu */
            color: rgba(255, 255, 255, 0.7);
            animation: cheer 1s infinite alternate ease-in-out;
            animation-play-state: paused; /* Başlangıçta duruk */
        }
         .spectator-icon:nth-child(odd) {
            animation-delay: 0.2s;
        }
         .spectator-icon:nth-child(even) {
            animation-delay: 0.5s;
        }

        @keyframes cheer {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        .cheering .spectator-icon {
            animation-play-state: running;
        }

        /* Frikik Stili */
        .freekick-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .freekick-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .freekick-card {
            background-color: var(--casio-bg);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        
        .freekick-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }
        
        .freekick-description {
            margin-top: 10px;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
        }
        
        .power-selection {
            display: flex;
            flex-direction: column;
            margin: 15px 0;
        }
        
        .power-label {
            font-size: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
            margin-bottom: 5px;
        }
        
        .power-options {
            display: flex;
            justify-content: space-between;
        }
        
        .power-btn {
            flex: 1;
            margin: 0 5px;
            padding: 8px 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            background-color: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .power-btn.selected {
            background-color: var(--orange);
            transform: scale(1.05);
        }

        /* Kurallar Modalı */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 250; /* Diğer modalların da üzerinde olabilir */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .rules-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .rules-card {
            background-color: var(--casio-bg);
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            text-align: left;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .rules-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
            text-align: center;
        }

        .rules-content p {
            font-family: 'Roboto', sans-serif;
            color: var(--casio-text);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.8rem;
        }

        .rules-content strong {
            font-family: 'Press Start 2P', cursive;
            color: var(--navy);
        }

        .rules-content ul {
            list-style-position: inside;
            padding-left: 10px;
            margin-bottom: 1rem;
        }

        .rules-content li {
            font-family: 'Roboto', sans-serif;
            color: var(--casio-text);
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
        }

        .rules-close-btn-container {
            text-align: center;
            margin-top: 1.5rem;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ChronoGoal!</div>
        <div class="spectators" id="spectators-area">
            <span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span><span class="spectator-icon">👤</span>
        </div>
        <div class="scoreboard">
            <div class="team" id="player1-name">OYUNCU 1</div>
            <div class="score" id="score-p1">0</div>
            <div>-</div>
            <div class="score" id="score-p2">0</div>
            <div class="team" id="player2-name">OYUNCU 2</div>
        </div>
        <div id="turn-indicator" class="turn-indicator">Sıra Oyuncuda</div>
        <button class="btn btn-secondary" id="rules-btn" style="position: absolute; top: 10px; right: 10px; padding: 0.5rem 1rem; font-size: 0.8rem;">Kurallar</button>
    </div>

    <div class="game-area">
        <div id="lobby-controls">
            <input type="text" id="room-code-input" placeholder="Oda Kodu Girin">
            <button id="join-room-btn" class="btn btn-primary">Odaya Katıl</button>
            <p style="color: var(--white); font-family: 'Press Start 2P', cursive; margin: 0.5rem 0;">veya</p>
            <button id="create-room-btn" class="btn btn-secondary">Yeni Oda Oluştur</button>
        </div>

        <div class="game-board hidden"> <!-- Oyun alanı başlangıçta gizli -->
        <div class="goal-area"></div>
        <div id="football-ball">⚽</div>
        <div id="goal-celebration-text">GOOOOL!</div>
            <div class="message" id="message">Kim Başlasın?</div>

        <div class="main"> <!-- Kronometre ve kontroller bu alanda -->
            <div class="stopwatch-container">
                <div class="stopwatch" id="stopwatch">00.00</div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="toggle-btn" aria-label="Başlat veya Durdur" disabled>Başlat</button>
                <button class="btn btn-secondary" id="reset-btn" aria-label="Yeniden Başlat" disabled>Sıfırla</button>
            </div>
                <div class="keyboard-hint">P1: Boşluk, P2: Enter (Online modda sadece aktif oyuncu)</div>
            </div>
        </div>
    </div>
    
    <div class="stats"> <!-- İstatistikler (isteğe bağlı, şu an display: none) -->
        <div>Goller: <span id="goals">0</span></div>
        <div>Penaltılar: <span id="penalties">0</span></div>
        <div>Kaçan Penaltılar: <span id="misses">0</span></div>
    </div>

    <div id="start-player-modal" class="modal">
        <div class="modal-content">
            <h2>KİM BAŞLASIN?</h2>
            <div class="player-options">
                <label><input type="radio" name="startPlayer" value="1" checked> Oyuncu 1</label>
                <label><input type="radio" name="startPlayer" value="2"> Oyuncu 2</label>
            </div>
            <button id="confirm-start-player-btn" class="btn btn-primary">ONAYLA</button>
        </div>
    </div>
    
    <div class="penalty-modal" id="penalty-modal">
        <div class="penalty-card">
            <div class="penalty-title" id="penalty-title-text">PENALTI!</div>
            <div id="penalty-description" class="penalty-status">Yön seçin:</div>
            
            <div id="goal-representation" class="goal-representation">
                <img src="images/kale.png" alt="Kale" class="goal-image">
                <div class="clickable-goal-area left" data-direction="left"></div>
                <div class="clickable-goal-area center" data-direction="center"></div>
                <div class="clickable-goal-area right" data-direction="right"></div>
            </div>
            
            <div id="penalty-shooter-controls" class="penalty-options">
                <button class="btn btn-primary" id="penalty-shoot-btn" aria-label="Şut Çek">ŞUT ÇEK</button>
            </div>

            <div id="penalty-keeper-controls" class="penalty-options" style="display: none;">
                <button class="btn btn-primary" id="penalty-save-btn" aria-label="Kurtar">KURTAR</button>
            </div>
        </div>
    </div>
    
    <div class="freekick-modal" id="freekick-modal">
        <div class="freekick-card">
            <div class="freekick-title" id="freekick-title-text">FRİKİK!</div>
            <div id="freekick-description" class="freekick-description">Yön ve güç seçin:</div>
            
            <div id="freekick-goal-representation" class="goal-representation">
                 <img src="images/kale.png" alt="Kale" class="goal-image">
                <div class="clickable-goal-area left" data-direction="left"></div>
                <div class="clickable-goal-area center" data-direction="center"></div>
                <div class="clickable-goal-area right" data-direction="right"></div>
            </div>
            
            <div id="freekick-shooter-controls">
                <div class="power-selection">
                    <div class="power-label">ŞUT GÜCÜ:</div>
                    <div class="power-options">
                        <button class="power-btn" data-power="low">DÜŞÜK</button>
                        <button class="power-btn" data-power="medium">ORTA</button>
                        <button class="power-btn" data-power="high">YÜKSEK</button>
                    </div>
                </div>
                
            <div class="penalty-options">
                    <button class="btn btn-primary" id="freekick-shoot-btn" aria-label="Şut Çek">ŞUT ÇEK</button>
                </div>
            </div>
            
            <div id="freekick-keeper-controls" style="display: none;">
                <div class="power-selection">
                    <div class="power-label">KALEDE POZİSYON:</div>
                    <div class="power-options">
                        <button class="power-btn" data-position="low">ALÇAK</button>
                        <button class="power-btn" data-position="medium">ORTA</button>
                        <button class="power-btn" data-position="high">YÜKSEK</button>
                    </div>
                </div>
                
                <div class="penalty-options">
                    <button class="btn btn-primary" id="freekick-save-btn" aria-label="Kurtar">KURTAR</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-flash" id="game-flash"></div>
    
    <audio id="goal-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="whistle-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2032/2032-preview.mp3" type="audio/mpeg">
    </audio>
     <audio id="aut-sound" preload="auto"> <!-- Aut sesi için eklendi -->
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-jumping-in-a-video-game-2043.mp3" type="audio/mpeg">
    </audio>
    
    <div class="rules-modal" id="rules-modal">
        <div class="rules-card">
            <div class="rules-title">OYUN KURALLARI</div>
            <div class="rules-content">
                <p><strong>AMAÇ:</strong> Rakibinden daha fazla gol atarak veya belirlenen tur sayısı sonunda daha önde olarak maçı kazanmak!</p>
                
                <p><strong>NASIL OYNANIR:</strong></p>
                <ul>
                    <li>Sıra sana geldiğinde, kronometreyi <strong>BAŞLAT</strong> (Boşluk veya Enter tuşu ile de kontrol edebilirsin).</li>
                    <li>Kronometreyi doğru zamanda <strong>DURDUR</strong>. Durdurduğun salise (saniyenin yüzde biri) sonucu belirler!</li>
                </ul>

                <p><strong>SONUÇLAR:</strong></p>
                <ul>
                    <li><strong>Salise 00:</strong> GOOOOL! ⚽ Rakip kaleye gol atarsın.</li>
                    <li><strong>Salise 90-99:</strong> PENALTI! 🎯 Penaltı atışı kazanırsın. Yön seçerek şutunu çekersin, rakibin de kurtarmak için yön seçer.</li>
                    <li><strong>Salise 80-89:</strong> FRİKİK! 🥅 Frikik kazanırsın. Yön ve şut gücünü seçersin, rakibin de kurtarmak için yön ve kaleci pozisyonunu belirler.</li>
                    <li><strong>Diğer Saliseler:</strong> AUT! 💨 Top dışarı çıkar, sıra rakibe geçer.</li>
                </ul>

                <p><strong>ZAMAN AŞIMLARI (DİKKAT!):</strong></p>
                <ul>
                    <li>Kronometreyi başlatmak için <strong>5 saniyen</strong> var. Başlatmazsan, sıra rakibe geçer ve ortak süreye 5 saniye eklenir.</li>
                    <li>Kronometreyi başlattıktan sonra durdurmak için <strong>3 saniyen</strong> var. Durdurmazsan, sıra rakibe geçer ve ortak süreye 3 saniye eklenir.</li>
                </ul>

                <p><strong>KAZANMA KOŞULLARI:</strong></p>
                <ul>
                    <li><strong>Skor:</strong> Bir oyuncu <strong>3 gole</strong> ulaşırsa maçı kazanır.</li>
                    <li><strong>Süre/Tur:</strong> Toplam <strong>10 hamle</strong> (her oyuncu 5'er hamle) tamamlandığında, daha fazla golü olan oyuncu kazanır. Beraberlik durumunda maç berabere biter.</li>
                </ul>
                 <p>İyi eğlenceler!</p>
            </div>
            <div class="rules-close-btn-container">
                <button class="btn btn-primary" id="close-rules-modal-btn">KAPAT</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK'larını import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        // ÖNEMLİ: Firebase projenizin yapılandırma bilgilerini buraya girin!
        const firebaseConfig = {
            apiKey: "AIzaSyAad-afEL6c7S3Y4RJuGwoFxgPsx81k_D0",
            authDomain: "chronogoalonline.firebaseapp.com",
            databaseURL: "https://chronogoalonline-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chronogoalonline",
            storageBucket: "chronogoalonline.firebasestorage.app",
            messagingSenderId: "688627066429",
            appId: "1:688627066429:web:0c38b3e132c579668a2c54",
            measurementId: "G-S0K2X6DB15"
        };

        // Firebase'i başlat
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global Değişkenler (Firebase entegrasyonu için)
        let currentGameId = null;
        let localPlayerNumber = null; // Bu istemcinin oyuncu numarası (1 veya 2)
        let gameRoomCode = null; // Kullanıcıya gösterilen oda kodu
        let selectedPenaltyDirection = null; // Penaltı için seçilen yön
        let selectedFreekickDirection = null; // Frikik için seçilen yön
        let selectedFreekickPower = null; // Frikik için seçilen güç
        let selectedKeeperPosition = null; // Kaleci için seçilen pozisyon

        // Oyun değişkenleri (Mevcutlar korunuyor, bazıları Firebase'den yönetilecek)
        let interval;
        let running = false;
        let milliseconds = 0;
        // Diğer oyun state'leri (isPenalty, penaltyGuess, scores, currentPlayer, gameStarted) Firebase'den yönetilecek.
        
        let turnTimerId = null; // Host için zaman aşımı sayacını tutar
        let liveUpdateIntervalId = null; // Aktif oyuncunun canlı zamanını Firebase'e periyodik yazma interval'i
        
        // DOM elementleri
        const stopwatchElem = document.getElementById('stopwatch');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageElem = document.getElementById('message');
        
        const penaltyModal = document.getElementById('penalty-modal');
        const penaltyTitleTextElem = document.getElementById('penalty-title-text');
        const penaltyDescriptionElem = document.getElementById('penalty-description');
        const penaltyShooterControls = document.getElementById('penalty-shooter-controls');
        const penaltyKeeperControls = document.getElementById('penalty-keeper-controls');
        const penaltyShootBtn = document.getElementById('penalty-shoot-btn');
        const penaltySaveBtn = document.getElementById('penalty-save-btn');
        const goalRepresentation = document.getElementById('goal-representation');
        
        const scoreP1Elem = document.getElementById('score-p1');
        const scoreP2Elem = document.getElementById('score-p2');
        
        const gameFlash = document.getElementById('game-flash');
        
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');
        const autSound = document.getElementById('aut-sound');

        // Frikik modalı elementleri
        const freekickModal = document.getElementById('freekick-modal');
        const freekickTitleTextElem = document.getElementById('freekick-title-text');
        const freekickDescriptionElem = document.getElementById('freekick-description');
        const freekickShooterControls = document.getElementById('freekick-shooter-controls');
        const freekickKeeperControls = document.getElementById('freekick-keeper-controls');
        const freekickShootBtn = document.getElementById('freekick-shoot-btn');
        const freekickSaveBtn = document.getElementById('freekick-save-btn');
        const freekickGoalRepresentation = document.getElementById('freekick-goal-representation');

        const turnIndicatorElem = document.getElementById('turn-indicator');
        const footballBallElem = document.getElementById('football-ball');
        const goalCelebrationTextElem = document.getElementById('goal-celebration-text');
        const spectatorsArea = document.getElementById('spectators-area');

        const lobbyControls = document.getElementById('lobby-controls');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const gameBoard = document.querySelector('.game-board');

        // Kurallar Modalı Elemanları
        const rulesBtn = document.getElementById('rules-btn');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesModalBtn = document.getElementById('close-rules-modal-btn');

        // Host tarafında çalışacak fonksiyon
        async function checkGameOverConditionOnHost(gameId, currentSnapshotData) {
            // currentSnapshotData = { player1Score, player2Score, currentTurnForCheck, gameSettings }
            if (localPlayerNumber !== 1) return false;
        
            const p1Score = currentSnapshotData.player1Score;
            const p2Score = currentSnapshotData.player2Score;
            const currentTotalTurns = currentSnapshotData.currentTurnForCheck;
            const maxScore = currentSnapshotData.gameSettings?.maxScore || 3;
            const maxTurns = currentSnapshotData.gameSettings?.maxTurns || 10; // Toplam hamle sayısı (her oyuncu maxTurns/2 hamle)
        
            let gameOver = false;
            let winner = null; // 1, 2, or 'draw'
            let endMessage = "";
        
            if (p1Score >= maxScore) {
                gameOver = true;
                winner = 1;
                endMessage = `MAÇ BİTTİ! Oyuncu 1 kazandı! Skor: ${p1Score}-${p2Score}`;
            } else if (p2Score >= maxScore) {
                gameOver = true;
                winner = 2;
                endMessage = `MAÇ BİTTİ! Oyuncu 2 kazandı! Skor: ${p1Score}-${p2Score}`;
            } else if (currentTotalTurns >= maxTurns) {
                gameOver = true;
                if (p1Score > p2Score) {
                    winner = 1;
                    endMessage = `MAÇ BİTTİ! Süre doldu. Oyuncu 1 kazandı! Skor: ${p1Score}-${p2Score}`;
                } else if (p2Score > p1Score) {
                    winner = 2;
                    endMessage = `MAÇ BİTTİ! Süre doldu. Oyuncu 2 kazandı! Skor: ${p1Score}-${p2Score}`;
                } else {
                    winner = 'draw';
                    endMessage = `MAÇ BİTTİ! Süre doldu. Berabere! Skor: ${p1Score}-${p2Score}`;
                }
            }
        
            if (gameOver) {
                const gameRef = ref(database, 'games/' + gameId);
                const updatesToFirebase = {
                    gameState: 'game_over',
                    winnerPlayer: winner,
                    messageToPlayers: endMessage,
                    lastActionTimestamp: serverTimestamp(),
                    'player1/score': p1Score, // Skoru ve turu da game_over ile birlikte yazalım
                    'player2/score': p2Score,
                    currentTurn: currentTotalTurns,
                };
                await update(gameRef, updatesToFirebase);
                console.log("Oyun bitti (checkGameOverConditionOnHost). Kazanan: ", winner, " Mesaj: ", endMessage);
                return true; // Oyun bitti
            }
            return false; // Oyun devam ediyor
        }

        function initializeAppUI() {
            lobbyControls.classList.remove('hidden');
            gameBoard.classList.add('hidden');
            messageElem.classList.add('hidden');
            toggleBtn.disabled = true;
            resetBtn.disabled = true;
            
            // UI elemanlarını kontrol et
            console.log("Penalty Modal Element:", penaltyModal ? "OK" : "YOK");
            console.log("Freekick Modal Element:", freekickModal ? "OK" : "YOK");
            
            // Daha detaylı frikik modalı eleman kontrolü (önceki logun devamı gibi)
            console.log("Frikik modalı detayları:", {
                modal: freekickModal ? "OK" : "YOK",
                title: freekickTitleTextElem ? "OK" : "YOK",
                description: freekickDescriptionElem ? "OK" : "YOK",
                shooterControls: freekickShooterControls ? "OK" : "YOK",
                keeperControls: freekickKeeperControls ? "OK" : "YOK",
                shootBtn: freekickShootBtn ? "OK" : "YOK",
                saveBtn: freekickSaveBtn ? "OK" : "YOK",
                goalRepresentation: freekickGoalRepresentation ? "OK" : "YOK"
            });
        }
        
        async function createGameRoom() {
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;
            try {
                gameRoomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                localPlayerNumber = 1;
                currentGameId = gameRoomCode;

                const initialGameData = {
                    player1: { id: "player1_host", name: "Oyuncu 1", score: 0, lastStopTimeMs: null, penaltyChoice: null },
                    currentPlayer: 1,
                    gameState: 'waiting_for_player2',
                    sharedStopwatchMs: 0,
                    liveTimeMs: 0, // Eklendi: Aktif oyuncunun canlı zamanı
                    gameSettings: {
                        maxTurns: 10, // Her oyuncu 5 hamle, toplam 10 hamle
                        maxScore: 3,  // 3 gole ulaşan kazanır
                        turnTimeoutSeconds: 5,
                        stopTimeoutSeconds: 3
                    },
                    currentTurn: 0,
                    lastActionTimestamp: serverTimestamp(),
                    messageToPlayers: `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`,
                    isBotGame: false,
                };

                await set(ref(database, 'games/' + currentGameId), initialGameData);
                
                lobbyControls.classList.add('hidden');
                gameBoard.classList.remove('hidden');
                messageElem.classList.remove('hidden');
                messageElem.textContent = `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`;
                console.log(`Oda oluşturuldu: ${currentGameId}`);
                listenToGameUpdates(currentGameId);

            } catch (error) {
                console.error("Oda oluşturulamadı:", error);
                messageElem.classList.remove('hidden');
                messageElem.textContent = "Hata: Oda oluşturulamadı. Konsolu kontrol edin.";
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        async function joinGameRoom() {
            const inputRoomCode = roomCodeInput.value.toUpperCase().trim();
            if (!inputRoomCode) {
                alert("Lütfen bir oda kodu girin."); 
                return;
            }

            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;

            try {
                const gameRefPath = 'games/' + inputRoomCode;
                const gameRefInstance = ref(database, gameRefPath);
                const snapshot = await get(gameRefInstance);

                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    if (gameData.player2) {
                        alert("Bu oda dolu veya zaten bir oyun devam ediyor.");
                        console.log("Oda dolu:", inputRoomCode);
                        createRoomBtn.disabled = false;
                        joinRoomBtn.disabled = false;
                        roomCodeInput.disabled = false;
                        return;
                    }
                    if (gameData.gameState !== 'waiting_for_player2') {
                         alert("Bu odaya şu an katılamazsınız (oyun başlamış olabilir).");
                         createRoomBtn.disabled = false;
                         joinRoomBtn.disabled = false;
                         roomCodeInput.disabled = false;
                         return;
                    }

                    localPlayerNumber = 2;
                    currentGameId = inputRoomCode;
                    gameRoomCode = inputRoomCode;

                    const updates = {};
                    updates[`player2`] = { id: "player2_guest", name: "Oyuncu 2", score: 0, lastStopTimeMs: null, penaltyChoice: null };
                    updates[`gameState`] = 'player1_turn'; 
                    updates[`currentPlayer`] = 1; 
                    updates[`messageToPlayers`] = 'Oyuncular hazır! Sıra Oyuncu 1\'de.';
                    updates[`lastActionTimestamp`] = serverTimestamp();
                    
                    await update(gameRefInstance, updates);

                    console.log(`Odaya katınıldı: ${currentGameId}`);
                    lobbyControls.classList.add('hidden');
                    gameBoard.classList.remove('hidden');
                    messageElem.classList.remove('hidden');
                    listenToGameUpdates(currentGameId);

            } else {
                    alert("Oda bulunamadı. Kodu kontrol edin.");
                    console.log("Oda bulunamadı:", inputRoomCode);
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                }
            } catch (error) {
                console.error("Odaya katılırken hata:", error);
                alert("Hata: Odaya katılamadı. Konsolu kontrol edin.");
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        function listenToGameUpdates(gameId) {
            const gameRefPath = 'games/' + gameId;
            const gameRefInstance = ref(database, gameRefPath);

            onValue(gameRefInstance, async (snapshot) => { // Fonksiyonu async yaptık
                if (!snapshot.exists()) {
                    console.warn(`Dinlenen oda (${gameId}) artık mevcut değil.`);
                    alert("Oda bağlantısı kesildi veya oda kapandı.");
                    lobbyControls.classList.remove('hidden');
                    gameBoard.classList.add('hidden');
                    messageElem.classList.add('hidden');
                    currentGameId = null;
                    localPlayerNumber = null;
                    gameRoomCode = null;
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                    roomCodeInput.value = '';
                    if (turnTimerId) clearTimeout(turnTimerId); // Aktif timer varsa temizle
                    if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId); // Aktif timer varsa temizle
                    return;
                }

                const gameData = snapshot.val();
                console.log("Oyun verisi güncellendi:", gameData);
                if (!gameData) return;

                // --- Stop local timer if it's not this client's turn to actively time ---
                if (running &&
                    (localPlayerNumber !== gameData.currentPlayer || !gameData.gameState.endsWith(`_timing`)) &&
                    gameData.gameState !== `player${localPlayerNumber}_stopped`) {
                    clearInterval(interval);
                    running = false;
                    if (liveUpdateIntervalId) { // Canlı güncelleme interval'ini de temizle
                        clearInterval(liveUpdateIntervalId);
                        liveUpdateIntervalId = null;
                    }
                    toggleBtn.textContent = 'Başlat';
                    if (localPlayerNumber !== gameData.currentPlayer && gameData.gameState.endsWith('_turn')) {
                        toggleBtn.disabled = true; // Sıra bende değilse buton pasif olmalı
                    }
                }

                // --- Host specific logic block ---
                if (localPlayerNumber === 1) {
                    if (turnTimerId) {
                        clearTimeout(turnTimerId);
                        turnTimerId = null;
                    }

                    if (gameData.gameState && gameData.gameState.endsWith('_stopped') && gameData.lastActionDetail) {
                        const lastPlayer = gameData.lastActionDetail.player;
                        // Oyuncu zaten sonucu işledi ve sırayı devretti mi kontrolü
                        // Bu, özellikle _aiming durumuna geçildikten sonra _stopped'un tekrar işlenmesini engeller
                        const expectedNextPlayerForNormalTurn = lastPlayer === 1 ? 2 : 1;
                        const isAlreadyProcessedAndTurnedOver = gameData.currentPlayer === expectedNextPlayerForNormalTurn && gameData.gameState === `player${expectedNextPlayerForNormalTurn}_turn`;
                        const isSpecialAimingState = gameData.gameState && (gameData.gameState.startsWith('penalty_') || gameData.gameState.startsWith('freekick_')) && gameData.gameState.endsWith('_aiming');

                        // Sadece host, ve eğer bu _stopped olayı henüz _aiming gibi bir özel duruma veya bir sonraki oyuncunun normal turuna dönüştürülmemişse işle.
                        if (gameData.lastActionDetail.player === localPlayerNumber || // Eğer durduran bu host ise
                           (gameData.lastActionDetail.player !== localPlayerNumber && !isAlreadyProcessedAndTurnedOver && !isSpecialAimingState && gameData.gameState === `player${gameData.lastActionDetail.player}_stopped` ) // Ya da durduran diğer oyuncuysa ve henüz sonuç işlenmemişse
                        ) {
                            // Bu _stopped olayını işleyip işlemediğimizi takip etmek için basit bir flag
                            // Bu, özellikle host'un kendi _stopped olayını birden fazla kez tetiklemesini önlemek için değil,
                            // daha çok diğer oyuncu durdurduğunda host'un bunu sadece bir kez işlemesini sağlamak için.
                            // Ancak, en güvenli yol `lastActionTimestamp` veya `currentTurn` gibi daha sağlam bir belirteç kullanmaktır.
                            // Şimdilik, `gameData.lastActionDetail.processedByHost` gibi bir alan ekleyebiliriz.
                            // VEYA: Host'un sadece kendi playerX_stopped mesajını değil, diğer oyuncunun playerY_stopped mesajını da işlemesi gerekir.
                            // Oyuncunun kendi _stopped mesajını işleme mantığı zaten var.
                            // Eğer lastActionDetail.player mevcut host değilse ve gameState hala playerX_stopped ise host bunu işlemeli.

                            // Eğer bu client (host) zaten bu sonucu işlemişse (örn: state'i _aiming'e çevirmişse), tekrar işleme.
                            // Bunun için en iyi kontrol, Firebase'deki gameState'in beklenen bir sonraki duruma (örn: playerY_turn veya penalty_playerX_aiming)
                            // zaten geçip geçmediğidir.
                            if (!(gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_result') || (gameData.gameState.endsWith('_turn') && gameData.currentPlayer !== lastPlayer ))) {
                                const centiseconds = gameData.lastActionDetail.centiseconds;
                                const timeMs = gameData.lastActionDetail.timeMs;
                                let outcomeMessage = "";
                                let newGameState = "";
                                const nextPlayer = lastPlayer === 1 ? 2 : 1;
                                let scoreUpdates = {};
                                let penaltyDetailsUpdate = null;

                                // Skorları belirle
                                if (centiseconds === 0) { // F3: GOL
                                    scoreUpdates[`player${lastPlayer}/score`] = (gameData[`player${lastPlayer}`]?.score || 0) + 1;
                                }
                                // Penaltı/Frikik için skor güncellemesi turnOverAfterSpecialAction içinde yapılır.

                                // Potansiyel yeni skorlar ve tur sayısı
                                const potentialP1Score = gameData.player1?.score + (scoreUpdates['player1/score'] ? 1 : 0) || gameData.player1?.score || 0;
                                const potentialP2Score = gameData.player2?.score + (scoreUpdates['player2/score'] ? 1 : 0) || gameData.player2?.score || 0;
                                const nextTurnNumber = (gameData.currentTurn || 0) + 1;

                                // Oyun bitişini kontrol et (güncellenmiş skorlar ve yeni tur sayısı ile)
                                const isGameOver = await checkGameOverConditionOnHost(currentGameId, {
                                    player1Score: potentialP1Score,
                                    player2Score: potentialP2Score,
                                    currentTurnForCheck: nextTurnNumber,
                                    gameSettings: gameData.gameSettings
                                });

                                if (isGameOver) {
                                    console.log("Host: Oyun bittiği için (_stopped sonrası) normal durum güncellemesi yapılmadı.");
                                    // checkGameOverConditionOnHost zaten Firebase'i güncelledi ve skoru/turu da yazdı.
                                    // Bu yüzden burada ek bir Firebase güncellemesi yapmaya gerek yok.
                                } else {
                                    // Oyun bitmediyse, sonucu işle ve Firebase'i güncelle.
                                    if (centiseconds === 0) { // F3: GOL
                                        outcomeMessage = `GOOOOL! Oyuncu ${lastPlayer} attı! (Süre: ${formatTime(timeMs)})`;
                                        newGameState = `player${nextPlayer}_turn`;
                                        if (goalSound) goalSound.play().catch(e => console.log("Gol sesi oynatılamadı:", e));
                                    } else if (centiseconds >= 90 && centiseconds <= 99) { // F4: PENALTI
                                        outcomeMessage = `PENALTI! Oyuncu ${lastPlayer} kullanacak... (Süre: ${formatTime(timeMs)})`;
                                        newGameState = `penalty_player${lastPlayer}_aiming`;
                                        penaltyDetailsUpdate = { shooter: lastPlayer, type: 'penalty', status: 'aiming' };
                                        if (whistleSound) whistleSound.play().catch(e => console.log("Düdük sesi oynatılamadı:", e));
                                    } else if (centiseconds >= 80 && centiseconds <= 89) { // F5: FRİKİK
                                        outcomeMessage = `FRİKİK! Oyuncu ${lastPlayer} kullanacak... (Süre: ${formatTime(timeMs)})`;
                                        newGameState = `freekick_player${lastPlayer}_aiming`;
                                        penaltyDetailsUpdate = { shooter: lastPlayer, type: 'freekick', status: 'aiming' };
                                        if (whistleSound) whistleSound.play().catch(e => console.log("Düdük sesi oynatılamadı:", e));
                                        console.log("Frikik durumu oluştu (host):", newGameState, penaltyDetailsUpdate);
                                    } else { // AUT
                                        outcomeMessage = `AUT! Sıra Oyuncu ${nextPlayer}\'de. (Durdurulan: ${formatTime(timeMs)})`;
                                        newGameState = `player${nextPlayer}_turn`;
                                    }
    
                                    const updates = {
                                        currentPlayer: newGameState.includes('_turn') ? nextPlayer : lastPlayer,
                                        gameState: newGameState,
                                        sharedStopwatchMs: timeMs,
                                        liveTimeMs: timeMs,
                                        messageToPlayers: outcomeMessage,
                                        lastActionTimestamp: serverTimestamp(),
                                        currentTurn: nextTurnNumber, // nextTurnNumber burada kullanılıyor
                                        ...scoreUpdates, // scoreUpdates burada kullanılıyor
                                        penaltyDetails: penaltyDetailsUpdate
                                    };
                                    if (penaltyDetailsUpdate === null && gameData.penaltyDetails) {
                                        updates.penaltyDetails = null;
                                    }
    
                                    update(ref(database, 'games/' + currentGameId), updates)
                                        .then(() => {
                                            console.log(`Host: Oyuncu ${lastPlayer} aksiyonu DEĞERLENDİRİLDİ (ANA BLOK). Yeni durum: ${newGameState}. Sonuç: ${outcomeMessage}`);
                                        })
                                        .catch(error => {
                                            console.error("Host: Oyun durumu güncellenirken hata (ANA BLOK):", error);
                                        });
                                }
                            } else {
                                console.log(`Host: Oyuncu ${lastPlayer} aksiyonu zaten işlenmiş veya oyun ilerlemiş. Mevcut durum: ${gameData.gameState}, Mevcut oyuncu: ${gameData.currentPlayer}`);
                            }
                        }
                    } else if (gameData.gameState && gameData.player1 && gameData.player2) { // Zaman aşımı kurma mantığı
                        const currentTurnForTimeout = gameData.currentTurn;
                        let timeoutSettings = 5;
                        let playerWhoseTurnItIs = null;
                        let expectedStateForTimeout = gameData.gameState;

                        if (gameData.gameState.endsWith('_turn')) {
                            playerWhoseTurnItIs = parseInt(gameData.gameState.charAt(6));
                            timeoutSettings = gameData.gameSettings?.turnTimeoutSeconds || 5;
                        } else if (gameData.gameState.endsWith('_timing')) {
                            playerWhoseTurnItIs = parseInt(gameData.gameState.charAt(6));
                            timeoutSettings = gameData.gameSettings?.stopTimeoutSeconds || 3;
                        } else if (gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_waiting') || gameData.gameState.endsWith('_result')) {
                             playerWhoseTurnItIs = null; // Özel durumlarda (penaltı/frikik adımları) ana zaman aşımı sayacı kurulmaz.
                        }


                        if (playerWhoseTurnItIs !== null) {
                            const timeoutMs = timeoutSettings * 1000;
                            turnTimerId = setTimeout(() => {
                                handleTurnTimeout(playerWhoseTurnItIs, currentTurnForTimeout, expectedStateForTimeout);
                            }, timeoutMs);
                        }
                    }
                } // --- End of Host specific logic block ---

                // Update shared stopwatch display based on state (All Clients)
                if (gameData.gameState && gameData.gameState.endsWith('_timing') && localPlayerNumber !== gameData.currentPlayer) {
                    stopwatchElem.textContent = formatTime(gameData.liveTimeMs || gameData.sharedStopwatchMs || 0);
                } else if (gameData.gameState && (gameData.gameState.endsWith('_turn') || gameData.gameState === 'waiting_for_player2')) {
                    stopwatchElem.textContent = formatTime(gameData.sharedStopwatchMs || 0);
                } else if (gameData.gameState && gameData.gameState.endsWith('_stopped') && gameData.lastActionDetail) {
                     // Eğer _stopped durumu ise ve bu client o anki aktif oyuncu değilse, lastActionDetail'den göster.
                     // Aktif oyuncu ise, kendi lokal sayacından gösterir (bu blok güncellenene kadar)
                    if (localPlayerNumber !== gameData.lastActionDetail.player) {
                        stopwatchElem.textContent = formatTime(gameData.lastActionDetail.timeMs || 0);
                    }
                }

                scoreP1Elem.textContent = gameData.player1?.score !== undefined ? gameData.player1.score : 0;
                scoreP2Elem.textContent = gameData.player2?.score !== undefined ? gameData.player2.score : 0;

                document.getElementById('player1-name').textContent = gameData.player1?.name || 'OYUNCU 1';
                document.getElementById('player2-name').textContent = gameData.player2?.name || (gameData.isBotGame ? 'BOT' : (gameData.gameState === 'waiting_for_player2' ? 'BEKLENİYOR' : 'OYUNCU 2'));

                if(messageElem.classList.contains('hidden')) messageElem.classList.remove('hidden');
                messageElem.textContent = gameData.messageToPlayers || '';

                const turnIndicatorClasses = ['player1-turn', 'player2-turn', 'blinking'];
                turnIndicatorElem.classList.remove(...turnIndicatorClasses);

                if (gameData.gameState === 'waiting_for_player2' && localPlayerNumber === 1) {
                    turnIndicatorElem.textContent = `Oda: ${gameRoomCode} - Rakip bekleniyor...`;
                } else if (gameData.gameState === 'game_over') {
                    turnIndicatorElem.textContent = "MAÇ BİTTİ!";
                } else if (gameData.player1 && gameData.player2) {
                    turnIndicatorElem.textContent = `Sıra: Oyuncu ${gameData.currentPlayer}`;
                    const currentTurnPlayerClass = gameData.currentPlayer === 1 ? 'player1-turn' : 'player2-turn';
                    const otherPlayerClass = gameData.currentPlayer === 1 ? 'player2-turn' : 'player1-turn';
                    turnIndicatorElem.classList.add(currentTurnPlayerClass);
                    turnIndicatorElem.classList.remove(otherPlayerClass);
                    if (localPlayerNumber === gameData.currentPlayer) {
                        turnIndicatorElem.textContent += " (SEN)";
                    }
                } else {
                    turnIndicatorElem.textContent = "Oyuncular bekleniyor...";
                }

                if (gameData.gameState === 'waiting_for_player2' || !gameData.player2 ||
                    gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_waiting') || gameData.gameState.endsWith('_result') || // Penaltı/Frikik adımlarında ana başlatma butonu pasif
                    gameData.gameState === 'game_over') {
                    toggleBtn.disabled = true;
                } else {
                    toggleBtn.disabled = !(localPlayerNumber === gameData.currentPlayer &&
                        (gameData.gameState === `player${localPlayerNumber}_turn` ||
                            gameData.gameState === `player${localPlayerNumber}_timing`));
                }
                resetBtn.disabled = true;

                // Özel oyun durumları (Penaltı/Frikik) için UI yönetimi
                const handleSpecialGameState = () => {
                    // Önce tüm modalları kapat (her UI güncellemesinde temiz bir başlangıç için)
                    // Ancak bu, modal içindeki seçimlerin kaybolmasına neden olabilir.
                    // Bunun yerine, sadece gameState değiştiğinde veya modalın kapanması gerektiğinde kapatmak daha iyi olabilir.
                    // Şimdilik mevcut haliyle bırakalım, ancak _result sonrası otomatik kapanma zaten var.
                    // togglePenaltyModal(false);
                    // toggleFreekickModal(false);

                    if (!gameData.gameState) return;
                    const gameState = gameData.gameState;
                     // console.log(\"Özel durum kontrolü için gameState:\", gameState); // Çok sık log basar, dikkat!

                    const isPenaltyState = gameState.startsWith('penalty_player');
                    const isFreekickState = gameState.startsWith('freekick_player');

                    if (!isPenaltyState && !isFreekickState) {
                        // Eğer penaltı veya frikik durumu değilse, açık olabilecek modalları kapat.
                        if (penaltyModal.classList.contains('active')) togglePenaltyModal(false);
                        if (freekickModal.classList.contains('active')) toggleFreekickModal(false);
                return;
            }
                    
                    let actionType = isPenaltyState ? 'penalty' : 'freekick';
                    let shooter = gameData.penaltyDetails?.shooter;

                    if (!shooter && gameData.penaltyDetails) { // penaltyDetails var ama shooter yoksa (beklenmedik)
                        console.warn(`[${gameState}] Shooter penaltyDetails içinde (${actionType}) bulunamadı ancak penaltyDetails objesi var. gameState string'inden parse ediliyor.`);
                        try { shooter = parseInt(gameState.split('_')[1].charAt(6)); } catch (e) { /* ignore */ }
                    } else if (!gameData.penaltyDetails) { // penaltyDetails objesi hiç yoksa (örn. host henüz oluşturmadı)
                         console.warn(`[${gameState}] penaltyDetails objesi henüz yok (${actionType}). gameState string'inden shooter parse ediliyor.`);
                         try { shooter = parseInt(gameState.split('_')[1].charAt(6)); } catch (e) { /* ignore */ }
                         // Eğer host ise ve shooter bulunduysa ama penaltyDetails hala yoksa, oluştur.
                         if (localPlayerNumber === 1 && shooter && !gameData.penaltyDetails) {
                            console.log(`[${gameState}] Host, eksik penaltyDetails için (${actionType}) düzeltme deniyor. Shooter: ${shooter}`);
                            update(ref(database, 'games/' + currentGameId), {
                                penaltyDetails: { shooter: shooter, type: actionType, status: gameState.endsWith('_aiming') ? 'aiming' : (gameState.endsWith('_waiting') ? 'shooting': 'unknown') }
                            });
                            return; // Bir sonraki update'te işlenecek
                         }
                    }


                    if (!shooter) {
                        console.error(`[${gameState}] ${actionType} için shooter kesin olarak bulunamadı. Detaylar:`, gameData.penaltyDetails);
                        return;
                    }

                    // console.log(`[${gameState}] ${actionType} shooter işleniyor: ${shooter}`);
                    const keeper = shooter === 1 ? 2 : 1;
                    let modalToToggle = isPenaltyState ? togglePenaltyModal : toggleFreekickModal;
                    let titleElem = isPenaltyState ? penaltyTitleTextElem : freekickTitleTextElem;
                    let descriptionElem = isPenaltyState ? penaltyDescriptionElem : freekickDescriptionElem;
                    let shooterControls = isPenaltyState ? penaltyShooterControls : freekickShooterControls;
                    let keeperControls = isPenaltyState ? penaltyKeeperControls : freekickKeeperControls;
                    let goalRep = isPenaltyState ? goalRepresentation : freekickGoalRepresentation;

                    if (gameState.endsWith('_aiming')) {
                        if (localPlayerNumber === shooter) {
                            titleElem.textContent = `SEN ${actionType.toUpperCase()} ${isPenaltyState ? 'ATIYORSUN' : 'KULLANIYORSUN'}!`;
                            descriptionElem.textContent = isPenaltyState ? 'Yön seçip ŞUT ÇEK butonuna bas.' : 'Yön, güç seçip ŞUT ÇEK butonuna bas.';
                            shooterControls.style.display = isPenaltyState ? 'flex' : 'block';
                            keeperControls.style.display = 'none';
                            // Seçim yapıldığında aktif olan .selected classını temizle (yeni seçim için)
                            goalRep.querySelectorAll('.clickable-goal-area').forEach(area => area.classList.remove('selected', 'save-result', 'missed-result'));
                        } else if (localPlayerNumber === keeper) {
                            titleElem.textContent = `OYUNCU ${shooter} ${actionType.toUpperCase()} ${isPenaltyState ? 'ATIYOR' : 'KULLANIYOR'}...`;
                            descriptionElem.textContent = isPenaltyState ? 'Kurtarmak için bir yön seç:' : 'Kurtarmak için yön ve pozisyon seç:';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = isPenaltyState ? 'flex' : 'block';
                             // Seçim yapıldığında aktif olan .selected classını temizle (yeni seçim için)
                            goalRep.querySelectorAll('.clickable-goal-area').forEach(area => area.classList.remove('selected', 'save-result', 'missed-result'));
                        }
                        // console.log(`[${gameState}] ${actionType} modalı AÇILMAYA çalışılıyor (_aiming)...`);
                        modalToToggle(true);
                        // Diğer modalı kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);

                    } else if (gameState.endsWith('_waiting')) {
                        if (localPlayerNumber === shooter) {
                            titleElem.textContent = `ŞUT ÇEKTİN!`;
                            descriptionElem.textContent = 'Kaleci kurtarış yapmayı bekliyor...';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = 'none';
                        } else if (localPlayerNumber === keeper) {
                            titleElem.textContent = `OYUNCU ${shooter} ŞUT ÇEKTİ!`;
                            descriptionElem.textContent = isPenaltyState ? 'Kurtarmak için bir yön seç:' : 'Kurtarmak için yön ve pozisyon seç:';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = isPenaltyState ? 'flex' : 'block';
                        }
                         // console.log(`[${gameState}] ${actionType} modalı AÇILMAYA çalışılıyor (_waiting)...`);
                        modalToToggle(true);
                         // Diğer modalı kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);

                    } else if (gameState.endsWith('_result')) {
                        const details = gameData.penaltyDetails;
                        if (!details) {
                            console.error(`[${gameState}] Sonuç durumu için penaltyDetails eksik!`);
                            return;
                        }
                        const shooterDirection = details.shooterDirection;
                        const keeperDirection = details.keeperDirection;
                        const isGoal = details.isGoal;

                        titleElem.textContent = isGoal ? 'GOOOL!' : 'KAÇTI!';
                        if (isPenaltyState) {
                            descriptionElem.textContent = `Şut: ${directionText(shooterDirection)}, Kaleci: ${directionText(keeperDirection)}`;
                        } else { // Frikik
                            descriptionElem.textContent = `Şut: ${directionText(shooterDirection)} (${powerText(details.shooterPower)}), Kaleci: ${directionText(keeperDirection)} (${positionText(details.keeperPosition)})`;
                        }

                        const goalAreas = goalRep.querySelectorAll('.clickable-goal-area');
                        goalAreas.forEach(area => {
                            area.classList.remove('selected', 'save-result', 'missed-result');
                            if (area.dataset.direction === shooterDirection) {
                                area.classList.add(isGoal ? 'save-result' : 'missed-result');
                            }
                        });

                        shooterControls.style.display = 'none';
                        keeperControls.style.display = 'none';
                        // console.log(`[${gameState}] ${actionType} modalı AÇILMAYA çalışılıyor (_result)...`);
                        modalToToggle(true);
                         // Diğer modalı kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);


                        if (localPlayerNumber === 1) { // Sadece host sonucu işleyip turu devreder
                            setTimeout(() => turnOverAfterSpecialAction(shooter, isGoal, actionType, details), 3000);
                        }
                    }
                };

                const turnOverAfterSpecialAction = async (shooter, isGoal, actionType, actionDetails) => { // Fonksiyonu async yaptık
                    if (!shooter || !currentGameId || localPlayerNumber !== 1 || !actionDetails) return;

                    // Bu fonksiyonun birden fazla kez çağrılmasını engellemek için kontrol
                    if (gameData.penaltyDetails === null) {
                        console.log(`[${actionType}_result] turnOverAfterSpecialAction zaten işlenmiş, penaltyDetails null.`);
                        return;
                    }

                    console.log(`${actionType} sonucu (host işliyor): ${isGoal ? 'GOL' : 'KAÇTI'}, Şutör: ${shooter}`);

                    const nextPlayerIfGoal = shooter === 1 ? 2 : 1;
                    const nextPlayerIfMiss = shooter === 1 ? 2 : 1; 
                    const nextPlayer = isGoal ? nextPlayerIfGoal : nextPlayerIfMiss;

                    // Potansiyel skorları hesapla
                    let potentialP1Score = gameData.player1?.score || 0;
                    let potentialP2Score = gameData.player2?.score || 0;
                    const shooterPlayerObjKey = (gameData.player1 && (gameData.player1.id === `player${shooter}_host` || gameData.player1.name.includes(`Oyuncu ${shooter}`) || (shooter === 1))) ? 'player1' : 'player2';
                    
                    if (isGoal) {
                        if (shooterPlayerObjKey === 'player1') {
                            potentialP1Score++;
            } else {
                            potentialP2Score++;
                        }
                    }

                    // Oyun bitişini kontrol et
                    // currentTurn, _stopped durumunda zaten güncellenmişti, bu özel aksiyon tur sayısını değiştirmez.
                    const isGameOverAfterSpecial = await checkGameOverConditionOnHost(currentGameId, {
                        player1Score: potentialP1Score,
                        player2Score: potentialP2Score,
                        currentTurnForCheck: gameData.currentTurn, // Mevcut tur sayısını kullan
                        gameSettings: gameData.gameSettings
                    });

                    if (isGameOverAfterSpecial) {
                        console.log(`Host: Oyun bittiği için (${actionType} sonrası) normal tur devri yapılmadı.`);
                        // checkGameOverConditionOnHost zaten Firebase'i güncelledi ve skoru/turu da yazdı.
                    } else {
                        const updates = {
                            gameState: `player${nextPlayer}_turn`,
                            currentPlayer: nextPlayer,
                            messageToPlayers: isGoal ?
                                `GOOOL! Oyuncu ${shooter} ${actionType === 'penalty' ? 'penaltıyı' : 'frikiği'} gole çevirdi! Sıra Oyuncu ${nextPlayer}\'de.` :
                                `${actionType === 'penalty' ? 'Penaltı' : 'Frikik'} KAÇTI! Oyuncu ${shooter} kaçırdı. Sıra Oyuncu ${nextPlayer}\'de.`,
                            penaltyDetails: null, 
                            lastActionTimestamp: serverTimestamp(),
                        };
    
                        if (isGoal) {
                             if (shooterPlayerObjKey === 'player1') {
                                 updates[`player1/score`] = potentialP1Score;
                            } else if (shooterPlayerObjKey === 'player2') {
                                 updates[`player2/score`] = potentialP2Score;
                            }
                        }
    
                        update(ref(database, 'games/' + currentGameId), updates)
                            .then(() => console.log(`${actionType} sonrası oyun durumu güncellendi. Sıra: ${nextPlayer}`))
                            .catch((error) => console.error(`${actionType} sonrası güncelleme hatası:`, error));
                    }
                };

                handleSpecialGameState();

                if (gameData.messageToPlayers &&
                    gameData.messageToPlayers.toLowerCase().includes('aut!') &&
                    gameData.gameState !== gameData.previousGameStateForAutSound) { // TODO: previousGameStateForAutSound eklenmeli
                    if (autSound) autSound.play().catch(e => console.log("Aut sesi oynatılamadı:", e));
                    flashScreen('miss');
                }

                if (gameData.messageToPlayers && gameData.messageToPlayers.toLowerCase().includes('gooool!') &&
                    !gameData.gameState.startsWith('penalty_') && !gameData.gameState.startsWith('freekick_') && // Sadece normal goller için
                    gameData.gameState !== gameData.previousGameStateForGoalSound // TODO: previousGameStateForGoalSound eklenmeli
                ) {
                    if (goalSound) goalSound.play().catch(e => console.log("Gol sesi oynatılamadı:", e));
                    spectatorsArea.classList.add('cheering');
                    animateBallToGoal();
                    animateGoalText();
                    setTimeout(() => spectatorsArea.classList.remove('cheering'), 2500);
                }
            });
        }

        async function handleTurnTimeout(playerNumberWhoShouldHavePlayed, turnNumberWhenTimerSet, expectedGameStateWhenTimerSet) {
            if (localPlayerNumber !== 1 || !currentGameId) return; // Only host processes timeouts

            // console.log(`Host: handleTurnTimeout called for Player ${playerNumberWhoShouldHavePlayed} (timer set during turn ${turnNumberWhenTimerSet}, expected state ${expectedGameStateWhenTimerSet})`);

            const gameRef = ref(database, 'games/' + currentGameId);
            try {
                const snapshot = await get(gameRef);
                if (!snapshot.exists()) {
                    // console.log("Host: Game ended or does not exist, timeout cancelled.");
                    if (turnTimerId) { clearTimeout(turnTimerId); turnTimerId = null; }
                    return;
                }
                const freshGameData = snapshot.val();

                // Critical Check: Is it still the same player's turn, the same turn number, AND the expected game state?
                if (freshGameData.gameState === expectedGameStateWhenTimerSet &&
                    freshGameData.currentTurn === turnNumberWhenTimerSet &&
                    parseInt(freshGameData.gameState.charAt(6)) === playerNumberWhoShouldHavePlayed) { // Ensure it is still this player's specific turn/timing state

                    const nextPlayer = playerNumberWhoShouldHavePlayed === 1 ? 2 : 1;
                    let timeoutReason = "";
                    let timeoutDurationMs = 0;

                    if (expectedGameStateWhenTimerSet.endsWith('_turn')) {
                        timeoutReason = "başlatmadı";
                        timeoutDurationMs = (freshGameData.gameSettings?.turnTimeoutSeconds || 5) * 1000;
                    } else if (expectedGameStateWhenTimerSet.endsWith('_timing')) {
                        timeoutReason = "durdurmadı";
                        timeoutDurationMs = (freshGameData.gameSettings?.stopTimeoutSeconds || 3) * 1000;
                    }

                    const newSharedStopwatchMs = (freshGameData.sharedStopwatchMs || 0) + timeoutDurationMs; // Zaman aşımı süresini ekle

                    const updates = {
                        currentPlayer: nextPlayer,
                        gameState: `player${nextPlayer}_turn`,
                        messageToPlayers: `Oyuncu ${playerNumberWhoShouldHavePlayed} zamanında ${timeoutReason}! Sıra Oyuncu ${nextPlayer}\'de. (Süreye ${formatTime(timeoutDurationMs)} eklendi)`,
                        sharedStopwatchMs: newSharedStopwatchMs,
                        liveTimeMs: newSharedStopwatchMs, // Zaman aşımı sonrası liveTimeMs'i de güncelle
                        currentTurn: freshGameData.currentTurn + 1, 
                        lastActionTimestamp: serverTimestamp()
                    };

                    await update(gameRef, updates);
            } else {
                    // console.log(`Host: Timeout for Player ${playerNumberWhoShouldHavePlayed} (turn ${turnNumberWhenTimerSet}) is stale or player made a move. DB state: ${freshGameData.gameState}, DB turn: ${freshGameData.currentTurn}. No action taken.`);
                }
            } catch (error) {
                console.error("Host: Error in handleTurnTimeout:", error);
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const centiseconds = Math.floor((ms % 1000) / 10);
            return `${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
        }
        
        function startStopwatch() {
            if (running || !localPlayerNumber || !currentGameId) return;
            
            const gameRefPath = 'games/' + currentGameId;
            const gameRefInstance = ref(database, gameRefPath);

            get(gameRefInstance).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer !== localPlayerNumber || gameData.gameState !== `player${localPlayerNumber}_turn`){
                        console.warn("Sıra sizde değil veya oyun durumu (start) uygun değil:", gameData.gameState);
                        return;
                    }

                running = true;
                toggleBtn.textContent = 'Durdur';
                    milliseconds = gameData.sharedStopwatchMs || 0;
                    stopwatchElem.textContent = formatTime(milliseconds);

                    update(gameRefInstance, { 
                        gameState: `player${localPlayerNumber}_timing`,
                        messageToPlayers: `Oyuncu ${localPlayerNumber} oynuyor...`,
                        lastActionTimestamp: serverTimestamp()
                    });
                
                interval = setInterval(() => {
                    milliseconds += 10;
                    stopwatchElem.textContent = formatTime(milliseconds);
                }, 10);

                    // Start interval for this client to update liveTimeMs in Firebase
                    if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId);
                    liveUpdateIntervalId = setInterval(() => {
                        if (running && currentGameId) { // Ensure still running and in a game
                            update(ref(database, 'games/' + currentGameId), { liveTimeMs: milliseconds });
                        }
                    }, 250); // Update Firebase every 250ms

                }
            });
        }
        
        function stopStopwatch() {
            if (!running || !localPlayerNumber || !currentGameId) return;

            running = false;
            clearInterval(interval);
            toggleBtn.textContent = 'Başlat';
            toggleBtn.disabled = true; 

            const stoppedMilliseconds = milliseconds;
            const centisecondsValue = Math.floor((stoppedMilliseconds % 1000) / 10);

            if (liveUpdateIntervalId) { // Stop live updates to Firebase
                clearInterval(liveUpdateIntervalId);
                liveUpdateIntervalId = null;
            }

            const gameRefPath = 'games/' + currentGameId;
            update(ref(database, gameRefPath), {
                 lastActionDetail: {
                    player: localPlayerNumber,
                    timeMs: stoppedMilliseconds, 
                    centiseconds: centisecondsValue
                },
                gameState: `player${localPlayerNumber}_stopped`,
                liveTimeMs: stoppedMilliseconds, // Son durdurulan zamanı liveTimeMs'e de yaz
                messageToPlayers: `Oyuncu ${localPlayerNumber} durdurdu: ${formatTime(stoppedMilliseconds)}. Sonuç bekleniyor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                console.log("Durdurma bilgisi Firebase'e gönderildi: " + formatTime(stoppedMilliseconds));
            }).catch(error => {
                console.error("Durdurma bilgisi gönderilemedi:", error);
                toggleBtn.disabled = false; 
            });
        }
        
        function animateBallToGoal() {
            footballBallElem.classList.add('shooting');
            setTimeout(() => {
                footballBallElem.classList.remove('shooting');
            footballBallElem.style.transform = 'translateX(-50%)';
            footballBallElem.style.bottom = '20%';
            }, 1000); 
        }

        function animateGoalText() {
            goalCelebrationTextElem.classList.add('animate');
            setTimeout(() => {
                goalCelebrationTextElem.classList.remove('animate');
            }, 2000); 
        }
        
        function togglePenaltyModal(show) { 
            console.log(`togglePenaltyModal çağrıldı: ${show}`);
            if (!penaltyModal) {
                console.error("PENALTI MODALI DOM ELEMENTİ BULUNAMADI!");
                return;
            }
            if (show) {
                penaltyModal.classList.add('active');
                console.log("Penaltı modalı AKTİFLEŞTİRİLDİ (.active class eklendi)");
            } else {
                penaltyModal.classList.remove('active');
                // console.log("Penaltı modalı PASİFLEŞTİRİLDİ (.active class kaldırıldı)"); // Kapatma logu genellikle çok sık basılır, şimdilik kapalı
            }
        }
        
        function toggleFreekickModal(show) { 
            console.log("toggleFreekickModal çağrıldı:", show);
            if (!freekickModal) {
                console.error("Frikik modalı bulunamadı!");
                return;
            }
            
            if (show) {
                freekickModal.classList.add('active');
                console.log("Frikik modalı aktifleştirildi");
            } else {
                freekickModal.classList.remove('active');
            }
        }
        
        function flashScreen(type) { 
            gameFlash.className = 'game-flash'; 
            void gameFlash.offsetWidth; 
            
            if (type === 'miss') { 
                gameFlash.classList.add('flash-miss');
            }
            
            setTimeout(() => {
                gameFlash.className = 'game-flash'; 
            }, 500);
        }
        
        createRoomBtn.addEventListener('click', createGameRoom);
        joinRoomBtn.addEventListener('click', joinGameRoom);

        toggleBtn.addEventListener('click', () => {
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer === localPlayerNumber){
                        if(gameData.gameState === `player${localPlayerNumber}_turn`){
                            startStopwatch();
                        } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                            stopStopwatch();
                        } else {
                            console.log("Oyun durumu (toggleBtn) kronometre başlatmaya/durdurmaya uygun değil:", gameData.gameState);
                        }
                    } else {
                        console.log("Sıra sizde değil (toggleBtn).");
                    }
                }
            });
        });
        
        // Eski oddBtn/evenBtn kodları kaldırıldı - artık penaltı için yön seçimi kullanılıyor
        
        document.addEventListener('keydown', (e) => {
            if (!currentGameId || !localPlayerNumber || lobbyControls.classList.contains('hidden') === false) return; 
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if (gameData.currentPlayer === localPlayerNumber) {
                        if (e.code === 'Space' || e.code === 'Enter') { 
                e.preventDefault();
                             if(gameData.gameState === `player${localPlayerNumber}_turn`){
                startStopwatch();
                            } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                                stopStopwatch();
                            }
                        }
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', initializeAppUI);

        // Penaltı yön seçimi için olay dinleyicileri
        goalRepresentation.addEventListener('click', (e) => {
            const area = e.target.closest('.clickable-goal-area');
            if (!area) return;
            
            // Tüm seçimleri temizle
            const allAreas = goalRepresentation.querySelectorAll('.clickable-goal-area');
            allAreas.forEach(a => a.classList.remove('selected'));
            
            // Seçilen yönü işaretle
            area.classList.add('selected');
            selectedPenaltyDirection = area.dataset.direction;
        });
        
        // Şut çekme butonu
        penaltyShootBtn.addEventListener('click', () => {
            if (!selectedPenaltyDirection || !currentGameId || !localPlayerNumber) return;
            
            // Firebase'e yön bilgisini gönder
            const gameRefPath = 'games/' + currentGameId;
            
            update(ref(database, gameRefPath), {
                [`penaltyDetails/shooterDirection`]: selectedPenaltyDirection,
                [`penaltyDetails/status`]: 'shooting',
                gameState: `penalty_player${localPlayerNumber}_waiting`, // Kalecinin kurtarış seçimini bekliyor
                messageToPlayers: `Oyuncu ${localPlayerNumber} şut çekti! Kaleci hazırlanıyor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                penaltyDescriptionElem.textContent = 'Kaleci kurtarış yapmayı bekliyor...';
                penaltyShooterControls.style.display = 'none';
            });
        });
        
        // Kurtarış butonu
        penaltySaveBtn.addEventListener('click', () => {
            if (!selectedPenaltyDirection || !currentGameId || !localPlayerNumber) return;
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if (!snapshot.exists()) return;
                
                const gameData = snapshot.val();
                const shooter = gameData.penaltyDetails?.shooter;
                const shooterDirection = gameData.penaltyDetails?.shooterDirection;
                
                if (!shooterDirection || gameData.gameState !== `penalty_player${shooter}_waiting`) {
                    console.log("Şutör henüz şut çekmemiş veya uygun oyun durumu değil.");
                    return;
                }
                
                // Kurtarış sonucunu belirle
                const isGoal = shooterDirection !== selectedPenaltyDirection; // Kaleci doğru tahmin edemezse gol
                
                update(ref(database, gameRefPath), {
                    [`penaltyDetails/keeperDirection`]: selectedPenaltyDirection,
                    [`penaltyDetails/isGoal`]: isGoal,
                    [`penaltyDetails/status`]: 'completed',
                    gameState: `penalty_player${shooter}_result`,
                    messageToPlayers: isGoal ? 
                        `GOOOL! Oyuncu ${shooter} penaltıdan gol attı! (${directionText(shooterDirection)})` : 
                        `Kaleci KURTARDI! Oyuncu ${localPlayerNumber} doğru yönü tahmin etti! (${directionText(shooterDirection)})`,
                    lastActionTimestamp: serverTimestamp()
                }).then(() => {
                    // UI güncellemesi listenToGameUpdates üzerinden yapılacak
                    if (isGoal && goalSound) {
                        goalSound.play().catch(e => console.log("Gol sesi oynatılamadı:", e));
                    } else if (!isGoal && whistleSound) {
                        whistleSound.play().catch(e => console.log("Düdük sesi oynatılamadı:", e));
                    }
                });
            });
        });
        
        // Yön adını insan dostu formata çevirir
        function directionText(direction) {
            switch(direction) {
                case 'left': return 'SOL';
                case 'center': return 'ORTA';
                case 'right': return 'SAĞ';
                default: return direction;
            }
        }
        
        // Güç seviyesini insan dostu formata çevirir
        function powerText(power) {
            switch(power) {
                case 'low': return 'DÜŞÜK';
                case 'medium': return 'ORTA';
                case 'high': return 'YÜKSEK';
                default: return power;
            }
        }
        
        // Pozisyon seviyesini insan dostu formata çevirir
        function positionText(position) {
            switch(position) {
                case 'low': return 'ALÇAK';
                case 'medium': return 'ORTA';
                case 'high': return 'YÜKSEK';
                default: return position;
            }
        }

        // Frikik yön ve güç seçimi için olay dinleyicileri
        freekickGoalRepresentation.addEventListener('click', (e) => {
            const area = e.target.closest('.clickable-goal-area');
            if (!area) return;
            
            // Tüm seçimleri temizle
            const allAreas = freekickGoalRepresentation.querySelectorAll('.clickable-goal-area');
            allAreas.forEach(a => a.classList.remove('selected'));
            
            // Seçilen yönü işaretle
            area.classList.add('selected');
            selectedFreekickDirection = area.dataset.direction;
        });
        
        // Frikik güç seçimi
        freekickShooterControls.querySelectorAll('.power-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Tüm seçimleri temizle
                freekickShooterControls.querySelectorAll('.power-btn').forEach(b => b.classList.remove('selected'));
                // Seçilen gücü işaretle
                btn.classList.add('selected');
                selectedFreekickPower = btn.dataset.power;
            });
        });
        
        // Kaleci pozisyon seçimi
        freekickKeeperControls.querySelectorAll('.power-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Tüm seçimleri temizle
                freekickKeeperControls.querySelectorAll('.power-btn').forEach(b => b.classList.remove('selected'));
                // Seçilen pozisyonu işaretle
                btn.classList.add('selected');
                selectedKeeperPosition = btn.dataset.position;
            });
        });
        
        // Frikik şut çekme butonu
        freekickShootBtn.addEventListener('click', () => {
            if (!selectedFreekickDirection || !selectedFreekickPower || !currentGameId || !localPlayerNumber) {
                alert("Lütfen hem yön hem de güç seçin!");
                return;
            }
            
            // Firebase'e yön ve güç bilgisini gönder
            const gameRefPath = 'games/' + currentGameId;
            
            update(ref(database, gameRefPath), {
                [`penaltyDetails/shooterDirection`]: selectedFreekickDirection,
                [`penaltyDetails/shooterPower`]: selectedFreekickPower,
                [`penaltyDetails/status`]: 'shooting',
                [`penaltyDetails/type`]: 'freekick',
                gameState: `freekick_player${localPlayerNumber}_waiting`, // Kalecinin kurtarış seçimini bekliyor
                messageToPlayers: `Oyuncu ${localPlayerNumber} şut çekti! Kaleci hazırlanıyor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                freekickDescriptionElem.textContent = 'Kaleci kurtarış yapmayı bekliyor...';
                freekickShooterControls.style.display = 'none';
            });
        });
        
        // Frikik kurtarış butonu
        freekickSaveBtn.addEventListener('click', () => {
            if (!selectedFreekickDirection || !selectedKeeperPosition || !currentGameId || !localPlayerNumber) {
                alert("Lütfen hem yön hem de pozisyon seçin!");
                return;
            }
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if (!snapshot.exists()) return;
                
                const gameData = snapshot.val();
                const shooter = gameData.penaltyDetails?.shooter;
                const shooterDirection = gameData.penaltyDetails?.shooterDirection;
                const shooterPower = gameData.penaltyDetails?.shooterPower;
                
                if (!shooterDirection || !shooterPower || gameData.gameState !== `freekick_player${shooter}_waiting`) {
                    console.log("Şutör henüz şut çekmemiş veya uygun oyun durumu değil.");
                    return;
                }
                
                // Frikik kurtarış mantığı:
                // 1. Eğer kaleci yönü doğru tahmin ettiyse:
                //    - Eğer pozisyon ve güç uyumluysa kurtar (ör: yüksek şuta yüksek pozisyon)
                //    - Değilse gol
                // 2. Eğer kaleci yönü yanlış tahmin ettiyse:
                //    - Otomatik gol
                
                let isGoal = true; // Varsayılan olarak gol
                
                if (shooterDirection === selectedFreekickDirection) {
                    // Doğru yön, pozisyon kontrolü
                    if ((shooterPower === 'low' && selectedKeeperPosition === 'low') ||
                        (shooterPower === 'medium' && selectedKeeperPosition === 'medium') ||
                        (shooterPower === 'high' && selectedKeeperPosition === 'high')) {
                        isGoal = false; // Pozisyon eşleşmesi, kurtarış
                    }
                }
                
                update(ref(database, gameRefPath), {
                    [`penaltyDetails/keeperDirection`]: selectedFreekickDirection,
                    [`penaltyDetails/keeperPosition`]: selectedKeeperPosition,
                    [`penaltyDetails/isGoal`]: isGoal,
                    [`penaltyDetails/status`]: 'completed',
                    gameState: `freekick_player${shooter}_result`,
                    messageToPlayers: isGoal ? 
                        `GOOOL! Oyuncu ${shooter} frikiği gole çevirdi! (${directionText(shooterDirection)}, ${powerText(shooterPower)})` : 
                        `Kaleci KURTARDI! Oyuncu ${localPlayerNumber} doğru yönü ve pozisyonu tahmin etti!`,
                    lastActionTimestamp: serverTimestamp()
                }).then(() => {
                    // UI güncellemesi listenToGameUpdates üzerinden yapılacak
                    if (isGoal && goalSound) {
                        goalSound.play().catch(e => console.log("Gol sesi oynatılamadı:", e));
                    } else if (!isGoal && whistleSound) {
                        whistleSound.play().catch(e => console.log("Düdük sesi oynatılamadı:", e));
                    }
                });
            });
        });

        // Kurallar Modalı için Olay Dinleyicileri
        if (rulesBtn && rulesModal && closeRulesModalBtn) {
            rulesBtn.addEventListener('click', () => {
                rulesModal.classList.add('active');
            });

            closeRulesModalBtn.addEventListener('click', () => {
                rulesModal.classList.remove('active');
            });

            rulesModal.addEventListener('click', (event) => {
                if (event.target === rulesModal) { // Sadece modalın dışına tıklanırsa kapat
                    rulesModal.classList.remove('active');
                }
            });
        } else {
            console.warn("Kurallar modalı veya butonları bulunamadı, olay dinleyicileri eklenemedi.");
        }
    </script>
</body>
</html>