<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoFootball - 90'lar Casio Mod</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Rubik+Mono+One&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0d3b66;
            --yellow: #f4d35e;
            --orange: #ee964b;
            --red: #f95738; /* Ana kronometre rengi i√ßin kullanƒ±labilir */
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #222; /* Casio ekranƒ± i√ßin daha koyu bir gri */
            --casio-bg: #c0c0c0; /* Casio saat kasasƒ± rengi */
            --casio-screen-bg: #90a090; /* Casio ekran arka planƒ± (genelde ye≈üilimsi) */
            --casio-text: #333333; /* Casio ekran yazƒ±sƒ± */
            --football-green: #2A8C2A; /* Ye≈üil saha rengi */
            --goal-line-white: #FFFFFF;

            --transparent-black: rgba(0, 0, 0, 0.7);
            --transparent-green: rgba(0, 255, 0, 0.3);
            --transparent-red: rgba(255, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: var(--football-green); /* Ye≈üil saha arka planƒ± */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Animasyonlarda ta≈ümayƒ± engelle */
            position: relative; /* ƒ∞√ßerideki absolute pozisyonlamalar i√ßin */
        }

        /* Saha √áizgileri (Basit) */
        body::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            width: 2px;
            height: 80%;
            background-color: rgba(255, 255, 255, 0.3); /* Orta saha √ßizgisi */
            transform: translateX(-50%);
            z-index: 0;
        }
        body::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px; /* Orta yuvarlak √ßapƒ± */
            height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .game-area {
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Diƒüer elemanlarƒ±n √ºst√ºnde olmasƒ± i√ßin */
        }

        /* Kale Alanƒ± (Basit CSS ile) */
        .goal-area {
            position: absolute;
            top: 10px; /* Sahanƒ±n √ºst kƒ±smƒ±nda */
            left: 50%;
            transform: translateX(-50%);
            width: 120px; /* Kale geni≈üliƒüi */
            height: 60px; /* Kale y√ºksekliƒüi */
            border: 3px solid var(--goal-line-white);
            border-top: none; /* √úst direk yok, sadece yan ve alt */
            z-index: 1;
        }
        .goal-area::before, .goal-area::after { /* Kale direkleri */
            content: '';
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 100%;
            background-color: var(--goal-line-white);
        }
        .goal-area::before { left: -3px; }
        .goal-area::after { right: -3px; }


        /* Futbol Topu */
        #football-ball {
            position: absolute;
            bottom: 20%; /* Ba≈ülangƒ±√ß pozisyonu, kronometrenin biraz √ºst√º */
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem; /* Top boyutu */
            z-index: 2;
            transition: transform 0.5s ease-in-out, bottom 0.5s ease-in-out;
        }

        #football-ball.shooting {
            /* Moves the ball towards the goal area */
            transform: translateX(-50%); /* Maintain horizontal centering */
            bottom: 85%; /* Target Y position (closer to the top). Adjust this percentage for best visual effect. */
        }


        /* Gol Sevinci Metni */
        #goal-celebration-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            font-family: 'Press Start 2P', cursive; /* Pixelated font */
            font-size: 3rem; /* B√ºy√ºk ve etkili */
            color: var(--yellow);
            text-shadow: 3px 3px 0 var(--navy), -1px -1px 0 var(--navy), 1px -1px 0 var(--navy), -1px 1px 0 var(--navy), 1px 1px 0 var(--navy);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease-out;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
        }

        #goal-celebration-text.animate {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        .header {
            background-color: var(--navy);
            color: var(--white);
            padding: 0.5rem 1rem; /* Biraz daha kompakt */
            text-align: center;
            position: relative;
            z-index: 2; /* Oyun alanƒ±nƒ±n √ºst√ºnde */
        }
        
        .logo {
            font-size: 1.5rem; /* Biraz k√º√ß√ºlt√ºld√º */
            font-weight: bold;
            margin-bottom: 0.25rem;
             font-family: 'Press Start 2P', cursive;
        }

        .turn-indicator {
            font-size: 0.9rem; /* Biraz k√º√ß√ºlt√ºld√º */
            padding: 0.3rem 0.8rem;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .player1-turn {
            background-color: var(--yellow);
            color: var(--navy);
        }

        .player2-turn {
            background-color: var(--orange);
            color: var(--navy);
        }

        .blinking {
            animation: blink-animation 1s infinite;
        }

        @keyframes blink-animation {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; 
            font-weight: bold;
        }
        
        .team {
            padding: 0 0.5rem; 
            flex: 1;
            text-align: center;
        }
        
        .score {
            padding: 0 0.5rem;
            min-width: 1.5rem; 
            text-align: center;
            font-size: 1.3rem; /* Skor biraz daha belirgin */
        }
        
        .main { /* Bu artƒ±k game-area i√ßinde kronometre ve kontrolleri tutacak */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Kontrolleri a≈üaƒüƒ±ya ve kronometreyi √ºste yakƒ±n tutar */
            flex-grow: 1;
            padding: 1rem;
            width: 100%;
            z-index: 2; /* Header ile aynƒ± seviyede */
            margin-bottom: 50px; /* Footer i√ßin yer bƒ±rak */
        }
        
        .stopwatch-container {
            background-color: var(--casio-bg); /* Casio saat kasasƒ± */
            padding: 10px;
            border-radius: 8px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3), inset 1px 1px 0px rgba(255,255,255,0.5);
            margin-bottom: 1.5rem; /* Top ile arasƒ±nda bo≈üluk */
        }

        .stopwatch {
            font-family: 'Rubik Mono One', 'Press Start 2P', monospace; /* Dijital g√∂r√ºn√ºml√º font */
            font-size: 3.5rem; /* Boyut ayarlanabilir */
            background-color: var(--casio-screen-bg); /* Casio ekran arka planƒ± */
            color: var(--casio-text); /* Casio ekran yazƒ±sƒ± */
            padding: 0.8rem 1.2rem;
            border-radius: 0.3rem;
            border: 2px solid var(--dark-gray);
            min-width: 15rem; /* Min geni≈ülik */
            text-align: center;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.2); /* Hafif ekran parlama efekti */
            box-shadow: inset 2px 2px 3px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        
        .message {
            font-size: 1.3rem; /* Biraz b√ºy√ºt√ºld√º */
            height: 1.8rem; /* Y√ºksekliƒüi ayarlandƒ± */
            margin: 0.5rem 0; /* Bo≈üluk azaltƒ±ldƒ± */
            color: var(--white); /* Beyaz, saha √ºzerinde daha iyi okunur */
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px var(--navy); /* Okunurluk i√ßin g√∂lge */
            min-height: 1.8rem; /* ƒ∞√ßerik olmadƒ±ƒüƒ±nda bile yer kaplasƒ±n */
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem; /* Mesaj ile arasƒ±nda bo≈üluk */
        }
        
        .btn {
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 2rem;
            background-color: var(--navy);
            color: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Press Start 2P', cursive; /* Pixelated font for buttons */
            box-shadow: 2px 2px 0px var(--dark-gray);
        }

        .btn:hover {
            transform: translateY(-2px) translateX(-1px);
            box-shadow: 3px 3px 0px var(--dark-gray);
        }

        .btn:disabled {
            background-color: #999;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: 1px 1px 0px #777;
        }
        
        .btn:active {
            transform: translateY(1px) translateX(0.5px);
            box-shadow: 1px 1px 0px var(--dark-gray);
        }
        
        .btn-primary {
            background-color: var(--orange);
        }
        
        .btn-secondary {
            background-color: var(--navy);
        }

        .keyboard-hint {
            font-size: 0.8rem; /* Biraz k√º√ß√ºlt√ºld√º */
            color: var(--light-gray);
            margin-top: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 1px 1px 1px var(--dark-gray);
        }
        
        .modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En √ºstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content { 
            background-color: var(--casio-bg); /* Modal da Casio temasƒ±na uygun */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }

        .player-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .player-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: var(--casio-text);
            font-family: 'Roboto', sans-serif; /* Radio buton yazƒ±larƒ± normal olabilir */
        }
        
        .penalty-modal { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* En √ºstte */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .penalty-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .penalty-card { 
            background-color: var(--casio-bg); /* Penaltƒ± kartƒ± da Casio temalƒ± */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        
        .penalty-title {
            font-size: 1.3rem; /* Biraz k√º√ß√ºlt√ºld√º */
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }
        
        .penalty-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .penalty-status {
            margin-top: 10px;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
        }

        .penalty-directions {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .penalty-direction-btn {
            flex: 1;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            padding: 10px 5px;
            background-color: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .penalty-direction-btn:hover {
            transform: scale(1.05);
        }

        .goal-representation {
            margin: 15px auto;
            width: 200px;
            height: 100px;
            border: 3px solid var(--dark-gray);
            position: relative;
            display: flex;
            justify-content: space-between;
        }

        .goal-section {
            width: 33%;
            height: 100%;
            border: 1px dashed rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .goal-section:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .goal-section.selected {
            background-color: rgba(255,255,0,0.3);
        }

        .goal-section.save-result {
            background-color: rgba(0,255,0,0.3);
        }

        .goal-section.missed-result {
            background-color: rgba(255,0,0,0.3);
        }
        
        .game-flash { /* Bu genel ekran flashƒ± olarak kalabilir veya kaldƒ±rƒ±labilir */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 5; /* Top ve GOOOL yazƒ±sƒ±nƒ±n altƒ±nda */
        }
        
        .flash-goal {
            background-color: var(--transparent-green);
        }
        
        .flash-miss { /* Aut durumu i√ßin kullanƒ±labilir */
            background-color: var(--transparent-red);
        }
        
        .stats { /* ƒ∞statistikler g√∂r√ºn√ºr olmayabilir, isteƒüe baƒülƒ± */
            display: none; /* ≈ûimdilik gizlendi, tasarƒ±mda yer kaplamasƒ±n */
            justify-content: space-around;
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--light-gray);
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        
        @media (max-width: 600px) {
            .stopwatch {
                font-size: 2.5rem; /* Mobil i√ßin daha k√º√ß√ºk */
                min-width: 12rem;
                padding: 0.6rem 1rem;
            }
            .stopwatch-container {
                padding: 8px;
            }
            #goal-celebration-text {
                font-size: 2rem;
            }
            .controls {
                flex-direction: column;
            }
            .scoreboard {
                font-size: 0.9rem;
            }
            .team {
                padding: 0 0.2rem;
            }
            .logo {
                font-size: 1.2rem;
            }
            #football-ball {
                font-size: 2rem;
            }
            .goal-area {
                width: 100px;
                height: 50px;
            }
             .message {
                font-size: 1.1rem;
            }
        }

        /* Eklenen Stiller */
        #lobby-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.5rem;
        }

        #lobby-controls input[type="text"] {
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 0.3rem;
            border: 1px solid var(--dark-gray);
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            background-color: var(--light-gray);
            color: var(--casio-text);
        }

        .game-board.hidden, #lobby-controls.hidden {
            display: none !important;
        }
        /* Trib√ºn Stili */
        .spectators {
            position: absolute;
            top: -20px; /* Header'ƒ±n biraz √ºst√ºne ta≈üabilir veya header'ƒ±n hemen altƒ±na */
            left: 0;
            width: 100%;
            height: 50px; /* Trib√ºn y√ºksekliƒüi */
            /* background-color: #555; */ /* Basit bir trib√ºn rengi */
            overflow: hidden;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 0; /* Saha √ßizgilerinin arkasƒ±nda, header'ƒ±n √∂n√ºnde olabilir */
        }

        .spectator-icon {
            font-size: 1.5rem; /* Taraftar boyutu */
            color: rgba(255, 255, 255, 0.7);
            animation: cheer 1s infinite alternate ease-in-out;
            animation-play-state: paused; /* Ba≈ülangƒ±√ßta duruk */
        }
         .spectator-icon:nth-child(odd) {
            animation-delay: 0.2s;
        }
         .spectator-icon:nth-child(even) {
            animation-delay: 0.5s;
        }

        @keyframes cheer {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        .cheering .spectator-icon {
            animation-play-state: running;
        }

        /* Frikik Stili */
        .freekick-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .freekick-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .freekick-card {
            background-color: var(--casio-bg);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        
        .freekick-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
        }
        
        .freekick-description {
            margin-top: 10px;
            font-size: 1rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
        }
        
        .power-selection {
            display: flex;
            flex-direction: column;
            margin: 15px 0;
        }
        
        .power-label {
            font-size: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            color: var(--casio-text);
            margin-bottom: 5px;
        }
        
        .power-options {
            display: flex;
            justify-content: space-between;
        }
        
        .power-btn {
            flex: 1;
            margin: 0 5px;
            padding: 8px 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            background-color: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .power-btn.selected {
            background-color: var(--orange);
            transform: scale(1.05);
        }

        /* Kurallar Modalƒ± */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--transparent-black);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 250; /* Diƒüer modallarƒ±n da √ºzerinde olabilir */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .rules-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .rules-card {
            background-color: var(--casio-bg);
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            text-align: left;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--dark-gray);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .rules-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--casio-text);
            font-family: 'Press Start 2P', cursive;
            text-align: center;
        }

        .rules-content p {
            font-family: 'Roboto', sans-serif;
            color: var(--casio-text);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.8rem;
        }

        .rules-content strong {
            font-family: 'Press Start 2P', cursive;
            color: var(--navy);
        }

        .rules-content ul {
            list-style-position: inside;
            padding-left: 10px;
            margin-bottom: 1rem;
        }

        .rules-content li {
            font-family: 'Roboto', sans-serif;
            color: var(--casio-text);
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
        }

        .rules-close-btn-container {
            text-align: center;
            margin-top: 1.5rem;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ChronoGoal!</div>
        <div class="spectators" id="spectators-area">
            <span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span><span class="spectator-icon">üë§</span>
        </div>
        <div class="scoreboard">
            <div class="team" id="player1-name">OYUNCU 1</div>
            <div class="score" id="score-p1">0</div>
            <div>-</div>
            <div class="score" id="score-p2">0</div>
            <div class="team" id="player2-name">OYUNCU 2</div>
        </div>
        <div id="turn-indicator" class="turn-indicator">Sƒ±ra Oyuncuda</div>
        <button class="btn btn-secondary" id="rules-btn" style="position: absolute; top: 10px; right: 10px; padding: 0.5rem 1rem; font-size: 0.8rem;">Kurallar</button>
    </div>

    <div class="game-area">
        <div id="lobby-controls">
            <input type="text" id="room-code-input" placeholder="Oda Kodu Girin">
            <button id="join-room-btn" class="btn btn-primary">Odaya Katƒ±l</button>
            <p style="color: var(--white); font-family: 'Press Start 2P', cursive; margin: 0.5rem 0;">veya</p>
            <button id="create-room-btn" class="btn btn-secondary">Yeni Oda Olu≈ütur</button>
        </div>

        <div class="game-board hidden"> <!-- Oyun alanƒ± ba≈ülangƒ±√ßta gizli -->
        <div class="goal-area"></div>
        <div id="football-ball">‚öΩ</div>
        <div id="goal-celebration-text">GOOOOL!</div>
            <div class="message" id="message">Kim Ba≈ülasƒ±n?</div>

        <div class="main"> <!-- Kronometre ve kontroller bu alanda -->
            <div class="stopwatch-container">
                <div class="stopwatch" id="stopwatch">00.00</div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="toggle-btn" aria-label="Ba≈ülat veya Durdur" disabled>Ba≈ülat</button>
                <button class="btn btn-secondary" id="reset-btn" aria-label="Yeniden Ba≈ülat" disabled>Sƒ±fƒ±rla</button>
            </div>
                <div class="keyboard-hint">P1: Bo≈üluk, P2: Enter (Online modda sadece aktif oyuncu)</div>
            </div>
        </div>
    </div>
    
    <div class="stats"> <!-- ƒ∞statistikler (isteƒüe baƒülƒ±, ≈üu an display: none) -->
        <div>Goller: <span id="goals">0</span></div>
        <div>Penaltƒ±lar: <span id="penalties">0</span></div>
        <div>Ka√ßan Penaltƒ±lar: <span id="misses">0</span></div>
    </div>

    <div id="start-player-modal" class="modal">
        <div class="modal-content">
            <h2>Kƒ∞M BA≈ûLASIN?</h2>
            <div class="player-options">
                <label><input type="radio" name="startPlayer" value="1" checked> Oyuncu 1</label>
                <label><input type="radio" name="startPlayer" value="2"> Oyuncu 2</label>
            </div>
            <button id="confirm-start-player-btn" class="btn btn-primary">ONAYLA</button>
        </div>
    </div>
    
    <div class="penalty-modal" id="penalty-modal">
        <div class="penalty-card">
            <div class="penalty-title" id="penalty-title-text">PENALTI!</div>
            <div id="penalty-description" class="penalty-status">Y√∂n se√ßin:</div>
            
            <div id="goal-representation" class="goal-representation">
                <div class="goal-section" data-direction="left">‚¨ÖÔ∏è</div>
                <div class="goal-section" data-direction="center">‚öΩ</div>
                <div class="goal-section" data-direction="right">‚û°Ô∏è</div>
            </div>
            
            <div id="penalty-shooter-controls" class="penalty-options">
                <button class="btn btn-primary" id="penalty-shoot-btn" aria-label="≈ûut √áek">≈ûUT √áEK</button>
            </div>

            <div id="penalty-keeper-controls" class="penalty-options" style="display: none;">
                <button class="btn btn-primary" id="penalty-save-btn" aria-label="Kurtar">KURTAR</button>
            </div>
        </div>
    </div>
    
    <div class="freekick-modal" id="freekick-modal">
        <div class="freekick-card">
            <div class="freekick-title" id="freekick-title-text">FRƒ∞Kƒ∞K!</div>
            <div id="freekick-description" class="freekick-description">Y√∂n ve g√º√ß se√ßin:</div>
            
            <div id="freekick-goal-representation" class="goal-representation">
                <div class="goal-section" data-direction="left">‚¨ÖÔ∏è</div>
                <div class="goal-section" data-direction="center">‚öΩ</div>
                <div class="goal-section" data-direction="right">‚û°Ô∏è</div>
            </div>
            
            <div id="freekick-shooter-controls">
                <div class="power-selection">
                    <div class="power-label">≈ûUT G√úC√ú:</div>
                    <div class="power-options">
                        <button class="power-btn" data-power="low">D√ú≈û√úK</button>
                        <button class="power-btn" data-power="medium">ORTA</button>
                        <button class="power-btn" data-power="high">Y√úKSEK</button>
                    </div>
                </div>
                
                <div class="penalty-options">
                    <button class="btn btn-primary" id="freekick-shoot-btn" aria-label="≈ûut √áek">≈ûUT √áEK</button>
                </div>
            </div>
            
            <div id="freekick-keeper-controls" style="display: none;">
                <div class="power-selection">
                    <div class="power-label">KALEDE POZƒ∞SYON:</div>
                    <div class="power-options">
                        <button class="power-btn" data-position="low">AL√áAK</button>
                        <button class="power-btn" data-position="medium">ORTA</button>
                        <button class="power-btn" data-position="high">Y√úKSEK</button>
                    </div>
                </div>
                
                <div class="penalty-options">
                    <button class="btn btn-primary" id="freekick-save-btn" aria-label="Kurtar">KURTAR</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-flash" id="game-flash"></div>
    
    <audio id="goal-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="whistle-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2032/2032-preview.mp3" type="audio/mpeg">
    </audio>
     <audio id="aut-sound" preload="auto"> <!-- Aut sesi i√ßin eklendi -->
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-jumping-in-a-video-game-2043.mp3" type="audio/mpeg">
    </audio>
    
    <div class="rules-modal" id="rules-modal">
        <div class="rules-card">
            <div class="rules-title">OYUN KURALLARI</div>
            <div class="rules-content">
                <p><strong>AMA√á:</strong> Rakibinden daha fazla gol atarak veya belirlenen tur sayƒ±sƒ± sonunda daha √∂nde olarak ma√ßƒ± kazanmak!</p>
                
                <p><strong>NASIL OYNANIR:</strong></p>
                <ul>
                    <li>Sƒ±ra sana geldiƒüinde, kronometreyi <strong>BA≈ûLAT</strong> (Bo≈üluk veya Enter tu≈üu ile de kontrol edebilirsin).</li>
                    <li>Kronometreyi doƒüru zamanda <strong>DURDUR</strong>. Durdurduƒüun salise (saniyenin y√ºzde biri) sonucu belirler!</li>
                </ul>

                <p><strong>SONU√áLAR:</strong></p>
                <ul>
                    <li><strong>Salise 00:</strong> GOOOOL! ‚öΩ Rakip kaleye gol atarsƒ±n.</li>
                    <li><strong>Salise 90-99:</strong> PENALTI! üéØ Penaltƒ± atƒ±≈üƒ± kazanƒ±rsƒ±n. Y√∂n se√ßerek ≈üutunu √ßekersin, rakibin de kurtarmak i√ßin y√∂n se√ßer.</li>
                    <li><strong>Salise 80-89:</strong> FRƒ∞Kƒ∞K! ü•Ö Frikik kazanƒ±rsƒ±n. Y√∂n ve ≈üut g√ºc√ºn√º se√ßersin, rakibin de kurtarmak i√ßin y√∂n ve kaleci pozisyonunu belirler.</li>
                    <li><strong>Diƒüer Saliseler:</strong> AUT! üí® Top dƒ±≈üarƒ± √ßƒ±kar, sƒ±ra rakibe ge√ßer.</li>
                </ul>

                <p><strong>ZAMAN A≈ûIMLARI (Dƒ∞KKAT!):</strong></p>
                <ul>
                    <li>Kronometreyi ba≈ülatmak i√ßin <strong>5 saniyen</strong> var. Ba≈ülatmazsan, sƒ±ra rakibe ge√ßer ve ortak s√ºreye 5 saniye eklenir.</li>
                    <li>Kronometreyi ba≈ülattƒ±ktan sonra durdurmak i√ßin <strong>3 saniyen</strong> var. Durdurmazsan, sƒ±ra rakibe ge√ßer ve ortak s√ºreye 3 saniye eklenir.</li>
                </ul>

                <p><strong>KAZANMA KO≈ûULLARI:</strong></p>
                <ul>
                    <li><strong>Skor:</strong> Bir oyuncu <strong>3 gole</strong> ula≈üƒ±rsa ma√ßƒ± kazanƒ±r.</li>
                    <li><strong>S√ºre/Tur:</strong> Toplam <strong>10 hamle</strong> (her oyuncu 5'er hamle) tamamlandƒ±ƒüƒ±nda, daha fazla gol√º olan oyuncu kazanƒ±r. Beraberlik durumunda ma√ß berabere biter.</li>
                </ul>
                 <p>ƒ∞yi eƒülenceler!</p>
            </div>
            <div class="rules-close-btn-container">
                <button class="btn btn-primary" id="close-rules-modal-btn">KAPAT</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK'larƒ±nƒ± import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        // √ñNEMLƒ∞: Firebase projenizin yapƒ±landƒ±rma bilgilerini buraya girin!
        const firebaseConfig = {
            apiKey: "AIzaSyAad-afEL6c7S3Y4RJuGwoFxgPsx81k_D0",
            authDomain: "chronogoalonline.firebaseapp.com",
            databaseURL: "https://chronogoalonline-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chronogoalonline",
            storageBucket: "chronogoalonline.firebasestorage.app",
            messagingSenderId: "688627066429",
            appId: "1:688627066429:web:0c38b3e132c579668a2c54",
            measurementId: "G-S0K2X6DB15"
        };

        // Firebase'i ba≈ülat
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global Deƒüi≈ükenler (Firebase entegrasyonu i√ßin)
        let currentGameId = null;
        let localPlayerNumber = null; // Bu istemcinin oyuncu numarasƒ± (1 veya 2)
        let gameRoomCode = null; // Kullanƒ±cƒ±ya g√∂sterilen oda kodu
        let selectedPenaltyDirection = null; // Penaltƒ± i√ßin se√ßilen y√∂n
        let selectedFreekickDirection = null; // Frikik i√ßin se√ßilen y√∂n
        let selectedFreekickPower = null; // Frikik i√ßin se√ßilen g√º√ß
        let selectedKeeperPosition = null; // Kaleci i√ßin se√ßilen pozisyon

        // Oyun deƒüi≈ükenleri (Mevcutlar korunuyor, bazƒ±larƒ± Firebase'den y√∂netilecek)
        let interval;
        let running = false;
        let milliseconds = 0;
        // Diƒüer oyun state'leri (isPenalty, penaltyGuess, scores, currentPlayer, gameStarted) Firebase'den y√∂netilecek.
        
        let turnTimerId = null; // Host i√ßin zaman a≈üƒ±mƒ± sayacƒ±nƒ± tutar
        let liveUpdateIntervalId = null; // Aktif oyuncunun canlƒ± zamanƒ±nƒ± Firebase'e periyodik yazma interval'i
        
        // DOM elementleri
        const stopwatchElem = document.getElementById('stopwatch');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageElem = document.getElementById('message');
        
        const penaltyModal = document.getElementById('penalty-modal');
        const penaltyTitleTextElem = document.getElementById('penalty-title-text');
        const penaltyDescriptionElem = document.getElementById('penalty-description');
        const penaltyShooterControls = document.getElementById('penalty-shooter-controls');
        const penaltyKeeperControls = document.getElementById('penalty-keeper-controls');
        const penaltyShootBtn = document.getElementById('penalty-shoot-btn');
        const penaltySaveBtn = document.getElementById('penalty-save-btn');
        const goalRepresentation = document.getElementById('goal-representation');
        
        const scoreP1Elem = document.getElementById('score-p1');
        const scoreP2Elem = document.getElementById('score-p2');
        
        const gameFlash = document.getElementById('game-flash');
        
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');
        const autSound = document.getElementById('aut-sound');

        // Frikik modalƒ± elementleri
        const freekickModal = document.getElementById('freekick-modal');
        const freekickTitleTextElem = document.getElementById('freekick-title-text');
        const freekickDescriptionElem = document.getElementById('freekick-description');
        const freekickShooterControls = document.getElementById('freekick-shooter-controls');
        const freekickKeeperControls = document.getElementById('freekick-keeper-controls');
        const freekickShootBtn = document.getElementById('freekick-shoot-btn');
        const freekickSaveBtn = document.getElementById('freekick-save-btn');
        const freekickGoalRepresentation = document.getElementById('freekick-goal-representation');

        const turnIndicatorElem = document.getElementById('turn-indicator');
        const footballBallElem = document.getElementById('football-ball');
        const goalCelebrationTextElem = document.getElementById('goal-celebration-text');
        const spectatorsArea = document.getElementById('spectators-area');

        const lobbyControls = document.getElementById('lobby-controls');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const gameBoard = document.querySelector('.game-board');

        // Kurallar Modalƒ± Elemanlarƒ±
        const rulesBtn = document.getElementById('rules-btn');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesModalBtn = document.getElementById('close-rules-modal-btn');

        // Host tarafƒ±nda √ßalƒ±≈üacak fonksiyon
        async function checkGameOverConditionOnHost(gameId, currentSnapshotData) {
            // currentSnapshotData = { player1Score, player2Score, currentTurnForCheck, gameSettings }
            if (localPlayerNumber !== 1) return false;
        
            const p1Score = currentSnapshotData.player1Score;
            const p2Score = currentSnapshotData.player2Score;
            const currentTotalTurns = currentSnapshotData.currentTurnForCheck;
            const maxScore = currentSnapshotData.gameSettings?.maxScore || 3;
            const maxTurns = currentSnapshotData.gameSettings?.maxTurns || 10; // Toplam hamle sayƒ±sƒ± (her oyuncu maxTurns/2 hamle)
        
            let gameOver = false;
            let winner = null; // 1, 2, or 'draw'
            let endMessage = "";
        
            if (p1Score >= maxScore) {
                gameOver = true;
                winner = 1;
                endMessage = `MA√á Bƒ∞TTƒ∞! Oyuncu 1 kazandƒ±! Skor: ${p1Score}-${p2Score}`;
            } else if (p2Score >= maxScore) {
                gameOver = true;
                winner = 2;
                endMessage = `MA√á Bƒ∞TTƒ∞! Oyuncu 2 kazandƒ±! Skor: ${p1Score}-${p2Score}`;
            } else if (currentTotalTurns >= maxTurns) {
                gameOver = true;
                if (p1Score > p2Score) {
                    winner = 1;
                    endMessage = `MA√á Bƒ∞TTƒ∞! S√ºre doldu. Oyuncu 1 kazandƒ±! Skor: ${p1Score}-${p2Score}`;
                } else if (p2Score > p1Score) {
                    winner = 2;
                    endMessage = `MA√á Bƒ∞TTƒ∞! S√ºre doldu. Oyuncu 2 kazandƒ±! Skor: ${p1Score}-${p2Score}`;
                } else {
                    winner = 'draw';
                    endMessage = `MA√á Bƒ∞TTƒ∞! S√ºre doldu. Berabere! Skor: ${p1Score}-${p2Score}`;
                }
            }
        
            if (gameOver) {
                const gameRef = ref(database, 'games/' + gameId);
                const updatesToFirebase = {
                    gameState: 'game_over',
                    winnerPlayer: winner,
                    messageToPlayers: endMessage,
                    lastActionTimestamp: serverTimestamp(),
                    'player1/score': p1Score, // Skoru ve turu da game_over ile birlikte yazalƒ±m
                    'player2/score': p2Score,
                    currentTurn: currentTotalTurns,
                };
                await update(gameRef, updatesToFirebase);
                console.log("Oyun bitti (checkGameOverConditionOnHost). Kazanan: ", winner, " Mesaj: ", endMessage);
                return true; // Oyun bitti
            }
            return false; // Oyun devam ediyor
        }

        function initializeAppUI() {
            lobbyControls.classList.remove('hidden');
            gameBoard.classList.add('hidden');
            messageElem.classList.add('hidden');
            toggleBtn.disabled = true;
            resetBtn.disabled = true;
            
            // UI elemanlarƒ±nƒ± kontrol et
            console.log("Penalty Modal Element:", penaltyModal ? "OK" : "YOK");
            console.log("Freekick Modal Element:", freekickModal ? "OK" : "YOK");
            
            // Daha detaylƒ± frikik modalƒ± eleman kontrol√º (√∂nceki logun devamƒ± gibi)
            console.log("Frikik modalƒ± detaylarƒ±:", {
                modal: freekickModal ? "OK" : "YOK",
                title: freekickTitleTextElem ? "OK" : "YOK",
                description: freekickDescriptionElem ? "OK" : "YOK",
                shooterControls: freekickShooterControls ? "OK" : "YOK",
                keeperControls: freekickKeeperControls ? "OK" : "YOK",
                shootBtn: freekickShootBtn ? "OK" : "YOK",
                saveBtn: freekickSaveBtn ? "OK" : "YOK",
                goalRepresentation: freekickGoalRepresentation ? "OK" : "YOK"
            });
        }
        
        async function createGameRoom() {
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;
            try {
                gameRoomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                localPlayerNumber = 1;
                currentGameId = gameRoomCode;

                const initialGameData = {
                    player1: { id: "player1_host", name: "Oyuncu 1", score: 0, lastStopTimeMs: null, penaltyChoice: null },
                    currentPlayer: 1,
                    gameState: 'waiting_for_player2',
                    sharedStopwatchMs: 0,
                    liveTimeMs: 0, // Eklendi: Aktif oyuncunun canlƒ± zamanƒ±
                    gameSettings: {
                        maxTurns: 10, // Her oyuncu 5 hamle, toplam 10 hamle
                        maxScore: 3,  // 3 gole ula≈üan kazanƒ±r
                        turnTimeoutSeconds: 5,
                        stopTimeoutSeconds: 3
                    },
                    currentTurn: 0,
                    lastActionTimestamp: serverTimestamp(),
                    messageToPlayers: `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`,
                    isBotGame: false,
                };

                await set(ref(database, 'games/' + currentGameId), initialGameData);
                
                lobbyControls.classList.add('hidden');
                gameBoard.classList.remove('hidden');
                messageElem.classList.remove('hidden');
                messageElem.textContent = `Oda Kodu: ${gameRoomCode} - Oyuncu 2 bekleniyor...`;
                console.log(`Oda olu≈üturuldu: ${currentGameId}`);
                listenToGameUpdates(currentGameId);

            } catch (error) {
                console.error("Oda olu≈üturulamadƒ±:", error);
                messageElem.classList.remove('hidden');
                messageElem.textContent = "Hata: Oda olu≈üturulamadƒ±. Konsolu kontrol edin.";
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        async function joinGameRoom() {
            const inputRoomCode = roomCodeInput.value.toUpperCase().trim();
            if (!inputRoomCode) {
                alert("L√ºtfen bir oda kodu girin."); 
                return;
            }

            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;

            try {
                const gameRefPath = 'games/' + inputRoomCode;
                const gameRefInstance = ref(database, gameRefPath);
                const snapshot = await get(gameRefInstance);

                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    if (gameData.player2) {
                        alert("Bu oda dolu veya zaten bir oyun devam ediyor.");
                        console.log("Oda dolu:", inputRoomCode);
                        createRoomBtn.disabled = false;
                        joinRoomBtn.disabled = false;
                        roomCodeInput.disabled = false;
                        return;
                    }
                    if (gameData.gameState !== 'waiting_for_player2') {
                         alert("Bu odaya ≈üu an katƒ±lamazsƒ±nƒ±z (oyun ba≈ülamƒ±≈ü olabilir).");
                         createRoomBtn.disabled = false;
                         joinRoomBtn.disabled = false;
                         roomCodeInput.disabled = false;
                         return;
                    }

                    localPlayerNumber = 2;
                    currentGameId = inputRoomCode;
                    gameRoomCode = inputRoomCode;

                    const updates = {};
                    updates[`player2`] = { id: "player2_guest", name: "Oyuncu 2", score: 0, lastStopTimeMs: null, penaltyChoice: null };
                    updates[`gameState`] = 'player1_turn'; 
                    updates[`currentPlayer`] = 1; 
                    updates[`messageToPlayers`] = 'Oyuncular hazƒ±r! Sƒ±ra Oyuncu 1\'de.';
                    updates[`lastActionTimestamp`] = serverTimestamp();
                    
                    await update(gameRefInstance, updates);

                    console.log(`Odaya katƒ±nƒ±ldƒ±: ${currentGameId}`);
                    lobbyControls.classList.add('hidden');
                    gameBoard.classList.remove('hidden');
                    messageElem.classList.remove('hidden');
                    listenToGameUpdates(currentGameId);

            } else {
                    alert("Oda bulunamadƒ±. Kodu kontrol edin.");
                    console.log("Oda bulunamadƒ±:", inputRoomCode);
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                }
            } catch (error) {
                console.error("Odaya katƒ±lƒ±rken hata:", error);
                alert("Hata: Odaya katƒ±lamadƒ±. Konsolu kontrol edin.");
                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
                roomCodeInput.disabled = false;
            }
        }

        function listenToGameUpdates(gameId) {
            const gameRefPath = 'games/' + gameId;
            const gameRefInstance = ref(database, gameRefPath);

            onValue(gameRefInstance, async (snapshot) => { // Fonksiyonu async yaptƒ±k
                if (!snapshot.exists()) {
                    console.warn(`Dinlenen oda (${gameId}) artƒ±k mevcut deƒüil.`);
                    alert("Oda baƒülantƒ±sƒ± kesildi veya oda kapandƒ±.");
                    lobbyControls.classList.remove('hidden');
                    gameBoard.classList.add('hidden');
                    messageElem.classList.add('hidden');
                    currentGameId = null;
                    localPlayerNumber = null;
                    gameRoomCode = null;
                    createRoomBtn.disabled = false;
                    joinRoomBtn.disabled = false;
                    roomCodeInput.disabled = false;
                    roomCodeInput.value = '';
                    if (turnTimerId) clearTimeout(turnTimerId); // Aktif timer varsa temizle
                    if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId); // Aktif timer varsa temizle
                    return;
                }

                const gameData = snapshot.val();
                console.log("Oyun verisi g√ºncellendi:", gameData);
                if (!gameData) return;

                // --- Stop local timer if it's not this client's turn to actively time ---
                if (running &&
                    (localPlayerNumber !== gameData.currentPlayer || !gameData.gameState.endsWith(`_timing`)) &&
                    gameData.gameState !== `player${localPlayerNumber}_stopped`) {
                    clearInterval(interval);
                    running = false;
                    if (liveUpdateIntervalId) { // Canlƒ± g√ºncelleme interval'ini de temizle
                        clearInterval(liveUpdateIntervalId);
                        liveUpdateIntervalId = null;
                    }
                    toggleBtn.textContent = 'Ba≈ülat';
                    if (localPlayerNumber !== gameData.currentPlayer && gameData.gameState.endsWith('_turn')) {
                        toggleBtn.disabled = true; // Sƒ±ra bende deƒüilse buton pasif olmalƒ±
                    }
                }

                // --- Host specific logic block ---
                if (localPlayerNumber === 1) {
                    if (turnTimerId) {
                        clearTimeout(turnTimerId);
                        turnTimerId = null;
                    }

                    if (gameData.gameState && gameData.gameState.endsWith('_stopped') && gameData.lastActionDetail) {
                        const lastPlayer = gameData.lastActionDetail.player;
                        // Oyuncu zaten sonucu i≈üledi ve sƒ±rayƒ± devretti mi kontrol√º
                        // Bu, √∂zellikle _aiming durumuna ge√ßildikten sonra _stopped'un tekrar i≈ülenmesini engeller
                        const expectedNextPlayerForNormalTurn = lastPlayer === 1 ? 2 : 1;
                        const isAlreadyProcessedAndTurnedOver = gameData.currentPlayer === expectedNextPlayerForNormalTurn && gameData.gameState === `player${expectedNextPlayerForNormalTurn}_turn`;
                        const isSpecialAimingState = gameData.gameState && (gameData.gameState.startsWith('penalty_') || gameData.gameState.startsWith('freekick_')) && gameData.gameState.endsWith('_aiming');

                        // Sadece host, ve eƒüer bu _stopped olayƒ± hen√ºz _aiming gibi bir √∂zel duruma veya bir sonraki oyuncunun normal turuna d√∂n√º≈üt√ºr√ºlmemi≈üse i≈üle.
                        if (gameData.lastActionDetail.player === localPlayerNumber || // Eƒüer durduran bu host ise
                           (gameData.lastActionDetail.player !== localPlayerNumber && !isAlreadyProcessedAndTurnedOver && !isSpecialAimingState && gameData.gameState === `player${gameData.lastActionDetail.player}_stopped` ) // Ya da durduran diƒüer oyuncuysa ve hen√ºz sonu√ß i≈ülenmemi≈üse
                        ) {
                            // Bu _stopped olayƒ±nƒ± i≈üleyip i≈ülemediƒüimizi takip etmek i√ßin basit bir flag
                            // Bu, √∂zellikle host'un kendi _stopped olayƒ±nƒ± birden fazla kez tetiklemesini √∂nlemek i√ßin deƒüil,
                            // daha √ßok diƒüer oyuncu durdurduƒüunda host'un bunu sadece bir kez i≈ülemesini saƒülamak i√ßin.
                            // Ancak, en g√ºvenli yol `lastActionTimestamp` veya `currentTurn` gibi daha saƒülam bir belirte√ß kullanmaktƒ±r.
                            // ≈ûimdilik, `gameData.lastActionDetail.processedByHost` gibi bir alan ekleyebiliriz.
                            // VEYA: Host'un sadece kendi playerX_stopped mesajƒ±nƒ± deƒüil, diƒüer oyuncunun playerY_stopped mesajƒ±nƒ± da i≈ülemesi gerekir.
                            // Oyuncunun kendi _stopped mesajƒ±nƒ± i≈üleme mantƒ±ƒüƒ± zaten var.
                            // Eƒüer lastActionDetail.player mevcut host deƒüilse ve gameState hala playerX_stopped ise host bunu i≈ülemeli.

                            // Eƒüer bu client (host) zaten bu sonucu i≈ülemi≈üse (√∂rn: state'i _aiming'e √ßevirmi≈üse), tekrar i≈üleme.
                            // Bunun i√ßin en iyi kontrol, Firebase'deki gameState'in beklenen bir sonraki duruma (√∂rn: playerY_turn veya penalty_playerX_aiming)
                            // zaten ge√ßip ge√ßmediƒüidir.
                            if (!(gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_result') || (gameData.gameState.endsWith('_turn') && gameData.currentPlayer !== lastPlayer ))) {
                                const centiseconds = gameData.lastActionDetail.centiseconds;
                                const timeMs = gameData.lastActionDetail.timeMs;
                                let outcomeMessage = "";
                                let newGameState = "";
                                const nextPlayer = lastPlayer === 1 ? 2 : 1;
                                let scoreUpdates = {};
                                let penaltyDetailsUpdate = null;

                                // Skorlarƒ± belirle
                                if (centiseconds === 0) { // F3: GOL
                                    scoreUpdates[`player${lastPlayer}/score`] = (gameData[`player${lastPlayer}`]?.score || 0) + 1;
                                }
                                // Penaltƒ±/Frikik i√ßin skor g√ºncellemesi turnOverAfterSpecialAction i√ßinde yapƒ±lƒ±r.

                                // Potansiyel yeni skorlar ve tur sayƒ±sƒ±
                                const potentialP1Score = gameData.player1?.score + (scoreUpdates['player1/score'] ? 1 : 0) || gameData.player1?.score || 0;
                                const potentialP2Score = gameData.player2?.score + (scoreUpdates['player2/score'] ? 1 : 0) || gameData.player2?.score || 0;
                                const nextTurnNumber = (gameData.currentTurn || 0) + 1;

                                // Oyun biti≈üini kontrol et (g√ºncellenmi≈ü skorlar ve yeni tur sayƒ±sƒ± ile)
                                const isGameOver = await checkGameOverConditionOnHost(currentGameId, {
                                    player1Score: potentialP1Score,
                                    player2Score: potentialP2Score,
                                    currentTurnForCheck: nextTurnNumber,
                                    gameSettings: gameData.gameSettings
                                });

                                if (isGameOver) {
                                    console.log("Host: Oyun bittiƒüi i√ßin (_stopped sonrasƒ±) normal durum g√ºncellemesi yapƒ±lmadƒ±.");
                                    // checkGameOverConditionOnHost zaten Firebase'i g√ºncelledi ve skoru/turu da yazdƒ±.
                                    // Bu y√ºzden burada ek bir Firebase g√ºncellemesi yapmaya gerek yok.
                                } else {
                                    // Oyun bitmediyse, sonucu i≈üle ve Firebase'i g√ºncelle.
                                    if (centiseconds === 0) { // F3: GOL
                                        outcomeMessage = `GOOOOL! Oyuncu ${lastPlayer} attƒ±! (S√ºre: ${formatTime(timeMs)})`;
                                        newGameState = `player${nextPlayer}_turn`;
                                        if (goalSound) goalSound.play().catch(e => console.log("Gol sesi oynatƒ±lamadƒ±:", e));
                                    } else if (centiseconds >= 90 && centiseconds <= 99) { // F4: PENALTI
                                        outcomeMessage = `PENALTI! Oyuncu ${lastPlayer} kullanacak... (S√ºre: ${formatTime(timeMs)})`;
                                        newGameState = `penalty_player${lastPlayer}_aiming`;
                                        penaltyDetailsUpdate = { shooter: lastPlayer, type: 'penalty', status: 'aiming' };
                                        if (whistleSound) whistleSound.play().catch(e => console.log("D√ºd√ºk sesi oynatƒ±lamadƒ±:", e));
                                    } else if (centiseconds >= 80 && centiseconds <= 89) { // F5: FRƒ∞Kƒ∞K
                                        outcomeMessage = `FRƒ∞Kƒ∞K! Oyuncu ${lastPlayer} kullanacak... (S√ºre: ${formatTime(timeMs)})`;
                                        newGameState = `freekick_player${lastPlayer}_aiming`;
                                        penaltyDetailsUpdate = { shooter: lastPlayer, type: 'freekick', status: 'aiming' };
                                        if (whistleSound) whistleSound.play().catch(e => console.log("D√ºd√ºk sesi oynatƒ±lamadƒ±:", e));
                                        console.log("Frikik durumu olu≈ütu (host):", newGameState, penaltyDetailsUpdate);
                                    } else { // AUT
                                        outcomeMessage = `AUT! Sƒ±ra Oyuncu ${nextPlayer}\'de. (Durdurulan: ${formatTime(timeMs)})`;
                                        newGameState = `player${nextPlayer}_turn`;
                                    }
    
                                    const updates = {
                                        currentPlayer: newGameState.includes('_turn') ? nextPlayer : lastPlayer,
                                        gameState: newGameState,
                                        sharedStopwatchMs: timeMs,
                                        liveTimeMs: timeMs,
                                        messageToPlayers: outcomeMessage,
                                        lastActionTimestamp: serverTimestamp(),
                                        currentTurn: nextTurnNumber, // nextTurnNumber burada kullanƒ±lƒ±yor
                                        ...scoreUpdates, // scoreUpdates burada kullanƒ±lƒ±yor
                                        penaltyDetails: penaltyDetailsUpdate
                                    };
                                    if (penaltyDetailsUpdate === null && gameData.penaltyDetails) {
                                        updates.penaltyDetails = null;
                                    }
    
                                    update(ref(database, 'games/' + currentGameId), updates)
                                        .then(() => {
                                            console.log(`Host: Oyuncu ${lastPlayer} aksiyonu DEƒûERLENDƒ∞Rƒ∞LDƒ∞ (ANA BLOK). Yeni durum: ${newGameState}. Sonu√ß: ${outcomeMessage}`);
                                        })
                                        .catch(error => {
                                            console.error("Host: Oyun durumu g√ºncellenirken hata (ANA BLOK):", error);
                                        });
                                }
                            } else {
                                console.log(`Host: Oyuncu ${lastPlayer} aksiyonu zaten i≈ülenmi≈ü veya oyun ilerlemi≈ü. Mevcut durum: ${gameData.gameState}, Mevcut oyuncu: ${gameData.currentPlayer}`);
                            }
                        }
                    } else if (gameData.gameState && gameData.player1 && gameData.player2) { // Zaman a≈üƒ±mƒ± kurma mantƒ±ƒüƒ±
                        const currentTurnForTimeout = gameData.currentTurn;
                        let timeoutSettings = 5;
                        let playerWhoseTurnItIs = null;
                        let expectedStateForTimeout = gameData.gameState;

                        if (gameData.gameState.endsWith('_turn')) {
                            playerWhoseTurnItIs = parseInt(gameData.gameState.charAt(6));
                            timeoutSettings = gameData.gameSettings?.turnTimeoutSeconds || 5;
                        } else if (gameData.gameState.endsWith('_timing')) {
                            playerWhoseTurnItIs = parseInt(gameData.gameState.charAt(6));
                            timeoutSettings = gameData.gameSettings?.stopTimeoutSeconds || 3;
                        } else if (gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_waiting') || gameData.gameState.endsWith('_result')) {
                             playerWhoseTurnItIs = null; // √ñzel durumlarda (penaltƒ±/frikik adƒ±mlarƒ±) ana zaman a≈üƒ±mƒ± sayacƒ± kurulmaz.
                        }


                        if (playerWhoseTurnItIs !== null) {
                            const timeoutMs = timeoutSettings * 1000;
                            turnTimerId = setTimeout(() => {
                                handleTurnTimeout(playerWhoseTurnItIs, currentTurnForTimeout, expectedStateForTimeout);
                            }, timeoutMs);
                        }
                    }
                } // --- End of Host specific logic block ---

                // Update shared stopwatch display based on state (All Clients)
                if (gameData.gameState && gameData.gameState.endsWith('_timing') && localPlayerNumber !== gameData.currentPlayer) {
                    stopwatchElem.textContent = formatTime(gameData.liveTimeMs || gameData.sharedStopwatchMs || 0);
                } else if (gameData.gameState && (gameData.gameState.endsWith('_turn') || gameData.gameState === 'waiting_for_player2')) {
                    stopwatchElem.textContent = formatTime(gameData.sharedStopwatchMs || 0);
                } else if (gameData.gameState && gameData.gameState.endsWith('_stopped') && gameData.lastActionDetail) {
                     // Eƒüer _stopped durumu ise ve bu client o anki aktif oyuncu deƒüilse, lastActionDetail'den g√∂ster.
                     // Aktif oyuncu ise, kendi lokal sayacƒ±ndan g√∂sterir (bu blok g√ºncellenene kadar)
                    if (localPlayerNumber !== gameData.lastActionDetail.player) {
                        stopwatchElem.textContent = formatTime(gameData.lastActionDetail.timeMs || 0);
                    }
                }

                scoreP1Elem.textContent = gameData.player1?.score !== undefined ? gameData.player1.score : 0;
                scoreP2Elem.textContent = gameData.player2?.score !== undefined ? gameData.player2.score : 0;

                document.getElementById('player1-name').textContent = gameData.player1?.name || 'OYUNCU 1';
                document.getElementById('player2-name').textContent = gameData.player2?.name || (gameData.isBotGame ? 'BOT' : (gameData.gameState === 'waiting_for_player2' ? 'BEKLENƒ∞YOR' : 'OYUNCU 2'));

                if(messageElem.classList.contains('hidden')) messageElem.classList.remove('hidden');
                messageElem.textContent = gameData.messageToPlayers || '';

                const turnIndicatorClasses = ['player1-turn', 'player2-turn', 'blinking'];
                turnIndicatorElem.classList.remove(...turnIndicatorClasses);

                if (gameData.gameState === 'waiting_for_player2' && localPlayerNumber === 1) {
                    turnIndicatorElem.textContent = `Oda: ${gameRoomCode} - Rakip bekleniyor...`;
                } else if (gameData.gameState === 'game_over') {
                    turnIndicatorElem.textContent = "MA√á Bƒ∞TTƒ∞!";
                } else if (gameData.player1 && gameData.player2) {
                    turnIndicatorElem.textContent = `Sƒ±ra: Oyuncu ${gameData.currentPlayer}`;
                    const currentTurnPlayerClass = gameData.currentPlayer === 1 ? 'player1-turn' : 'player2-turn';
                    const otherPlayerClass = gameData.currentPlayer === 1 ? 'player2-turn' : 'player1-turn';
                    turnIndicatorElem.classList.add(currentTurnPlayerClass);
                    turnIndicatorElem.classList.remove(otherPlayerClass);
                    if (localPlayerNumber === gameData.currentPlayer) {
                        turnIndicatorElem.textContent += " (SEN)";
                    }
                } else {
                    turnIndicatorElem.textContent = "Oyuncular bekleniyor...";
                }

                if (gameData.gameState === 'waiting_for_player2' || !gameData.player2 ||
                    gameData.gameState.endsWith('_aiming') || gameData.gameState.endsWith('_waiting') || gameData.gameState.endsWith('_result') || // Penaltƒ±/Frikik adƒ±mlarƒ±nda ana ba≈ülatma butonu pasif
                    gameData.gameState === 'game_over') {
                    toggleBtn.disabled = true;
                } else {
                    toggleBtn.disabled = !(localPlayerNumber === gameData.currentPlayer &&
                        (gameData.gameState === `player${localPlayerNumber}_turn` ||
                            gameData.gameState === `player${localPlayerNumber}_timing`));
                }
                resetBtn.disabled = true;

                // √ñzel oyun durumlarƒ± (Penaltƒ±/Frikik) i√ßin UI y√∂netimi
                const handleSpecialGameState = () => {
                    // √ñnce t√ºm modallarƒ± kapat (her UI g√ºncellemesinde temiz bir ba≈ülangƒ±√ß i√ßin)
                    // Ancak bu, modal i√ßindeki se√ßimlerin kaybolmasƒ±na neden olabilir.
                    // Bunun yerine, sadece gameState deƒüi≈ütiƒüinde veya modalƒ±n kapanmasƒ± gerektiƒüinde kapatmak daha iyi olabilir.
                    // ≈ûimdilik mevcut haliyle bƒ±rakalƒ±m, ancak _result sonrasƒ± otomatik kapanma zaten var.
                    // togglePenaltyModal(false);
                    // toggleFreekickModal(false);

                    if (!gameData.gameState) return;
                    const gameState = gameData.gameState;
                     // console.log(\"√ñzel durum kontrol√º i√ßin gameState:\", gameState); // √áok sƒ±k log basar, dikkat!

                    const isPenaltyState = gameState.startsWith('penalty_player');
                    const isFreekickState = gameState.startsWith('freekick_player');

                    if (!isPenaltyState && !isFreekickState) {
                        // Eƒüer penaltƒ± veya frikik durumu deƒüilse, a√ßƒ±k olabilecek modallarƒ± kapat.
                        if (penaltyModal.classList.contains('active')) togglePenaltyModal(false);
                        if (freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        return;
                    }
                    
                    let actionType = isPenaltyState ? 'penalty' : 'freekick';
                    let shooter = gameData.penaltyDetails?.shooter;

                    if (!shooter && gameData.penaltyDetails) { // penaltyDetails var ama shooter yoksa (beklenmedik)
                        console.warn(`[${gameState}] Shooter penaltyDetails i√ßinde (${actionType}) bulunamadƒ± ancak penaltyDetails objesi var. gameState string'inden parse ediliyor.`);
                        try { shooter = parseInt(gameState.split('_')[1].charAt(6)); } catch (e) { /* ignore */ }
                    } else if (!gameData.penaltyDetails) { // penaltyDetails objesi hi√ß yoksa (√∂rn. host hen√ºz olu≈üturmadƒ±)
                         console.warn(`[${gameState}] penaltyDetails objesi hen√ºz yok (${actionType}). gameState string'inden shooter parse ediliyor.`);
                         try { shooter = parseInt(gameState.split('_')[1].charAt(6)); } catch (e) { /* ignore */ }
                         // Eƒüer host ise ve shooter bulunduysa ama penaltyDetails hala yoksa, olu≈ütur.
                         if (localPlayerNumber === 1 && shooter && !gameData.penaltyDetails) {
                            console.log(`[${gameState}] Host, eksik penaltyDetails i√ßin (${actionType}) d√ºzeltme deniyor. Shooter: ${shooter}`);
                            update(ref(database, 'games/' + currentGameId), {
                                penaltyDetails: { shooter: shooter, type: actionType, status: gameState.endsWith('_aiming') ? 'aiming' : (gameState.endsWith('_waiting') ? 'shooting': 'unknown') }
                            });
                            return; // Bir sonraki update'te i≈ülenecek
                         }
                    }


                    if (!shooter) {
                        console.error(`[${gameState}] ${actionType} i√ßin shooter kesin olarak bulunamadƒ±. Detaylar:`, gameData.penaltyDetails);
                        return;
                    }

                    // console.log(`[${gameState}] ${actionType} shooter i≈üleniyor: ${shooter}`);
                    const keeper = shooter === 1 ? 2 : 1;
                    let modalToToggle = isPenaltyState ? togglePenaltyModal : toggleFreekickModal;
                    let titleElem = isPenaltyState ? penaltyTitleTextElem : freekickTitleTextElem;
                    let descriptionElem = isPenaltyState ? penaltyDescriptionElem : freekickDescriptionElem;
                    let shooterControls = isPenaltyState ? penaltyShooterControls : freekickShooterControls;
                    let keeperControls = isPenaltyState ? penaltyKeeperControls : freekickKeeperControls;
                    let goalRep = isPenaltyState ? goalRepresentation : freekickGoalRepresentation;

                    if (gameState.endsWith('_aiming')) {
                        if (localPlayerNumber === shooter) {
                            titleElem.textContent = `SEN ${actionType.toUpperCase()} ${isPenaltyState ? 'ATIYORSUN' : 'KULLANIYORSUN'}!`;
                            descriptionElem.textContent = isPenaltyState ? 'Y√∂n se√ßip ≈ûUT √áEK butonuna bas.' : 'Y√∂n, g√º√ß se√ßip ≈ûUT √áEK butonuna bas.';
                            shooterControls.style.display = isPenaltyState ? 'flex' : 'block';
                            keeperControls.style.display = 'none';
                        } else if (localPlayerNumber === keeper) {
                            titleElem.textContent = `OYUNCU ${shooter} ${actionType.toUpperCase()} ${isPenaltyState ? 'ATIYOR' : 'KULLANIYOR'}...`;
                            descriptionElem.textContent = isPenaltyState ? 'Kurtarmak i√ßin bir y√∂n se√ß:' : 'Kurtarmak i√ßin y√∂n ve pozisyon se√ß:';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = isPenaltyState ? 'flex' : 'block';
                        }
                        // console.log(`[${gameState}] ${actionType} modalƒ± A√áILMAYA √ßalƒ±≈üƒ±lƒ±yor (_aiming)...`);
                        modalToToggle(true);
                        // Diƒüer modalƒ± kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);

                    } else if (gameState.endsWith('_waiting')) {
                        if (localPlayerNumber === shooter) {
                            titleElem.textContent = `≈ûUT √áEKTƒ∞N!`;
                            descriptionElem.textContent = 'Kaleci kurtarƒ±≈ü yapmayƒ± bekliyor...';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = 'none';
                        } else if (localPlayerNumber === keeper) {
                            titleElem.textContent = `OYUNCU ${shooter} ≈ûUT √áEKTƒ∞!`;
                            descriptionElem.textContent = isPenaltyState ? 'Kurtarmak i√ßin bir y√∂n se√ß:' : 'Kurtarmak i√ßin y√∂n ve pozisyon se√ß:';
                            shooterControls.style.display = 'none';
                            keeperControls.style.display = isPenaltyState ? 'flex' : 'block';
                        }
                         // console.log(`[${gameState}] ${actionType} modalƒ± A√áILMAYA √ßalƒ±≈üƒ±lƒ±yor (_waiting)...`);
                        modalToToggle(true);
                         // Diƒüer modalƒ± kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);

                    } else if (gameState.endsWith('_result')) {
                        const details = gameData.penaltyDetails;
                        if (!details) {
                            console.error(`[${gameState}] Sonu√ß durumu i√ßin penaltyDetails eksik!`);
                            return;
                        }
                        const shooterDirection = details.shooterDirection;
                        const keeperDirection = details.keeperDirection;
                        const isGoal = details.isGoal;

                        titleElem.textContent = isGoal ? 'GOOOL!' : 'KA√áTI!';
                        if (isPenaltyState) {
                            descriptionElem.textContent = `≈ûut: ${directionText(shooterDirection)}, Kaleci: ${directionText(keeperDirection)}`;
                        } else { // Frikik
                            descriptionElem.textContent = `≈ûut: ${directionText(shooterDirection)} (${powerText(details.shooterPower)}), Kaleci: ${directionText(keeperDirection)} (${positionText(details.keeperPosition)})`;
                        }

                        const goalSections = goalRep.querySelectorAll('.goal-section');
                        goalSections.forEach(section => {
                            section.classList.remove('selected', 'save-result', 'missed-result');
                            if (section.dataset.direction === shooterDirection) {
                                section.classList.add(isGoal ? 'save-result' : 'missed-result');
                            }
                        });

                        shooterControls.style.display = 'none';
                        keeperControls.style.display = 'none';
                        // console.log(`[${gameState}] ${actionType} modalƒ± A√áILMAYA √ßalƒ±≈üƒ±lƒ±yor (_result)...`);
                        modalToToggle(true);
                         // Diƒüer modalƒ± kapat
                        if (isPenaltyState && freekickModal.classList.contains('active')) toggleFreekickModal(false);
                        if (isFreekickState && penaltyModal.classList.contains('active')) togglePenaltyModal(false);


                        if (localPlayerNumber === 1) { // Sadece host sonucu i≈üleyip turu devreder
                            setTimeout(() => turnOverAfterSpecialAction(shooter, isGoal, actionType, details), 3000);
                        }
                    }
                };

                const turnOverAfterSpecialAction = async (shooter, isGoal, actionType, actionDetails) => { // Fonksiyonu async yaptƒ±k
                    if (!shooter || !currentGameId || localPlayerNumber !== 1 || !actionDetails) return;

                    // Bu fonksiyonun birden fazla kez √ßaƒürƒ±lmasƒ±nƒ± engellemek i√ßin kontrol
                    if (gameData.penaltyDetails === null) {
                        console.log(`[${actionType}_result] turnOverAfterSpecialAction zaten i≈ülenmi≈ü, penaltyDetails null.`);
                        return;
                    }

                    console.log(`${actionType} sonucu (host i≈üliyor): ${isGoal ? 'GOL' : 'KA√áTI'}, ≈ûut√∂r: ${shooter}`);

                    const nextPlayerIfGoal = shooter === 1 ? 2 : 1;
                    const nextPlayerIfMiss = shooter === 1 ? 2 : 1; 
                    const nextPlayer = isGoal ? nextPlayerIfGoal : nextPlayerIfMiss;

                    // Potansiyel skorlarƒ± hesapla
                    let potentialP1Score = gameData.player1?.score || 0;
                    let potentialP2Score = gameData.player2?.score || 0;
                    const shooterPlayerObjKey = (gameData.player1 && (gameData.player1.id === `player${shooter}_host` || gameData.player1.name.includes(`Oyuncu ${shooter}`) || (shooter === 1))) ? 'player1' : 'player2';
                    
                    if (isGoal) {
                        if (shooterPlayerObjKey === 'player1') {
                            potentialP1Score++;
                        } else {
                            potentialP2Score++;
                        }
                    }

                    // Oyun biti≈üini kontrol et
                    // currentTurn, _stopped durumunda zaten g√ºncellenmi≈üti, bu √∂zel aksiyon tur sayƒ±sƒ±nƒ± deƒüi≈ütirmez.
                    const isGameOverAfterSpecial = await checkGameOverConditionOnHost(currentGameId, {
                        player1Score: potentialP1Score,
                        player2Score: potentialP2Score,
                        currentTurnForCheck: gameData.currentTurn, // Mevcut tur sayƒ±sƒ±nƒ± kullan
                        gameSettings: gameData.gameSettings
                    });

                    if (isGameOverAfterSpecial) {
                        console.log(`Host: Oyun bittiƒüi i√ßin (${actionType} sonrasƒ±) normal tur devri yapƒ±lmadƒ±.`);
                        // checkGameOverConditionOnHost zaten Firebase'i g√ºncelledi ve skoru/turu da yazdƒ±.
                    } else {
                        const updates = {
                            gameState: `player${nextPlayer}_turn`,
                            currentPlayer: nextPlayer,
                            messageToPlayers: isGoal ?
                                `GOOOL! Oyuncu ${shooter} ${actionType === 'penalty' ? 'penaltƒ±yƒ±' : 'frikiƒüi'} gole √ßevirdi! Sƒ±ra Oyuncu ${nextPlayer}\'de.` :
                                `${actionType === 'penalty' ? 'Penaltƒ±' : 'Frikik'} KA√áTI! Oyuncu ${shooter} ka√ßƒ±rdƒ±. Sƒ±ra Oyuncu ${nextPlayer}\'de.`,
                            penaltyDetails: null, 
                            lastActionTimestamp: serverTimestamp(),
                        };
    
                        if (isGoal) {
                             if (shooterPlayerObjKey === 'player1') {
                                 updates[`player1/score`] = potentialP1Score;
                            } else if (shooterPlayerObjKey === 'player2') {
                                 updates[`player2/score`] = potentialP2Score;
                            }
                        }
    
                        update(ref(database, 'games/' + currentGameId), updates)
                            .then(() => console.log(`${actionType} sonrasƒ± oyun durumu g√ºncellendi. Sƒ±ra: ${nextPlayer}`))
                            .catch((error) => console.error(`${actionType} sonrasƒ± g√ºncelleme hatasƒ±:`, error));
                    }
                };

                handleSpecialGameState();

                if (gameData.messageToPlayers &&
                    gameData.messageToPlayers.toLowerCase().includes('aut!') &&
                    gameData.gameState !== gameData.previousGameStateForAutSound) { // TODO: previousGameStateForAutSound eklenmeli
                    if (autSound) autSound.play().catch(e => console.log("Aut sesi oynatƒ±lamadƒ±:", e));
                    flashScreen('miss');
                }

                if (gameData.messageToPlayers && gameData.messageToPlayers.toLowerCase().includes('gooool!') &&
                    !gameData.gameState.startsWith('penalty_') && !gameData.gameState.startsWith('freekick_') && // Sadece normal goller i√ßin
                    gameData.gameState !== gameData.previousGameStateForGoalSound // TODO: previousGameStateForGoalSound eklenmeli
                ) {
                    if (goalSound) goalSound.play().catch(e => console.log("Gol sesi oynatƒ±lamadƒ±:", e));
                    spectatorsArea.classList.add('cheering');
                    animateBallToGoal();
                    animateGoalText();
                    setTimeout(() => spectatorsArea.classList.remove('cheering'), 2500);
                }
            });
        }

        async function handleTurnTimeout(playerNumberWhoShouldHavePlayed, turnNumberWhenTimerSet, expectedGameStateWhenTimerSet) {
            if (localPlayerNumber !== 1 || !currentGameId) return; // Only host processes timeouts

            // console.log(`Host: handleTurnTimeout called for Player ${playerNumberWhoShouldHavePlayed} (timer set during turn ${turnNumberWhenTimerSet}, expected state ${expectedGameStateWhenTimerSet})`);

            const gameRef = ref(database, 'games/' + currentGameId);
            try {
                const snapshot = await get(gameRef);
                if (!snapshot.exists()) {
                    // console.log("Host: Game ended or does not exist, timeout cancelled.");
                    if (turnTimerId) { clearTimeout(turnTimerId); turnTimerId = null; }
                    return;
                }
                const freshGameData = snapshot.val();

                // Critical Check: Is it still the same player's turn, the same turn number, AND the expected game state?
                if (freshGameData.gameState === expectedGameStateWhenTimerSet &&
                    freshGameData.currentTurn === turnNumberWhenTimerSet &&
                    parseInt(freshGameData.gameState.charAt(6)) === playerNumberWhoShouldHavePlayed) { // Ensure it is still this player's specific turn/timing state

                    const nextPlayer = playerNumberWhoShouldHavePlayed === 1 ? 2 : 1;
                    let timeoutReason = "";
                    let timeoutDurationMs = 0;

                    if (expectedGameStateWhenTimerSet.endsWith('_turn')) {
                        timeoutReason = "ba≈ülatmadƒ±";
                        timeoutDurationMs = (freshGameData.gameSettings?.turnTimeoutSeconds || 5) * 1000;
                    } else if (expectedGameStateWhenTimerSet.endsWith('_timing')) {
                        timeoutReason = "durdurmadƒ±";
                        timeoutDurationMs = (freshGameData.gameSettings?.stopTimeoutSeconds || 3) * 1000;
                    }

                    const newSharedStopwatchMs = (freshGameData.sharedStopwatchMs || 0) + timeoutDurationMs; // Zaman a≈üƒ±mƒ± s√ºresini ekle

                    const updates = {
                        currentPlayer: nextPlayer,
                        gameState: `player${nextPlayer}_turn`,
                        messageToPlayers: `Oyuncu ${playerNumberWhoShouldHavePlayed} zamanƒ±nda ${timeoutReason}! Sƒ±ra Oyuncu ${nextPlayer}\'de. (S√ºreye ${formatTime(timeoutDurationMs)} eklendi)`,
                        sharedStopwatchMs: newSharedStopwatchMs,
                        liveTimeMs: newSharedStopwatchMs, // Zaman a≈üƒ±mƒ± sonrasƒ± liveTimeMs'i de g√ºncelle
                        currentTurn: freshGameData.currentTurn + 1, 
                        lastActionTimestamp: serverTimestamp()
                    };

                    await update(gameRef, updates);
            } else {
                    // console.log(`Host: Timeout for Player ${playerNumberWhoShouldHavePlayed} (turn ${turnNumberWhenTimerSet}) is stale or player made a move. DB state: ${freshGameData.gameState}, DB turn: ${freshGameData.currentTurn}. No action taken.`);
                }
            } catch (error) {
                console.error("Host: Error in handleTurnTimeout:", error);
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const centiseconds = Math.floor((ms % 1000) / 10);
            return `${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
        }
        
        function startStopwatch() {
            if (running || !localPlayerNumber || !currentGameId) return;
            
            const gameRefPath = 'games/' + currentGameId;
            const gameRefInstance = ref(database, gameRefPath);

            get(gameRefInstance).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer !== localPlayerNumber || gameData.gameState !== `player${localPlayerNumber}_turn`){
                        console.warn("Sƒ±ra sizde deƒüil veya oyun durumu (start) uygun deƒüil:", gameData.gameState);
                        return;
                    }

                    running = true;
                    toggleBtn.textContent = 'Durdur';
                    milliseconds = gameData.sharedStopwatchMs || 0;
                    stopwatchElem.textContent = formatTime(milliseconds);

                    update(gameRefInstance, { 
                        gameState: `player${localPlayerNumber}_timing`,
                        messageToPlayers: `Oyuncu ${localPlayerNumber} oynuyor...`,
                        lastActionTimestamp: serverTimestamp()
                    });

                    interval = setInterval(() => {
                        milliseconds += 10;
                        stopwatchElem.textContent = formatTime(milliseconds);
                    }, 10);

                    // Start interval for this client to update liveTimeMs in Firebase
                    if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId);
                    liveUpdateIntervalId = setInterval(() => {
                        if (running && currentGameId) { // Ensure still running and in a game
                            update(ref(database, 'games/' + currentGameId), { liveTimeMs: milliseconds });
                        }
                    }, 250); // Update Firebase every 250ms

                }
            });
        }
        
        function stopStopwatch() {
            if (!running || !localPlayerNumber || !currentGameId) return;

            running = false;
            clearInterval(interval);
            toggleBtn.textContent = 'Ba≈ülat';
            toggleBtn.disabled = true; 

            const stoppedMilliseconds = milliseconds;
            const centisecondsValue = Math.floor((stoppedMilliseconds % 1000) / 10);

            if (liveUpdateIntervalId) { // Stop live updates to Firebase
                clearInterval(liveUpdateIntervalId);
                liveUpdateIntervalId = null;
            }

            const gameRefPath = 'games/' + currentGameId;
            update(ref(database, gameRefPath), {
                 lastActionDetail: {
                    player: localPlayerNumber,
                    timeMs: stoppedMilliseconds, 
                    centiseconds: centisecondsValue
                },
                gameState: `player${localPlayerNumber}_stopped`,
                liveTimeMs: stoppedMilliseconds, // Son durdurulan zamanƒ± liveTimeMs'e de yaz
                messageToPlayers: `Oyuncu ${localPlayerNumber} durdurdu: ${formatTime(stoppedMilliseconds)}. Sonu√ß bekleniyor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                console.log("Durdurma bilgisi Firebase'e g√∂nderildi: " + formatTime(stoppedMilliseconds));
            }).catch(error => {
                console.error("Durdurma bilgisi g√∂nderilemedi:", error);
                toggleBtn.disabled = false; 
            });
        }
        
        function animateBallToGoal() {
            footballBallElem.classList.add('shooting');
            setTimeout(() => {
            footballBallElem.classList.remove('shooting');
            footballBallElem.style.transform = 'translateX(-50%)';
            footballBallElem.style.bottom = '20%';
            }, 1000); 
        }

        function animateGoalText() {
            goalCelebrationTextElem.classList.add('animate');
            setTimeout(() => {
            goalCelebrationTextElem.classList.remove('animate');
            }, 2000); 
        }
        
        function togglePenaltyModal(show) { 
            console.log(`togglePenaltyModal √ßaƒürƒ±ldƒ±: ${show}`);
            if (!penaltyModal) {
                console.error("PENALTI MODALI DOM ELEMENTƒ∞ BULUNAMADI!");
                return;
            }
            if (show) {
                penaltyModal.classList.add('active');
                console.log("Penaltƒ± modalƒ± AKTƒ∞FLE≈ûTƒ∞Rƒ∞LDƒ∞ (.active class eklendi)");
            } else {
                penaltyModal.classList.remove('active');
                // console.log("Penaltƒ± modalƒ± PASƒ∞FLE≈ûTƒ∞Rƒ∞LDƒ∞ (.active class kaldƒ±rƒ±ldƒ±)"); // Kapatma logu genellikle √ßok sƒ±k basƒ±lƒ±r, ≈üimdilik kapalƒ±
            }
        }
        
        function toggleFreekickModal(show) { 
            console.log("toggleFreekickModal √ßaƒürƒ±ldƒ±:", show);
            if (!freekickModal) {
                console.error("Frikik modalƒ± bulunamadƒ±!");
                return;
            }
            
            if (show) {
                freekickModal.classList.add('active');
                console.log("Frikik modalƒ± aktifle≈ütirildi");
            } else {
                freekickModal.classList.remove('active');
            }
        }
        
        function flashScreen(type) { 
            gameFlash.className = 'game-flash'; 
            void gameFlash.offsetWidth; 
            
            if (type === 'miss') { 
                gameFlash.classList.add('flash-miss');
            }
            
            setTimeout(() => {
                gameFlash.className = 'game-flash'; 
            }, 500);
        }
        
        createRoomBtn.addEventListener('click', createGameRoom);
        joinRoomBtn.addEventListener('click', joinGameRoom);

        toggleBtn.addEventListener('click', () => {
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if(gameData.currentPlayer === localPlayerNumber){
                        if(gameData.gameState === `player${localPlayerNumber}_turn`){
                            startStopwatch();
                        } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                            stopStopwatch();
                        } else {
                            console.log("Oyun durumu (toggleBtn) kronometre ba≈ülatmaya/durdurmaya uygun deƒüil:", gameData.gameState);
                        }
                    } else {
                        console.log("Sƒ±ra sizde deƒüil (toggleBtn).");
                    }
                }
            });
        });
        
        // Eski oddBtn/evenBtn kodlarƒ± kaldƒ±rƒ±ldƒ± - artƒ±k penaltƒ± i√ßin y√∂n se√ßimi kullanƒ±lƒ±yor
        
        document.addEventListener('keydown', (e) => {
            if (!currentGameId || !localPlayerNumber || lobbyControls.classList.contains('hidden') === false) return; 
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if(snapshot.exists()){
                    const gameData = snapshot.val();
                    if (gameData.currentPlayer === localPlayerNumber) {
                        if (e.code === 'Space' || e.code === 'Enter') { 
                e.preventDefault();
                             if(gameData.gameState === `player${localPlayerNumber}_turn`){
                startStopwatch();
                            } else if (gameData.gameState === `player${localPlayerNumber}_timing`){
                                stopStopwatch();
                            }
                        }
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', initializeAppUI);

        // Penaltƒ± y√∂n se√ßimi i√ßin olay dinleyicileri
        goalRepresentation.addEventListener('click', (e) => {
            const section = e.target.closest('.goal-section');
            if (!section) return;
            
            // T√ºm se√ßimleri temizle
            const allSections = goalRepresentation.querySelectorAll('.goal-section');
            allSections.forEach(s => s.classList.remove('selected'));
            
            // Se√ßilen y√∂n√º i≈üaretle
            section.classList.add('selected');
            selectedPenaltyDirection = section.dataset.direction;
        });
        
        // ≈ûut √ßekme butonu
        penaltyShootBtn.addEventListener('click', () => {
            if (!selectedPenaltyDirection || !currentGameId || !localPlayerNumber) return;
            
            // Firebase'e y√∂n bilgisini g√∂nder
            const gameRefPath = 'games/' + currentGameId;
            
            update(ref(database, gameRefPath), {
                [`penaltyDetails/shooterDirection`]: selectedPenaltyDirection,
                [`penaltyDetails/status`]: 'shooting',
                gameState: `penalty_player${localPlayerNumber}_waiting`, // Kalecinin kurtarƒ±≈ü se√ßimini bekliyor
                messageToPlayers: `Oyuncu ${localPlayerNumber} ≈üut √ßekti! Kaleci hazƒ±rlanƒ±yor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                penaltyDescriptionElem.textContent = 'Kaleci kurtarƒ±≈ü yapmayƒ± bekliyor...';
                penaltyShooterControls.style.display = 'none';
            });
        });
        
        // Kurtarƒ±≈ü butonu
        penaltySaveBtn.addEventListener('click', () => {
            if (!selectedPenaltyDirection || !currentGameId || !localPlayerNumber) return;
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if (!snapshot.exists()) return;
                
                const gameData = snapshot.val();
                const shooter = gameData.penaltyDetails?.shooter;
                const shooterDirection = gameData.penaltyDetails?.shooterDirection;
                
                if (!shooterDirection || gameData.gameState !== `penalty_player${shooter}_waiting`) {
                    console.log("≈ûut√∂r hen√ºz ≈üut √ßekmemi≈ü veya uygun oyun durumu deƒüil.");
                    return;
                }
                
                // Kurtarƒ±≈ü sonucunu belirle
                const isGoal = shooterDirection !== selectedPenaltyDirection; // Kaleci doƒüru tahmin edemezse gol
                
                update(ref(database, gameRefPath), {
                    [`penaltyDetails/keeperDirection`]: selectedPenaltyDirection,
                    [`penaltyDetails/isGoal`]: isGoal,
                    [`penaltyDetails/status`]: 'completed',
                    gameState: `penalty_player${shooter}_result`,
                    messageToPlayers: isGoal ? 
                        `GOOOL! Oyuncu ${shooter} penaltƒ±dan gol attƒ±! (${directionText(shooterDirection)})` : 
                        `Kaleci KURTARDI! Oyuncu ${localPlayerNumber} doƒüru y√∂n√º tahmin etti! (${directionText(shooterDirection)})`,
                    lastActionTimestamp: serverTimestamp()
                }).then(() => {
                    // UI g√ºncellemesi listenToGameUpdates √ºzerinden yapƒ±lacak
                    if (isGoal && goalSound) {
                        goalSound.play().catch(e => console.log("Gol sesi oynatƒ±lamadƒ±:", e));
                    } else if (!isGoal && whistleSound) {
                        whistleSound.play().catch(e => console.log("D√ºd√ºk sesi oynatƒ±lamadƒ±:", e));
                    }
                });
            });
        });
        
        // Y√∂n adƒ±nƒ± insan dostu formata √ßevirir
        function directionText(direction) {
            switch(direction) {
                case 'left': return 'SOL';
                case 'center': return 'ORTA';
                case 'right': return 'SAƒû';
                default: return direction;
            }
        }
        
        // G√º√ß seviyesini insan dostu formata √ßevirir
        function powerText(power) {
            switch(power) {
                case 'low': return 'D√ú≈û√úK';
                case 'medium': return 'ORTA';
                case 'high': return 'Y√úKSEK';
                default: return power;
            }
        }
        
        // Pozisyon seviyesini insan dostu formata √ßevirir
        function positionText(position) {
            switch(position) {
                case 'low': return 'AL√áAK';
                case 'medium': return 'ORTA';
                case 'high': return 'Y√úKSEK';
                default: return position;
            }
        }

        // Frikik y√∂n ve g√º√ß se√ßimi i√ßin olay dinleyicileri
        freekickGoalRepresentation.addEventListener('click', (e) => {
            const section = e.target.closest('.goal-section');
            if (!section) return;
            
            // T√ºm se√ßimleri temizle
            const allSections = freekickGoalRepresentation.querySelectorAll('.goal-section');
            allSections.forEach(s => s.classList.remove('selected'));
            
            // Se√ßilen y√∂n√º i≈üaretle
            section.classList.add('selected');
            selectedFreekickDirection = section.dataset.direction;
        });
        
        // Frikik g√º√ß se√ßimi
        freekickShooterControls.querySelectorAll('.power-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // T√ºm se√ßimleri temizle
                freekickShooterControls.querySelectorAll('.power-btn').forEach(b => b.classList.remove('selected'));
                // Se√ßilen g√ºc√º i≈üaretle
                btn.classList.add('selected');
                selectedFreekickPower = btn.dataset.power;
            });
        });
        
        // Kaleci pozisyon se√ßimi
        freekickKeeperControls.querySelectorAll('.power-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // T√ºm se√ßimleri temizle
                freekickKeeperControls.querySelectorAll('.power-btn').forEach(b => b.classList.remove('selected'));
                // Se√ßilen pozisyonu i≈üaretle
                btn.classList.add('selected');
                selectedKeeperPosition = btn.dataset.position;
            });
        });
        
        // Frikik ≈üut √ßekme butonu
        freekickShootBtn.addEventListener('click', () => {
            if (!selectedFreekickDirection || !selectedFreekickPower || !currentGameId || !localPlayerNumber) {
                alert("L√ºtfen hem y√∂n hem de g√º√ß se√ßin!");
                return;
            }
            
            // Firebase'e y√∂n ve g√º√ß bilgisini g√∂nder
            const gameRefPath = 'games/' + currentGameId;
            
            update(ref(database, gameRefPath), {
                [`penaltyDetails/shooterDirection`]: selectedFreekickDirection,
                [`penaltyDetails/shooterPower`]: selectedFreekickPower,
                [`penaltyDetails/status`]: 'shooting',
                [`penaltyDetails/type`]: 'freekick',
                gameState: `freekick_player${localPlayerNumber}_waiting`, // Kalecinin kurtarƒ±≈ü se√ßimini bekliyor
                messageToPlayers: `Oyuncu ${localPlayerNumber} ≈üut √ßekti! Kaleci hazƒ±rlanƒ±yor...`,
                lastActionTimestamp: serverTimestamp()
            }).then(() => {
                freekickDescriptionElem.textContent = 'Kaleci kurtarƒ±≈ü yapmayƒ± bekliyor...';
                freekickShooterControls.style.display = 'none';
            });
        });
        
        // Frikik kurtarƒ±≈ü butonu
        freekickSaveBtn.addEventListener('click', () => {
            if (!selectedFreekickDirection || !selectedKeeperPosition || !currentGameId || !localPlayerNumber) {
                alert("L√ºtfen hem y√∂n hem de pozisyon se√ßin!");
                return;
            }
            
            const gameRefPath = 'games/' + currentGameId;
            get(ref(database, gameRefPath)).then(snapshot => {
                if (!snapshot.exists()) return;
                
                const gameData = snapshot.val();
                const shooter = gameData.penaltyDetails?.shooter;
                const shooterDirection = gameData.penaltyDetails?.shooterDirection;
                const shooterPower = gameData.penaltyDetails?.shooterPower;
                
                if (!shooterDirection || !shooterPower || gameData.gameState !== `freekick_player${shooter}_waiting`) {
                    console.log("≈ûut√∂r hen√ºz ≈üut √ßekmemi≈ü veya uygun oyun durumu deƒüil.");
                    return;
                }
                
                // Frikik kurtarƒ±≈ü mantƒ±ƒüƒ±:
                // 1. Eƒüer kaleci y√∂n√º doƒüru tahmin ettiyse:
                //    - Eƒüer pozisyon ve g√º√ß uyumluysa kurtar (√∂r: y√ºksek ≈üuta y√ºksek pozisyon)
                //    - Deƒüilse gol
                // 2. Eƒüer kaleci y√∂n√º yanlƒ±≈ü tahmin ettiyse:
                //    - Otomatik gol
                
                let isGoal = true; // Varsayƒ±lan olarak gol
                
                if (shooterDirection === selectedFreekickDirection) {
                    // Doƒüru y√∂n, pozisyon kontrol√º
                    if ((shooterPower === 'low' && selectedKeeperPosition === 'low') ||
                        (shooterPower === 'medium' && selectedKeeperPosition === 'medium') ||
                        (shooterPower === 'high' && selectedKeeperPosition === 'high')) {
                        isGoal = false; // Pozisyon e≈üle≈ümesi, kurtarƒ±≈ü
                    }
                }
                
                update(ref(database, gameRefPath), {
                    [`penaltyDetails/keeperDirection`]: selectedFreekickDirection,
                    [`penaltyDetails/keeperPosition`]: selectedKeeperPosition,
                    [`penaltyDetails/isGoal`]: isGoal,
                    [`penaltyDetails/status`]: 'completed',
                    gameState: `freekick_player${shooter}_result`,
                    messageToPlayers: isGoal ? 
                        `GOOOL! Oyuncu ${shooter} frikiƒüi gole √ßevirdi! (${directionText(shooterDirection)}, ${powerText(shooterPower)})` : 
                        `Kaleci KURTARDI! Oyuncu ${localPlayerNumber} doƒüru y√∂n√º ve pozisyonu tahmin etti!`,
                    lastActionTimestamp: serverTimestamp()
                }).then(() => {
                    // UI g√ºncellemesi listenToGameUpdates √ºzerinden yapƒ±lacak
                    if (isGoal && goalSound) {
                        goalSound.play().catch(e => console.log("Gol sesi oynatƒ±lamadƒ±:", e));
                    } else if (!isGoal && whistleSound) {
                        whistleSound.play().catch(e => console.log("D√ºd√ºk sesi oynatƒ±lamadƒ±:", e));
                    }
                });
            });
        });

        // Kurallar Modalƒ± i√ßin Olay Dinleyicileri
        if (rulesBtn && rulesModal && closeRulesModalBtn) {
            rulesBtn.addEventListener('click', () => {
                rulesModal.classList.add('active');
            });

            closeRulesModalBtn.addEventListener('click', () => {
                rulesModal.classList.remove('active');
            });

            rulesModal.addEventListener('click', (event) => {
                if (event.target === rulesModal) { // Sadece modalƒ±n dƒ±≈üƒ±na tƒ±klanƒ±rsa kapat
                    rulesModal.classList.remove('active');
                }
            });
        } else {
            console.warn("Kurallar modalƒ± veya butonlarƒ± bulunamadƒ±, olay dinleyicileri eklenemedi.");
        }
    </script>
</body>
</html>