<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinamik Tematik Analiz Raporu - Gelişmiş Filtreleme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Assertion Tags */
        .assertion-tag { 
            font-size: 0.70rem; 
            padding: 4px 8px; 
            border-radius: 6px; 
            display: flex; 
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px; 
            width: 100%;
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            color: #4B5563;
        }
        
        .dot { height: 8px; width: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
        .dot-complaint { background-color: #EF4444; box-shadow: 0 0 0 2px #FEE2E2; }
        .dot-request { background-color: #3B82F6; box-shadow: 0 0 0 2px #DBEAFE; }
        .dot-satisfaction { background-color: #10B981; box-shadow: 0 0 0 2px #D1FAE5; }
        .dot-detection { background-color: #9CA3AF; box-shadow: 0 0 0 2px #F3F4F6; }

        .cat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            background: #E5E7EB;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 8px;
            white-space: nowrap;
        }

        .sentiment-badge {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        .sent-positive { background-color: #DCFCE7; color: #166534; border: 1px solid #BBF7D0; }
        .sent-negative { background-color: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
        .sent-neutral { background-color: #F3F4F6; color: #374151; border: 1px solid #E5E7EB; }
        .sent-constructive { background-color: #FEF3C7; color: #92400E; border: 1px solid #FDE68A; }

        .filter-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border-l-4 border-indigo-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Ders Kitabı Analiz Paneli</h1>
                <p class="text-sm text-gray-500 mt-1">Görünüm: Detaylı Filtreleme ve Metrikler</p>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-indigo-600" id="totalRows">0</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Görüntülenen Görüş</div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 sticky top-2 z-10">
            <!-- 5 Columns Grid for filters -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                
                <!-- Sentiment Filter -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Genel Duygu</label>
                    <select id="filterSentiment" class="filter-select w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                        <option value="all">Tüm Duygular</option>
                        <option value="Olumlu">Olumlu</option>
                        <option value="Olumsuz">Olumsuz</option>
                        <option value="Yapıcı Eleştiri">Yapıcı Eleştiri</option>
                        <option value="Nötr">Nötr</option>
                    </select>
                </div>

                <!-- Main Theme (Category) Filter -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Ana Temalar</label>
                    <select id="filterCategory" class="filter-select w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                        <option value="all">Tüm Temalar</option>
                    </select>
                </div>

                <!-- Sub Theme (Alt Kategori) Filter - NEW -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Alt Kategoriler</label>
                    <select id="filterTheme" class="filter-select w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                        <option value="all">Tüm Alt Kategoriler</option>
                    </select>
                </div>

                <!-- Direction Filter -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Yönelim</label>
                    <select id="filterDirection" class="filter-select w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                        <option value="all">Tümü</option>
                        <option value="Talep/İstek">Talep/İstek</option>
                        <option value="Şikayet/Sorun">Şikayet/Sorun</option>
                        <option value="Memnuniyet">Memnuniyet</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Arama</label>
                    <input type="text" id="filterSearch" placeholder="Ara..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                </div>
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-green-500">
                <div class="text-gray-500 text-[10px] font-bold uppercase">Olumlu</div>
                <div class="text-xl font-bold text-gray-800" id="statPositive">0</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-red-500">
                <div class="text-gray-500 text-[10px] font-bold uppercase">Olumsuz</div>
                <div class="text-xl font-bold text-gray-800" id="statNegative">0</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-yellow-500">
                <div class="text-gray-500 text-[10px] font-bold uppercase">Yapıcı Eleştiri</div>
                <div class="text-xl font-bold text-gray-800" id="statConstructive">0</div>
            </div>
             <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-gray-400">
                <div class="text-gray-500 text-[10px] font-bold uppercase">Nötr</div>
                <div class="text-xl font-bold text-gray-800" id="statNeutral">0</div>
            </div>
        </div>

        <!-- CHARTS GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Chart 1: ANA TEMALAR (Horizontal) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide">ANA TEMALAR</h3>
                <div class="h-80">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: ALT KATEGORİ DAĞILIMI (Horizontal) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide">ALT KATEGORİ DAĞILIMI</h3>
                <div class="h-80">
                    <canvas id="themeChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Sentiment Distribution (Pie) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Filtrelenmiş Veri Duygu Dağılımı</h3>
                    <span class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded">Dinamik</span>
                </div>
                <div class="h-64 flex justify-center">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="text-base font-bold text-gray-800">Filtrelenmiş Sonuçlar</h3>
                <button onclick="resetFilters()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium cursor-pointer">Filtreleri Temizle</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-16">ID</th>
                            <th scope="col" class="px-6 py-3 w-1/3">Orijinal Görüş</th>
                            <th scope="col" class="px-6 py-3 text-center w-24">Duygu</th>
                            <th scope="col" class="px-6 py-3">Analiz Detayı</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- JS populated -->
                    </tbody>
                </table>
                <div id="noDataMessage" class="hidden text-center py-8 text-gray-500 italic">
                    Bu kriterlere uygun kayıt bulunamadı.
                </div>
            </div>
        </div>

    </div>

    <script>
        // Enable DataLabels
        Chart.register(ChartDataLabels);

        // --- DATA ---
        const analyzedData = [
            {
                id: "274745",
                text: "Etkinlikler çocukların düzeyine uygun fakat çeşitlendirilmeli, okuma metinleri arttırılmalı.",
                topics: [
                    { category: "İçerik Kalitesi", theme: "Etkinlikler düzeye uygun", direction: "Memnuniyet" },
                    { category: "İçerik Zenginleştirme", theme: "Etkinlik çeşitliliği talebi", direction: "Talep/İstek" },
                    { category: "İçerik Zenginleştirme", theme: "Okuma metni artış talebi", direction: "Talep/İstek" }
                ]
            },
            {
                id: "275032",
                text: "Öğrenciler verilen kaynaklar arasında bağlantı kurmada zorlanmaktadırlar. Tablo istenilen düzeyde doldurulmadığı görülmüştür.",
                topics: [
                    { category: "Öğrenci Becerileri", theme: "Kaynak ilişkilendirme güçlüğü", direction: "Şikayet/Sorun" },
                    { category: "Etkinlik Uygulaması", theme: "Tablo doldurma başarısızlığı", direction: "Tespit" }
                ]
            },
            {
                id: "275031",
                text: "24. sayfadaki tablonun nasıl doldurulacağı anlaşılamadı, yönerge eksik.",
                topics: [
                    { category: "Etkinlik Yönergesi", theme: "Yönerge belirsizliği", direction: "Şikayet/Sorun" }
                ]
            },
            {
                id: "274740",
                text: "Görseller konuyu anlatmada yetersiz kalıyor ancak renkler canlı seçilmiş.",
                topics: [
                    { category: "Görsel Tasarım", theme: "Görsellerin öğreticiliği yetersiz", direction: "Şikayet/Sorun" },
                    { category: "Görsel Tasarım", theme: "Renk seçimi başarılı", direction: "Memnuniyet" }
                ]
            },
            {
                id: "274735",
                text: "Süre bu etkinlik için kesinlikle yetmiyor.",
                topics: [
                    { category: "Uygulama Süreci", theme: "Ders saati/Süre yetersizliği", direction: "Şikayet/Sorun" }
                ]
            },
            {
                id: "274730",
                text: "Öğrenciler çok eğlendi, gayet başarılı.",
                topics: [
                    { category: "Öğrenci Motivasyonu", theme: "Etkinliklerin ilgi çekiciliği", direction: "Memnuniyet" }
                ]
            },
            {
                id: "274747",
                text: "Etkinlikler güzel ama sayıları çok az.",
                topics: [
                    { category: "İçerik Kalitesi", theme: "Etkinlik kalitesi iyi", direction: "Memnuniyet" },
                    { category: "İçerik Niceliği", theme: "Etkinlik sayısı yetersiz", direction: "Şikayet/Sorun" },
                    { category: "İçerik Zenginleştirme", theme: "Etkinlik sayısı artırılmalı", direction: "Talep/İstek" }
                ]
            },
            {
                id: "274746",
                text: "Etkinlikler çocukların düzeyine uygun fakat arttırılmalı.",
                topics: [
                    { category: "İçerik Kalitesi", theme: "Düzeye uygunluk", direction: "Memnuniyet" },
                    { category: "İçerik Zenginleştirme", theme: "Etkinlik sayısı artırılmalı", direction: "Talep/İstek" }
                ]
            },
            {
                id: "275200",
                text: "Diyaloglar çok yapay duruyor, günlük hayattan uzak.",
                topics: [
                    { category: "İçerik Kalitesi", theme: "Diyalogların doğallığı sorunu", direction: "Şikayet/Sorun" }
                ]
            },
            {
                id: "275201",
                text: "Ses dosyaları açılmıyor, linkler kırık.",
                topics: [
                    { category: "Teknik Sorunlar", theme: "Ses dosyası erişim sorunu", direction: "Şikayet/Sorun" }
                ]
            }
        ];

        // --- PREP ---
        function calculateOverallSentiment(topics) {
            const directions = topics.map(t => t.direction);
            const hasComplaint = directions.includes('Şikayet/Sorun');
            const hasRequest = directions.includes('Talep/İstek');
            const hasSatisfaction = directions.includes('Memnuniyet');
            
            if (hasRequest) return 'Yapıcı Eleştiri';
            if (hasComplaint && hasSatisfaction) return 'Yapıcı Eleştiri'; 
            if (hasComplaint) return 'Olumsuz';
            if (hasSatisfaction) return 'Olumlu';
            return 'Nötr';
        }

        analyzedData.forEach(row => {
            row.overallSentiment = calculateOverallSentiment(row.topics);
        });

        // POPULATE FILTERS
        
        // 1. Ana Temalar
        const allCategories = [...new Set(analyzedData.flatMap(row => row.topics.map(t => t.category)))].sort();
        const categorySelect = document.getElementById('filterCategory');
        allCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
        });

        // 2. Alt Kategoriler (Themes)
        const allThemes = [...new Set(analyzedData.flatMap(row => row.topics.map(t => t.theme)))].sort();
        const themeSelect = document.getElementById('filterTheme');
        allThemes.forEach(thm => {
            const opt = document.createElement('option');
            opt.value = thm;
            opt.textContent = thm;
            themeSelect.appendChild(opt);
        });

        // --- CHARTS ---
        let chartCategory = null;
        let chartTheme = null;
        let chartSentiment = null;

        function getSentimentClass(sentiment) {
            switch(sentiment) {
                case 'Olumlu': return 'sent-positive';
                case 'Olumsuz': return 'sent-negative';
                case 'Yapıcı Eleştiri': return 'sent-constructive';
                default: return 'sent-neutral';
            }
        }

        function filterData() {
            const sentFilter = document.getElementById('filterSentiment').value;
            const catFilter = document.getElementById('filterCategory').value;
            const themeFilter = document.getElementById('filterTheme').value;
            const dirFilter = document.getElementById('filterDirection').value;
            const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

            return analyzedData.filter(row => {
                // 1. Row-level filters
                if (sentFilter !== 'all' && row.overallSentiment !== sentFilter) return false;
                if (searchFilter && !row.text.toLowerCase().includes(searchFilter) && !row.id.includes(searchFilter)) return false;

                // 2. Topic-level filters
                const matchingTopics = row.topics.filter(t => {
                    const catMatch = (catFilter === 'all' || t.category === catFilter);
                    const themeMatch = (themeFilter === 'all' || t.theme === themeFilter);
                    const dirMatch = (dirFilter === 'all' || t.direction === dirFilter);
                    return catMatch && themeMatch && dirMatch;
                });

                if (matchingTopics.length === 0) return false;
                return true;
            });
        }

        function updateDashboard() {
            const filteredData = filterData();
            
            // Stats
            let stats = { 'Olumlu': 0, 'Olumsuz': 0, 'Yapıcı Eleştiri': 0, 'Nötr': 0 };
            filteredData.forEach(r => stats[r.overallSentiment]++);
            
            document.getElementById('totalRows').innerText = filteredData.length;
            document.getElementById('statPositive').innerText = stats['Olumlu'];
            document.getElementById('statNegative').innerText = stats['Olumsuz'];
            document.getElementById('statConstructive').innerText = stats['Yapıcı Eleştiri'];
            document.getElementById('statNeutral').innerText = stats['Nötr'];

            updateTable(filteredData);
            updateCharts(filteredData);
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const catFilter = document.getElementById('filterCategory').value;
            const themeFilter = document.getElementById('filterTheme').value;
            const dirFilter = document.getElementById('filterDirection').value;

            if (data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            } else {
                document.getElementById('noDataMessage').classList.add('hidden');
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                
                let topicsHtml = '<div class="flex flex-col gap-1">';
                row.topics.forEach(t => {
                    // Relevance check for badges
                    const isRelevant = (catFilter === 'all' || t.category === catFilter) && 
                                       (themeFilter === 'all' || t.theme === themeFilter) &&
                                       (dirFilter === 'all' || t.direction === dirFilter);
                    
                    const isAnyFilterActive = (catFilter !== 'all' || themeFilter !== 'all' || dirFilter !== 'all');
                    const opacityClass = !isAnyFilterActive ? '' : (isRelevant ? '' : 'opacity-25 grayscale');
                    
                    let dotClass = '';
                    if(t.direction === 'Şikayet/Sorun') dotClass = 'dot-complaint';
                    else if(t.direction === 'Talep/İstek') dotClass = 'dot-request';
                    else if(t.direction === 'Memnuniyet') dotClass = 'dot-satisfaction';
                    else dotClass = 'dot-detection';
                    
                    topicsHtml += `
                        <span class="assertion-tag ${opacityClass}">
                            <div class="flex items-center">
                                <span class="dot ${dotClass}"></span>
                                <span class="font-semibold text-gray-700 mr-1 text-[10px]">${t.direction}:</span> 
                                <span class="truncate max-w-[200px]" title="${t.theme}">${t.theme}</span>
                            </div>
                            <span class="cat-label">${t.category}</span>
                        </span>`;
                });
                topicsHtml += '</div>';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs text-gray-400 align-top">${row.id}</td>
                    <td class="px-6 py-4 text-gray-800 align-top leading-relaxed text-xs">${row.text}</td>
                    <td class="px-6 py-4 text-center align-top">
                        <span class="sentiment-badge ${getSentimentClass(row.overallSentiment)}">
                            ${row.overallSentiment}
                        </span>
                    </td>
                    <td class="px-6 py-4 align-top">
                        ${topicsHtml}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCharts(data) {
            let categoryStats = {};
            let themeCounts = {};
            let sentimentCounts = { 'Olumlu': 0, 'Olumsuz': 0, 'Yapıcı Eleştiri': 0, 'Nötr': 0 };
            
            const catFilter = document.getElementById('filterCategory').value;
            const themeFilter = document.getElementById('filterTheme').value;
            const dirFilter = document.getElementById('filterDirection').value;

            let totalTopicsFiltered = 0;

            data.forEach(row => {
                sentimentCounts[row.overallSentiment]++;

                row.topics.forEach(t => {
                    const isRelevant = (catFilter === 'all' || t.category === catFilter) && 
                                       (themeFilter === 'all' || t.theme === themeFilter) &&
                                       (dirFilter === 'all' || t.direction === dirFilter);
                    
                    if (isRelevant) {
                        totalTopicsFiltered++;
                        // Category Stats
                        if (!categoryStats[t.category]) {
                            categoryStats[t.category] = { 'Talep/İstek': 0, 'Şikayet/Sorun': 0, 'Memnuniyet': 0, 'Tespit': 0 };
                        }
                        if (categoryStats[t.category][t.direction] !== undefined) {
                            categoryStats[t.category][t.direction]++;
                        } else {
                            categoryStats[t.category]['Tespit']++;
                        }
                        // Theme Stats
                        if (!themeCounts[t.theme]) themeCounts[t.theme] = { count: 0, direction: t.direction };
                        themeCounts[t.theme].count++;
                    }
                });
            });

            // 1. ANA TEMALAR (Horizontal Bar)
            const categories = Object.keys(categoryStats).sort();
            const dsRequest = categories.map(c => categoryStats[c]['Talep/İstek']);
            const dsComplaint = categories.map(c => categoryStats[c]['Şikayet/Sorun']);
            const dsSatisfaction = categories.map(c => categoryStats[c]['Memnuniyet']);

            if (chartCategory) chartCategory.destroy();
            chartCategory = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [
                        { label: 'Talep/İstek', data: dsRequest, backgroundColor: '#3B82F6', stack: 'Stack 0' },
                        { label: 'Şikayet/Sorun', data: dsComplaint, backgroundColor: '#EF4444', stack: 'Stack 0' },
                        { label: 'Memnuniyet', data: dsSatisfaction, backgroundColor: '#10B981', stack: 'Stack 0' }
                    ]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { stacked: true, beginAtZero: true, grace: '10%' }, 
                        y: { stacked: true } 
                    },
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } },
                        datalabels: {
                            color: 'white', 
                            font: { size: 10, weight: 'bold' },
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                // We need total for this category to calculate percentage
                                let idx = ctx.dataIndex;
                                let sum = 0;
                                ctx.chart.data.datasets.forEach(ds => { sum += ds.data[idx]; });
                                let percentage = (value * 100 / sum).toFixed(0) + "%";
                                return `${percentage} (${value})`; // <--- NEW FORMAT: %6 (1)
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.dataset.label}: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });

            // 2. ALT KATEGORİ DAĞILIMI (Horizontal Bar)
            const sortedThemes = Object.entries(themeCounts).sort((a, b) => b[1].count - a[1].count).slice(0, 10);
            const getColor = (dir) => {
                if(dir === 'Şikayet/Sorun') return '#EF4444';
                if(dir === 'Talep/İstek') return '#3B82F6';
                if(dir === 'Memnuniyet') return '#10B981';
                return '#9CA3AF';
            };

            if (chartTheme) chartTheme.destroy();
            chartTheme = new Chart(document.getElementById('themeChart'), {
                type: 'bar',
                data: {
                    labels: sortedThemes.map(t => t[0]),
                    datasets: [{
                        label: 'Frekans',
                        data: sortedThemes.map(t => t[1].count),
                        backgroundColor: sortedThemes.map(t => getColor(t[1].direction)),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 40 } },
                    scales: { x: { beginAtZero: true, grace: '10%' } },
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#4B5563',
                            font: { size: 10, weight: 'bold' },
                            formatter: (value, ctx) => {
                                const percentage = totalTopicsFiltered > 0 
                                    ? (value * 100 / totalTopicsFiltered).toFixed(0) + "%"
                                    : "0%";
                                return `${percentage} (${value})`;
                            }
                        }
                    }
                }
            });

            // 3. SENTIMENT (Pie)
            const sentimentLabels = Object.keys(sentimentCounts);
            const sentimentValues = Object.values(sentimentCounts);
            const colorMap = {
                'Olumlu': '#10B981',
                'Olumsuz': '#EF4444',
                'Yapıcı Eleştiri': '#F59E0B',
                'Nötr': '#9CA3AF'
            };
            const bgColors = sentimentLabels.map(l => colorMap[l]);

            if (chartSentiment) chartSentiment.destroy();
            chartSentiment = new Chart(document.getElementById('sentimentChart'), {
                type: 'pie',
                data: {
                    labels: sentimentLabels,
                    datasets: [{
                        data: sentimentValues,
                        backgroundColor: bgColors,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 10 } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            }
                        }
                    }
                }
            });
        }

        function resetFilters() {
            document.getElementById('filterSentiment').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterTheme').value = 'all';
            document.getElementById('filterDirection').value = 'all';
            document.getElementById('filterSearch').value = '';
            updateDashboard();
        }

        // --- EVENTS ---
        document.getElementById('filterSentiment').addEventListener('change', updateDashboard);
        document.getElementById('filterCategory').addEventListener('change', updateDashboard);
        document.getElementById('filterTheme').addEventListener('change', updateDashboard);
        document.getElementById('filterDirection').addEventListener('change', updateDashboard);
        document.getElementById('filterSearch').addEventListener('input', updateDashboard);

        // --- INIT ---
        updateDashboard();

    </script>
</body>
</html>